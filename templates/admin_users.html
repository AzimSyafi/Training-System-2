{% extends "base.html" %}

{% block styles %}
<style>
  /* Hide button text on mobile, show only icon */
  @media (max-width: 768px) {
    .btn-add-account .btn-text {
      display: none;
    }
    .btn-add-account {
      padding: 0.375rem 0.75rem;
    }
    
    /* Fix modal and dropdown positioning on mobile */
    #createUserModal .modal-dialog {
      margin: 1rem;
      max-height: calc(100vh - 2rem);
      display: flex;
      align-items: center;
    }
    
    #createUserModal .modal-content {
      max-height: calc(100vh - 2rem);
      display: flex;
      flex-direction: column;
    }
    
    #createUserModal .modal-body {
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }
    
    /* Ensure dropdowns appear correctly on mobile */
    #createUserModal .form-select {
      -webkit-appearance: menulist;
      appearance: menulist;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0 d-flex align-items-center gap-3">
            <span><i class="fas fa-users"></i> User Management</span>
            <small class="text-muted">{{ (merged_accounts|length if merged_accounts else 0) }} result{{ '' if (merged_accounts|length if merged_accounts else 0) == 1 else 's' }}</small>
        </h2>
        <button type="button" class="btn btn-primary btn-sm btn-add-account" data-bs-toggle="modal" data-bs-target="#createUserModal" title="Add New Account">
            <i class="fas fa-user-plus"></i><span class="btn-text"> Add New Account</span>
        </button>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

        <!-- Filters & Search -->
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <form class="row g-2 align-items-end" method="get" action="{{ url_for('main.admin_users') }}">
                    <div class="col-12 col-md-4">
                        <label for="q" class="form-label mb-1">Search</label>
                        <input id="q" name="q" type="text" class="form-control" placeholder="Name, email" value="{{ (filters.q if filters else request.args.get('q','')) }}" />
                    </div>
                    <div class="col-6 col-md-2">
                        <label for="roleFilter" class="form-label mb-1">Role</label>
                        {% set role_val = (filters.role if filters else (request.args.get('role') or 'all'))|lower %}
                        <select id="roleFilter" name="role" class="form-select">
                            <option value="all" {% if role_val=='all' %}selected{% endif %}>All</option>
                            <option value="user" {% if role_val=='user' %}selected{% endif %}>Users</option>
                            <option value="authority" {% if role_val=='authority' %}selected{% endif %}>Authority</option>
                            <option value="trainer" {% if role_val=='trainer' %}selected{% endif %}>Trainers</option>
                            <option value="admin" {% if role_val=='admin' %}selected{% endif %}>Admins</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <label for="status" class="form-label mb-1">Trainer status</label>
                        {% set status_val = (filters.status if filters else (request.args.get('status') or 'all'))|lower %}
                        <select id="status" name="status" class="form-select">
                            <option value="all" {% if status_val=='all' %}selected{% endif %}>All</option>
                            <option value="active" {% if status_val=='active' %}selected{% endif %}>Active</option>
                            <option value="inactive" {% if status_val=='inactive' %}selected{% endif %}>Inactive</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <label for="agency_id" class="form-label mb-1">Agency</label>
                        {% set selected_ag = filters.agency_id if filters else request.args.get('agency_id') %}
                        <select id="agency_id" name="agency_id" class="form-select">
                            <option value="" {% if not selected_ag %}selected{% endif %}>All agencies</option>
                            {% for ag in (agencies or []) %}
                                <option value="{{ ag.agency_id }}" {% if selected_ag and (selected_ag|int == ag.agency_id) %}selected{% endif %}>{{ ag.agency_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 d-flex gap-2 mt-1">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> Apply</button>
                        <a href="{{ url_for('main.admin_users') }}" class="btn btn-outline-secondary">Reset</a>
                    </div>
                </form>
            </div>
        </div>

        {% if merged_accounts %}
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped mb-0 align-middle" id="mergedAccountsTable" data-paginate="true" data-items-per-page="50" data-responsive-table="true">
                        <thead class="table-light">
                            <tr>
                                <th data-label="Type" data-secondary="true">Type</th>
                                <th data-label="ID">ID</th>
                                <th class="name-column" data-label="Name" data-primary="true">Name</th>
                                <th class="email-column" data-label="Email">Email</th>
                                <th data-label="Agency">Agency</th>
                                <th data-label="Status">Status</th>
                                <th class="text-center" style="width:60px;" data-label="Actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for acc in merged_accounts %}
                            <tr id="{{ acc.type }}-row-{{ acc.id }}">
                                <td>{{ acc.type|capitalize }}</td>
                                <td>
                                    {% if acc.type == 'user' %}
                                        {% if acc.number_series and acc.number_series|length == 10 and acc.number_series[:2] == 'SG' %}
                                            U-{{ acc.number_series[2:] }}
                                        {% else %}
                                            U-{{ acc.id }}
                                        {% endif %}
                                    {% elif acc.type == 'authority' %}
                                        {% if acc.number_series and acc.number_series|length == 10 and acc.number_series[:2] == 'SG' %}
                                            AUTH-{{ acc.number_series[2:] }}
                                        {% else %}
                                            AUTH-{{ '%05d'|format(acc.id) }}
                                        {% endif %}
                                    {% elif acc.type == 'trainer' %}
                                        {% if acc.number_series and acc.number_series|length == 10 and acc.number_series.startswith('TR') %}
                                            T-{{ acc.number_series[2:] }}
                                        {% else %}
                                            T-{{ acc.id }}
                                        {% endif %}
                                    {% elif acc.type == 'admin' %}
                                        A-{{ acc.id }}
                                    {% endif %}
                                </td>
                                <td class="name-column">{{ acc.name }}</td>
                                <td class="email-column">{{ acc.email }}</td>
                                <td>{% if acc.type == 'user' or acc.type == 'authority' %}{{ acc.agency }}{% else %}&mdash;{% endif %}</td>
                                <td>
                                    {% if acc.type == 'trainer' %}
                                        <span class="badge {% if acc.active_status %}bg-success{% else %}bg-secondary{% endif %}" id="trainer-status-{{ acc.id }}">{% if acc.active_status %}Active{% else %}Inactive{% endif %}</span>
                                    {% else %}
                                        <span class="badge bg-success">Active</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Actions">
                                            <i class="fas fa-ellipsis-h"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="#" onclick="openChangeRoleModal('{{ acc.id }}', '{{ acc.type }}'); return false;"><i class="fas fa-user-cog me-2 text-primary"></i>Change Role</a></li>
                                            {% if acc.type == 'trainer' %}
                                            <li><a class="dropdown-item" href="#" onclick="openAssignCourseModal('{{ acc.id }}', '{{ acc.name }}'); return false;"><i class="fas fa-book me-2 text-success"></i>Assign Course</a></li>
                                            {% endif %}
                                            {% if acc.type in ['user', 'trainer'] %}
                                            <li><a class="dropdown-item" href="#" onclick="openChangePasswordModal('{{ acc.id }}', '{{ acc.name }}', '{{ acc.type }}'); return false;"><i class="fas fa-key me-2 text-warning"></i>Change Password</a></li>
                                            {% endif %}
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteUserOrTrainer('{{ acc.id }}', '{{ acc.name }}', '{{ acc.type }}'); return false;"><i class="fas fa-trash-alt me-2"></i>Delete</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> No Accounts Found</h5>
            <p>No users or trainers have been registered yet.</p>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
                <i class="fas fa-user-plus"></i> Create First Account
            </button>
        </div>
        {% endif %}
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createUserModalLabel"><i class="fas fa-user-plus"></i> Create New Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ safe_url_for('main.create_user') }}">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="full_name" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="full_name" name="full_name" required>
                <div class="form-text">For Admin this generates the username; for Trainer it's the display name.</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" name="email" required>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" name="password" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="role" class="form-label">Role</label>
                <select class="form-select" id="role" name="role" required onchange="toggleAgencyField()">
                  <option value="">Select Role</option>
                  <option value="user">User</option>
                  <option value="admin">Admin</option>
                  <option value="trainer">Trainer</option>
                  <option value="authority">Authority</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row" id="agencyFieldRow" style="display: none;">
            <div class="col-md-12">
              <div class="mb-3">
                <label for="agency_id" class="form-label">Agency <span class="text-danger">*</span></label>
                <select class="form-select" id="agency_id" name="agency_id">
                  <option value="">Select Agency</option>
                  {% for ag in agencies %}
                    <option value="{{ ag.agency_id }}">{{ ag.agency_name }}</option>
                  {% endfor %}
                </select>
                <div class="form-text">Required when creating a User account.</div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Create Account</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Change Role Modal -->
<div class="modal fade" id="changeRoleModal" tabindex="-1" aria-labelledby="changeRoleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changeRoleModalLabel">Change Role</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="changeRoleForm">
        <div class="modal-body">
          <input type="hidden" id="changeRoleUserId" name="user_id">
          <input type="hidden" id="changeRoleOrigType" name="orig_type">
          <div class="mb-3">
            <label for="newRole" class="form-label">Select New Role</label>
            <select class="form-select" id="newRole" name="new_role" required>
              <option value="user">User</option>
              <option value="admin">Admin</option>
              <option value="trainer">Trainer</option>
              <option value="authority">Authority</option>
            </select>
            <small class="form-text text-muted">Change the role for this user account.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Change Role</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Assign Course Modal -->
<div class="modal fade" id="assignCourseModal" tabindex="-1" aria-labelledby="assignCourseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="assignCourseModalLabel">Assign Course to Trainer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="assignCourseForm">
        <div class="modal-body">
          <input type="hidden" id="assignCourseTrainerId" name="trainer_id">
          <div class="mb-3">
            <label class="form-label">Trainer: <strong id="trainerNameDisplay"></strong></label>
          </div>
          <div class="mb-3">
            <label for="courseCode" class="form-label">Select Course</label>
            <select class="form-select" id="courseCode" name="course_code">
              <option value="">No Specific Course (All Courses)</option>
              {% for course in courses %}
              <option value="{{ course.code }}">{{ course.name }} ({{ course.code }})</option>
              {% endfor %}
            </select>
            <small class="form-text text-muted">Select a specific course to limit trainer access, or leave blank to allow access to all courses.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success"><i class="fas fa-book"></i> Assign Course</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="changePasswordForm">
        <div class="modal-body">
          <input type="hidden" id="changePasswordUserId" name="user_id">
          <input type="hidden" id="changePasswordUserType" name="user_type">
          <div class="mb-3">
            <label class="form-label">Account: <strong id="changePasswordUserName"></strong></label>
          </div>
          <div class="mb-3">
            <label for="newPassword" class="form-label">New Password</label>
            <input type="password" class="form-control" id="newPassword" name="new_password" required minlength="6">
            <small class="form-text text-muted">Enter a new password (minimum 6 characters).</small>
          </div>
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">Confirm Password</label>
            <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
            <small class="form-text text-muted">Re-enter the password to confirm.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning"><i class="fas fa-key"></i> Change Password</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- User Progress Modal -->
<div class="modal fade" id="userProgressModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userProgressContent">
                <!-- Progress content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<div id="tempAlertContainer" style="position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:2000;width:fit-content;max-width:90vw;"></div>

{% endblock %}

{% block scripts %}
<script>
// Define all functions globally so they're accessible from onclick attributes
function showTempAlert(message, type = 'success', duration = 1500) {
    const container = document.getElementById('tempAlertContainer');
    if (!container) return;
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.role = 'alert';
    alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
    container.appendChild(alert);
    setTimeout(() => {
        if (alert.parentNode) alert.parentNode.removeChild(alert);
    }, duration);
}

function viewUserProgress(userId) {
    fetch(`/api/user_progress/${userId}`)
        .then(response => response.json())
        .then(data => {
            let content = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Module</th><th>Status</th><th>Score</th><th>Completion Date</th></tr></thead><tbody>';

            data.forEach(module => {
                let statusBadge = module.is_completed ?
                    '<span class="badge bg-success">Completed</span>' :
                    '<span class="badge bg-warning">In Progress</span>';

                let scoreClass = (module.score === null || module.score === undefined) ? 'text-muted' : (module.score <= 50 ? 'text-danger' : (module.score > 75 ? 'text-success' : 'text-primary'));

                content += `<tr>
                    <td>${module.module_name}</td>
                    <td>${statusBadge}</td>
                    <td><span class="${scoreClass}">${module.score !== null && module.score !== undefined ? module.score + '%' : 'N/A'}</span></td>
                    <td>${module.completion_date && module.completion_date.toString().trim() ? new Date(module.completion_date).toLocaleDateString() : 'N/A'}</td>
                </tr>`;
            });

            content += '</tbody></table></div>';
            const container = document.getElementById('userProgressContent');
            if (container) container.innerHTML = content;

            new bootstrap.Modal(document.getElementById('userProgressModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            const container = document.getElementById('userProgressContent');
            if (container) container.innerHTML = '<div class="alert alert-danger">Error loading user progress.</div>';
        });
}

async function resetUserProgress(userId, userName) {
    console.log('Reset progress function called:', { userId, userName });

    try {
        const confirmed = await customConfirm(`Reset all progress for "${userName}"? This will delete all module progress, course progress, and certificates. This action cannot be undone.`, 'Confirm Reset', {type: 'danger', confirmText: 'Reset Progress', confirmClass: 'btn-danger'});
        console.log('User confirmed reset:', confirmed);

        if (!confirmed) return;

        const response = await fetch('/reset_user_progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `user_id=${encodeURIComponent(userId)}`
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Response data:', data);

        showTempAlert(data.message || 'Progress reset successfully.', data.success ? 'success' : 'danger', 2000);

        if (data.success) {
            const ratingCell = document.getElementById(`user-rating-${userId}`);
            if (ratingCell) {
                ratingCell.innerHTML = '<i class="far fa-star text-muted"></i>'.repeat(5);
            }
            // Optionally reload to show updated data
            setTimeout(() => location.reload(), 2000);
        }
    } catch (error) {
        console.error('Reset progress error:', error);
        showTempAlert(`Error: ${error.message || 'Failed to reset progress. Please check console for details.'}`, 'danger', 3000);
    }
}

function openChangeRoleModal(userId, userType) {
    console.log('openChangeRoleModal called with:', { userId, userType });

    // Hide any open modals before showing this modal
    document.querySelectorAll('.modal.show').forEach(modal => {
        const bsModal = bootstrap.Modal.getInstance(modal);
        if(bsModal) bsModal.hide();
    });

    const input = document.getElementById('changeRoleUserId');
    const select = document.getElementById('newRole');
    const orig = document.getElementById('changeRoleOrigType');

    if (!input || !select || !orig) {
        console.error('Modal elements not found', { input: !!input, select: !!select, orig: !!orig });
        return;
    }

    // Set the values
    input.value = userId;
    orig.value = userType;

    console.log('After setting values:', {
        userId: input.value,
        origType: orig.value,
        userType: userType
    });

    // Only set to a known role option; default to 'user' when unknown (eg. 'authority')
    const allowed = Array.from(select.options).map(o => o.value);
    select.value = allowed.includes(userType) ? userType : 'user';

    console.log('Select value set to:', select.value, 'Allowed values:', allowed);

    const modalElement = document.getElementById('changeRoleModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } else {
        console.error('Modal element not found');
    }
}

function openAssignCourseModal(trainerId, trainerName) {
    console.log('openAssignCourseModal called with:', { trainerId, trainerName });

    // Hide any open modals before showing this modal
    document.querySelectorAll('.modal.show').forEach(modal => {
        const bsModal = bootstrap.Modal.getInstance(modal);
        if(bsModal) bsModal.hide();
    });

    const input = document.getElementById('assignCourseTrainerId');
    const nameDisplay = document.getElementById('trainerNameDisplay');
    const courseSelect = document.getElementById('courseCode');

    if (!input || !nameDisplay || !courseSelect) {
        console.error('Modal elements not found');
        return;
    }

    // Set the values
    input.value = trainerId;
    nameDisplay.textContent = trainerName;
    courseSelect.value = ''; // Reset to default

    const modalElement = document.getElementById('assignCourseModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } else {
        console.error('Assign course modal element not found');
    }
}

function openChangePasswordModal(userId, userName, userType) {
    console.log('openChangePasswordModal called with:', { userId, userName, userType });

    // Hide any open modals before showing this modal
    document.querySelectorAll('.modal.show').forEach(modal => {
        const bsModal = bootstrap.Modal.getInstance(modal);
        if(bsModal) bsModal.hide();
    });

    const userIdInput = document.getElementById('changePasswordUserId');
    const userTypeInput = document.getElementById('changePasswordUserType');
    const userNameDisplay = document.getElementById('changePasswordUserName');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');

    if (!userIdInput || !userTypeInput || !userNameDisplay || !newPasswordInput || !confirmPasswordInput) {
        console.error('Change password modal elements not found');
        return;
    }

    // Set the values
    userIdInput.value = userId;
    userTypeInput.value = userType;
    userNameDisplay.textContent = userName;
    newPasswordInput.value = '';
    confirmPasswordInput.value = '';

    const modalElement = document.getElementById('changePasswordModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } else {
        console.error('Change password modal element not found');
    }
}

async function deleteUserOrTrainer(userId, fullName, userType) {
    console.log('Delete function called:', { userId, fullName, userType });

    // Hide any open modals before showing confirmation
    document.querySelectorAll('.modal.show').forEach(modal => {
        const bsModal = bootstrap.Modal.getInstance(modal);
        if(bsModal) bsModal.hide();
    });

    try {
        const confirmed = await customConfirm(`Delete ${userType} "${fullName}"? This action cannot be undone.`, 'Confirm Delete', {type: 'danger', confirmText: 'Delete', confirmClass: 'btn-danger'});
        console.log('User confirmed:', confirmed);

        if (!confirmed) return;

        // Determine URL and parameter key based on user type
        let url, key;
        if (userType === 'trainer') {
            url = '/delete_trainer';
            key = 'trainer_id';
        } else if (userType === 'user' || userType === 'authority') {
            url = '/delete_user';
            key = 'user_id';
        } else if (userType === 'admin') {
            showTempAlert('Cannot delete admin accounts from this interface.', 'warning');
            return;
        } else {
            showTempAlert('Unknown user type: ' + userType, 'danger');
            return;
        }

        console.log('Sending delete request to:', url, 'with', key, '=', userId);

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `${key}=${encodeURIComponent(userId)}`
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const resp = await response.json();
        console.log('Response data:', resp);

        if (resp.success) {
            const row = document.getElementById(`${userType}-row-${userId}`);
            if (row) {
                row.remove();
                console.log('Row removed from table');
            }
            showTempAlert(resp.message || `${userType.charAt(0).toUpperCase() + userType.slice(1)} deleted successfully.`, 'success', 2000);
        } else {
            showTempAlert(resp.message || 'Failed to delete. Please try again.', 'danger', 3000);
        }
    } catch (error) {
        console.error('Delete error:', error);
        showTempAlert(`Error: ${error.message || 'Failed to delete. Please check console for details.'}`, 'danger', 3000);
    }
}

// Toggle agency field visibility based on role selection - define globally
function toggleAgencyField() {
    const roleSelect = document.getElementById('role');
    const agencyFieldRow = document.getElementById('agencyFieldRow');
    const agencySelect = document.getElementById('agency_id');
    
    console.log('toggleAgencyField called, role:', roleSelect ? roleSelect.value : 'null');
    
    if (roleSelect && agencyFieldRow && agencySelect) {
        if (roleSelect.value === 'user') {
            agencyFieldRow.style.display = '';
            agencySelect.required = true;
            console.log('Agency field shown');
        } else {
            agencyFieldRow.style.display = 'none';
            agencySelect.required = false;
            agencySelect.value = '';
            console.log('Agency field hidden');
        }
    } else {
        console.error('toggleAgencyField: Elements not found', {roleSelect, agencyFieldRow, agencySelect});
    }
}

// Initialize everything when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Admin users page loaded');

    // Attach form submit listener
    const changeRoleForm = document.getElementById('changeRoleForm');
    if (changeRoleForm) {
        changeRoleForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const userId = document.getElementById('changeRoleUserId').value;
            const newRole = document.getElementById('newRole').value;
            const origType = document.getElementById('changeRoleOrigType').value;

            console.log('Change role request:', { userId, newRole, origType });

            if (!userId || !newRole || !origType) {
                showTempAlert('Missing required information. Please try again.', 'warning', 2000);
                return;
            }

            try {
                const response = await fetch('/change_role', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `user_id=${encodeURIComponent(userId)}&new_role=${encodeURIComponent(newRole)}&orig_type=${encodeURIComponent(origType)}`
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                // Parse JSON response regardless of status
                const data = await response.json();
                console.log('Response data:', data);

                if (!response.ok) {
                    // Show the actual error message from the server
                    showTempAlert(data.message || `Server error: ${response.status}`, 'danger', 3000);
                    return;
                }

                // Close modal
                const modalElement = document.getElementById('changeRoleModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }

                // Show result message
                showTempAlert(data.message || 'Role updated successfully.', data.success ? 'success' : 'danger', 2000);

                // Reload page on success
                if (data.success) {
                    setTimeout(() => location.reload(), 2000);
                }
            } catch (error) {
                console.error('Role change error:', error);
                showTempAlert(`Error: ${error.message || 'Failed to change role. Please check console for details.'}`, 'danger', 3000);
            }
        });
    } else {
        console.error('Change role form not found in DOM');
    }

    // Attach assign course form submit listener
    const assignCourseForm = document.getElementById('assignCourseForm');
    if (assignCourseForm) {
        assignCourseForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const trainerId = document.getElementById('assignCourseTrainerId').value;
            const courseCode = document.getElementById('courseCode').value;

            console.log('Assign course request:', { trainerId, courseCode });

            if (!trainerId) {
                showTempAlert('Missing trainer ID. Please try again.', 'warning', 2000);
                return;
            }

            try {
                const response = await fetch('/assign_trainer_course', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `trainer_id=${encodeURIComponent(trainerId)}&course_code=${encodeURIComponent(courseCode)}`
                });

                console.log('Response status:', response.status);

                const data = await response.json();
                console.log('Response data:', data);

                if (!response.ok) {
                    showTempAlert(data.message || `Server error: ${response.status}`, 'danger', 3000);
                    return;
                }

                // Close modal
                const modalElement = document.getElementById('assignCourseModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }

                // Show result message
                showTempAlert(data.message || 'Course assigned successfully.', data.success ? 'success' : 'danger', 2000);

                // Reload page on success
                if (data.success) {
                    setTimeout(() => location.reload(), 2000);
                }
            } catch (error) {
                console.error('Assign course error:', error);
                showTempAlert(`Error: ${error.message || 'Failed to assign course. Please check console for details.'}`, 'danger', 3000);
            }
        });
    } else {
        console.error('Assign course form not found in DOM');
    }

    // Attach change password form submit listener
    const changePasswordForm = document.getElementById('changePasswordForm');
    if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const userId = document.getElementById('changePasswordUserId').value;
            const userType = document.getElementById('changePasswordUserType').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            console.log('Change password request:', { userId, userType });

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showTempAlert('Passwords do not match. Please try again.', 'warning', 2000);
                return;
            }

            if (!userId || !userType || !newPassword) {
                showTempAlert('Missing required information. Please try again.', 'warning', 2000);
                return;
            }

            try {
                const response = await fetch('/admin_change_user_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `user_id=${encodeURIComponent(userId)}&user_type=${encodeURIComponent(userType)}&new_password=${encodeURIComponent(newPassword)}`
                });

                console.log('Response status:', response.status);

                const data = await response.json();
                console.log('Response data:', data);

                if (!response.ok) {
                    showTempAlert(data.message || `Server error: ${response.status}`, 'danger', 3000);
                    return;
                }

                // Close modal
                const modalElement = document.getElementById('changePasswordModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }

                // Show result message
                showTempAlert(data.message || 'Password changed successfully.', data.success ? 'success' : 'danger', 2500);

                // Clear the form
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } catch (error) {
                console.error('Change password error:', error);
                showTempAlert(`Error: ${error.message || 'Failed to change password. Please check console for details.'}`, 'danger', 3000);
            }
        });
    } else {
        console.error('Change password form not found in DOM');
    }

    // Initialize all dropdowns explicitly
    const dropdownElementList = document.querySelectorAll('.dropdown-toggle');
    dropdownElementList.forEach(dropdownToggleEl => {
        new bootstrap.Dropdown(dropdownToggleEl, {
            autoClose: true,
            boundary: 'viewport'
        });
    });

    // Add touch event handling for dropdown buttons (mobile support)
    document.querySelectorAll('.dropdown-toggle').forEach(button => {
        button.addEventListener('touchend', function(e) {
            e.preventDefault();
            setTimeout(() => this.click(), 10);
        }, { passive: false });
    });

    // Add specific handling for dropdown items
    document.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('touchend', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.click();
        }, { passive: false });
    });

    {% if request.args.get('show_create_modal') %}
    // Auto-open modal if server indicated so
    const createModal = document.getElementById('createUserModal');
    if (createModal) {
        new bootstrap.Modal(createModal).show();
    }
    {% endif %}
});
</script>
{% endblock %}
