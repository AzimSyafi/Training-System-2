{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="mb-4">
    <h2 class="h4">Progress Monitor</h2>
    {% if agency %}
      <p class="text-muted">{{ agency.agency_name }} - Trainee Progress Tracking</p>
    {% endif %}
  </div>

  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">User Progress Across All Courses</h5>
    </div>
    <div class="card-body p-0">
      {% if progress_rows and progress_rows|length > 0 %}
        <div class="table-responsive px-4 pt-4">
          <table class="table table-striped table-hover" id="agencyProgressTable" data-paginate="true" data-items-per-page="50">
            <thead>
              <tr>
                <th>User</th>
                <th>Number Series</th>
                <th>Citizenship</th>
                <th>Course</th>
                <th>Progress</th>
                <th>Completed</th>
                <th>Avg Score</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for row in progress_rows %}
              <tr>
                <td>{{ row.user_name }}</td>
                <td>
                  {% if row.user_number_series %}
                    {{ row.user_number_series }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>{{ (row.user_category or 'citizen')|capitalize }}</td>
                <td>
                  <div>{{ row.course_name }}</div>
                  <small class="text-muted">{{ row.course_code }}</small>
                </td>
                <td>
                  <div class="progress" style="height: 20px; min-width: 120px;">
                    <div class="progress-bar {% if row.progress_pct >= 100 %}bg-success{% elif row.progress_pct >= 50 %}bg-info{% else %}bg-warning{% endif %}"
                         role="progressbar"
                         style="width: {{ row.progress_pct }}%;"
                         aria-valuenow="{{ row.progress_pct }}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                      {{ row.progress_pct }}%
                    </div>
                  </div>
                </td>
                <td>{{ row.completed_modules }}/{{ row.total_modules }}</td>
                <td>
                  {% if row.avg_score is not none %}
                    <span class="badge {% if row.avg_score >= 80 %}bg-success{% elif row.avg_score >= 60 %}bg-info{% else %}bg-warning{% endif %}">
                      {{ '%.1f'|format(row.avg_score) }}%
                    </span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if row.status == 'Completed' %}
                    <span class="badge bg-success">
                      <i class="fas fa-check-circle me-1"></i>Completed
                    </span>
                  {% else %}
                    <span class="badge bg-primary">
                      <i class="fas fa-clock me-1"></i>In Progress
                    </span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="mt-3 px-4 pb-3">
          <p class="text-muted small">
            <i class="fas fa-info-circle me-1"></i>
            Showing {{ progress_rows|length }} progress record(s). Only courses with modules are displayed.
          </p>
        </div>
      {% else %}
        <div class="text-center text-muted py-5">
          <i class="fas fa-chart-line fa-3x mb-3 opacity-50"></i>
          <h5>No Progress Data Available</h5>
          <p>Users will appear here once they start enrolling in courses and completing modules.</p>
          {% if agency %}
            <a href="{{ url_for('main.agency_portal') }}" class="btn btn-primary mt-3">
              <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
