{% extends 'base.html' %}
{% block title %}Course{% endblock %}
{% block content %}
<div class="container-fluid">
  <h2 class="mb-4">Course</h2>
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Courses</span>
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createCourseModal"><i class="fas fa-plus"></i> New</button>
        </div>
        <div class="list-group list-group-flush" id="courseList">
          {% for course in courses %}
          <a href="#" class="list-group-item list-group-item-action course-item" data-course-id="{{ course.course_id }}">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">{{ course.name }}</h6>
              <small class="text-muted">{{ course.code }}</small>
            </div>
            <small class="text-muted">Modules: {{ course.modules|length }}</small>
          </a>
          {% else %}
          <div class="p-3 text-muted">No courses yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="col-lg-8">
      <div id="courseDetailPlaceholder" class="text-muted p-5 border rounded text-center">Select a course to manage its modules and content.</div>
      {% for course in courses %}
      <div class="course-detail d-none" id="course-detail-{{ course.course_id }}" data-module-count="{{ course.modules|length }}">
        <div class="card mb-4 shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Course Details</span>
            <form action="{{ url_for('delete_course', course_id=course.course_id) }}" method="post" onsubmit="return confirm('Delete this course?');">
              <button class="btn btn-sm btn-outline-danger" type="submit"><i class="fas fa-trash"></i></button>
            </form>
          </div>
          <div class="card-body">
            <form class="row g-3" action="{{ url_for('update_course', course_id=course.course_id) }}" method="post">
              <div class="col-md-6">
                <label class="form-label">Name</label>
                <input class="form-control" name="name" value="{{ course.name }}" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Code</label>
                <input class="form-control" value="{{ course.code }}" disabled>
              </div>
              <div class="col-md-3">
                <label class="form-label">Allowed Category</label>
                <select class="form-select" name="allowed_category">
                  <option value="both" {% if course.allowed_category=='both' %}selected{% endif %}>Both</option>
                  <option value="citizen" {% if course.allowed_category=='citizen' %}selected{% endif %}>Citizen</option>
                  <option value="foreigner" {% if course.allowed_category=='foreigner' %}selected{% endif %}>Foreigner</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="description" rows="2">{{ course.description }}</textarea>
              </div>
              <div class="col-12 d-flex justify-content-end">
                <button class="btn btn-sm btn-success" type="submit"><i class="fas fa-save"></i> Save</button>
              </div>
            </form>
          </div>
        </div>
        <div class="card mb-4 shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Modules</span>
            <button type="button" class="btn btn-sm btn-primary add-module-btn" data-course-id="{{ course.course_id }}"><i class="fas fa-plus"></i> Add</button>
          </div>
          <div class="add-module-section {% if course.modules|length != 0 %}d-none{% endif %}" id="addModuleForm-{{ course.course_id }}">
            <div class="card-body border-bottom">
              <form class="row g-3" action="{{ url_for('add_course_module', course_id=course.course_id) }}" method="post">
                <div class="col-md-5">
                  <label class="form-label">Module Name</label>
                  <input class="form-control" name="module_name" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Series #</label>
                  <input class="form-control" name="series_number" placeholder="{{ course.code }}001">
                </div>
                <div class="col-md-12">
                  <label class="form-label">Content / Notes</label>
                  <textarea class="form-control" name="content" rows="2"></textarea>
                </div>
                <div class="col-12 d-flex justify-content-end">
                  <button class="btn btn-sm btn-success" type="submit">Create Module</button>
                </div>
              </form>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width:22%">Name</th>
                  <th style="width:10%">Series</th>
                  <th style="width:10%">Slide</th>
                  <th style="width:10%">Video</th>
                  <th style="width:10%">Quiz</th>
                  <th style="width:28%">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% set module_list = course_modules[course.course_id] %}
                {% if module_list %}
                  {% for m in module_list %}
                  <tr>
                    <td>{{ m.module_name }}</td>
                    <td>{{ m.series_number }}</td>
                    <td>{% if m.slide_url %}<a href="{{ url_for('serve_uploaded_slide', filename=m.slide_url) }}" target="_blank" class="text-decoration-none"><i class="fas fa-file-pdf text-danger"></i></a>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                    <td>{% if m.youtube_url %}<a href="{{ m.youtube_url }}" target="_blank"><i class="fab fa-youtube text-danger"></i></a>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                    <td>{% if m.quiz_json %}<i class="fas fa-check text-success"></i>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary module-toggle" data-panel="edit" data-module-id="{{ m.module_id }}"><i class="fas fa-pen"></i></button>
                        <button type="button" class="btn btn-outline-info module-toggle" data-panel="content" data-module-id="{{ m.module_id }}"><i class="fas fa-photo-film"></i></button>
                        <form action="{{ url_for('delete_course_module', module_id=m.module_id) }}" method="post" onsubmit="return confirm('Delete module?');">
                          <button class="btn btn-outline-danger" type="submit"><i class="fas fa-trash"></i></button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td colspan="6" class="p-0">
                      <div class="module-panel panel-edit d-none" id="editModuleForm-{{ m.module_id }}" data-course-id="{{ course.course_id }}">
                        <div class="bg-light p-3 border-top">
                          <form class="row g-2" action="{{ url_for('update_course_module', module_id=m.module_id) }}" method="post">
                            <div class="col-md-4">
                              <label class="form-label small mb-0">Name</label>
                              <input class="form-control form-control-sm" name="module_name" value="{{ m.module_name }}" required>
                            </div>
                            <div class="col-md-2">
                              <label class="form-label small mb-0">Series #</label>
                              <input class="form-control form-control-sm" name="series_number" value="{{ m.series_number }}">
                            </div>
                            <div class="col-md-6">
                              <label class="form-label small mb-0">Content</label>
                              <input class="form-control form-control-sm" name="content" value="{{ m.content }}">
                            </div>
                            <div class="col-12 d-flex justify-content-end mt-2">
                              <button class="btn btn-sm btn-success" type="submit">Save</button>
                            </div>
                          </form>
                          <div class="text-end mt-1"><button type="button" class="btn btn-link btn-sm text-decoration-none module-panel-close" data-target="editModuleForm-{{ m.module_id }}">Close</button></div>
                        </div>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td colspan="6" class="p-0">
                      <div class="module-panel panel-content d-none" id="contentForm-{{ m.module_id }}" data-course-id="{{ course.course_id }}">
                        <div class="bg-white p-3 border-top">
                          <ul class="nav nav-pills mb-2" id="pills-{{ m.module_id }}" role="tablist">
                            <li class="nav-item" role="presentation">
                              <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#slide-pane-{{ m.module_id }}" type="button">Slide</button>
                            </li>
                            <li class="nav-item" role="presentation">
                              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#video-pane-{{ m.module_id }}" type="button">Video</button>
                            </li>
                            <li class="nav-item" role="presentation">
                              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#quiz-pane-{{ m.module_id }}" type="button">Quiz</button>
                            </li>
                          </ul>
                          <div class="tab-content">
                            <div class="tab-pane fade show active" id="slide-pane-{{ m.module_id }}">
                              <form class="row g-2" action="{{ url_for('manage_module_content', module_id=m.module_id) }}" method="post" enctype="multipart/form-data">
                                <input type="hidden" name="content_type" value="slide">
                                <div class="col-md-6">
                                  <input type="file" name="slide_file" class="form-control form-control-sm" accept=".pdf,.ppt,.pptx">
                                </div>
                                <div class="col-md-6 d-flex align-items-center gap-2">
                                  {% if m.slide_url %}<span class="small text-success">Current: {{ m.slide_url }}</span>{% endif %}
                                  <button class="btn btn-sm btn-primary" type="submit">Upload</button>
                                </div>
                              </form>
                              <div class="text-end mt-1"><button type="button" class="btn btn-link btn-sm text-decoration-none module-panel-close" data-target="contentForm-{{ m.module_id }}">Close</button></div>
                            </div>
                            <div class="tab-pane fade" id="video-pane-{{ m.module_id }}">
                              <form class="row g-2" action="{{ url_for('manage_module_content', module_id=m.module_id) }}" method="post">
                                <input type="hidden" name="content_type" value="video">
                                <div class="col-md-8">
                                  <input class="form-control form-control-sm" name="youtube_url" placeholder="YouTube URL" value="{{ m.youtube_url }}">
                                </div>
                                <div class="col-md-4">
                                  <button class="btn btn-sm btn-primary w-100" type="submit">Save</button>
                                </div>
                              </form>
                            </div>
                            <div class="tab-pane fade" id="quiz-pane-{{ m.module_id }}">
                              <form class="row g-2 quiz-form" id="quiz-form-{{ m.module_id }}" action="{{ url_for('manage_module_content', module_id=m.module_id) }}" method="post" enctype="multipart/form-data" data-module-id="{{ m.module_id }}">
                                <input type="hidden" name="content_type" value="quiz">
                                <div class="col-12">
                                  <div id="quiz-questions-{{ m.module_id }}" class="quiz-questions" data-module-id="{{ m.module_id }}"></div>
                                  <div class="d-flex justify-content-between align-items-center mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary add-question-btn" data-module-id="{{ m.module_id }}">Add Question</button>
                                    <small class="text-muted">Up to 5 questions. Remove with the trash icon.</small>
                                  </div>
                                  <div class="mt-3">
                                    <label class="small text-muted mb-1">(Optional) Quiz Image (single image for entire quiz)</label>
                                    <input type="file" name="quiz_image" class="form-control form-control-sm" style="max-width:300px;">
                                  </div>
                                </div>
                                <div class="col-12 d-flex justify-content-end mt-3">
                                  <button class="btn btn-sm btn-primary" type="submit">Save Quiz</button>
                                </div>
                              </form>
                              {% if m.quiz_json %}
                              <div class="mt-2 small text-success">Quiz already configured. Saving will overwrite.</div>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                <tr>
                  <td colspan="6" class="text-center text-muted py-3">No modules yet. Click the Add button above to create the first module.</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div> <!-- /.table-responsive -->
        </div> <!-- /.card (modules) -->
      </div> <!-- /.course-detail -->
      {% endfor %}
    </div>
  </div>
</div>

<!-- Create Course Modal -->
<div class="modal fade" id="createCourseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('create_course') }}">
        <div class="modal-header">
          <h5 class="modal-title">New Course</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input class="form-control" name="name" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Code</label>
              <input class="form-control" name="code" maxlength="10" placeholder="CSG" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Allowed Category</label>
              <select class="form-select" name="allowed_category">
                <option value="both">Both</option>
                <option value="citizen">Citizen</option>
                <option value="foreigner">Foreigner</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-primary" type="submit">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
// Course selection + accordion panel logic
(function initCourseSelection(){
  if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initCourseSelection); return; }
  const items = document.querySelectorAll('.course-item');
  const placeholder = document.getElementById('courseDetailPlaceholder');
  function showCourse(it){
    const cid = it.getAttribute('data-course-id');
    document.querySelectorAll('.course-detail').forEach(cd => cd.classList.add('d-none'));
    const target = document.getElementById('course-detail-' + cid);
    if(target){
      target.classList.remove('d-none');
      if(placeholder) placeholder.classList.add('d-none');
      items.forEach(i=>i.classList.remove('active'));
      it.classList.add('active');
      try { localStorage.setItem('lastCourseId', cid); } catch(e){}
      // Auto-open Add Module section if no modules yet
      if(target.getAttribute('data-module-count') === '0'){
        const addSection = target.querySelector('.add-module-section');
        if(addSection){ addSection.classList.remove('d-none'); }
      } else {
        // Restore persisted open section for this course
        try { if(localStorage.getItem('openAddForCourse') === cid){ const addSection = target.querySelector('.add-module-section'); if(addSection) addSection.classList.remove('d-none'); } } catch(e){}
      }
    }
  }
  items.forEach(it => { it.addEventListener('click', e => { e.preventDefault(); showCourse(it); }); });
  const last = (function(){ try { return localStorage.getItem('lastCourseId'); } catch(e){ return null; } })();
  let initial = last ? [...items].find(i=>i.getAttribute('data-course-id')===last) : null;
  if(!initial) initial = items[0];
  if(initial) showCourse(initial);
})();
</script>
<script>
// Simple Add Module show/hide (remove Bootstrap collapse to prevent flicker)
(function initPlainAddModuleToggle(){
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded', initPlainAddModuleToggle); return;}
  if(window.__plainAddModuleInit) return; window.__plainAddModuleInit = true;
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.add-module-btn');
    if(!btn) return;
    e.preventDefault();
    const courseId = btn.getAttribute('data-course-id');
    const section = document.getElementById('addModuleForm-'+courseId);
    if(!section) return;
    const willHide = !section.classList.contains('d-none');
    document.querySelectorAll('.add-module-section').forEach(sec=>{ if(sec!==section) sec.classList.add('d-none'); });
    if(willHide){
      section.classList.add('d-none');
      try { localStorage.removeItem('openAddForCourse'); } catch(_){}
    } else {
      section.classList.remove('d-none');
      try { localStorage.setItem('openAddForCourse', courseId); } catch(_){}
    }
  });
  // Restore previously open add form
  let last=null; try { last = localStorage.getItem('openAddForCourse'); } catch(_){}
  if(last){ const sec = document.getElementById('addModuleForm-'+last); if(sec) sec.classList.remove('d-none'); }
})();
</script>
<script>
// Persist Add Module form open state (removed old collapse-dependent logic)
</script>
<script>
// Dynamic quiz builder (add/remove/reindex up to 5 questions)
(function quizBuilderInit(){
  if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', quizBuilderInit); return; }
  function buildQuestionBlock(moduleId, index){
    const wrapper = document.createElement('fieldset');
    wrapper.className = 'border rounded p-2 mb-2 quiz-question-block';
    wrapper.setAttribute('data-index', index);
    wrapper.innerHTML = `
      <legend class="float-none w-auto px-2 small mb-1 d-flex justify-content-between align-items-center">Question <span class="qq-number">${index}</span>
        <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-question-btn" title="Remove question" ${index===1?'disabled':''}><i class="fas fa-trash"></i></button>
      </legend>
      <input class="form-control form-control-sm mb-2 quiz-question-input" name="quiz_question_${index}" placeholder="Enter question ${index}">
      <div class="row g-1 mb-1 answers-block">
        ${[1,2,3,4,5].map(an=>`<div class='col-md-4'><input class='form-control form-control-sm answer-input' name='answer_${index}_${an}' placeholder='Answer ${an}'></div>`).join('')}
      </div>
      <div class="d-flex align-items-center gap-2 mb-1">
        <label class="small mb-0">Correct Answer #</label>
        <select class="form-select form-select-sm correct-select" name="correct_answer_${index}" style="width:auto;">
          ${[1,2,3,4,5].map(an=>`<option value='${an}'>${an}</option>`).join('')}
        </select>
      </div>`;
    return wrapper;
  }
  function reindex(form){
    const blocks = [...form.querySelectorAll('.quiz-question-block')];
    blocks.forEach((b,i)=>{
      const newIdx = i+1;
      b.setAttribute('data-index', newIdx);
      b.querySelector('.qq-number').textContent = newIdx;
      const qInput = b.querySelector('.quiz-question-input');
      qInput.name = `quiz_question_${newIdx}`;
      [...b.querySelectorAll('.answer-input')].forEach((inp,ai)=>{ inp.name = `answer_${newIdx}_${ai+1}`; });
      const sel = b.querySelector('.correct-select');
      sel.name = `correct_answer_${newIdx}`;
      const rmBtn = b.querySelector('.remove-question-btn');
      if(rmBtn) rmBtn.disabled = (newIdx===1);
    });
  }
  function updateAddBtnState(container){
    const addBtn = container.closest('.quiz-form').querySelector('.add-question-btn');
    const count = container.querySelectorAll('.quiz-question-block').length;
    if(addBtn) addBtn.disabled = count >=5;
  }
  document.addEventListener('click', (e)=>{
    if(e.target.closest('.add-question-btn')){
      const btn = e.target.closest('.add-question-btn');
      const moduleId = btn.getAttribute('data-module-id');
      const container = document.getElementById('quiz-questions-' + moduleId);
      const current = container.querySelectorAll('.quiz-question-block').length;
      if(current < 5){
        container.appendChild(buildQuestionBlock(moduleId, current+1));
        updateAddBtnState(container);
      }
    } else if(e.target.closest('.remove-question-btn')){
      const rm = e.target.closest('.remove-question-btn');
      if(rm.disabled) return;
      const block = rm.closest('.quiz-question-block');
      const form = rm.closest('form');
      block.remove();
      reindex(form);
      const container = form.querySelector('.quiz-questions');
      updateAddBtnState(container);
    }
  });
  // Initialize quiz forms
  document.querySelectorAll('.quiz-questions').forEach(container => {
    if(container.querySelectorAll('.quiz-question-block').length === 0){
      const moduleId = container.getAttribute('data-module-id');
      container.appendChild(buildQuestionBlock(moduleId,1));
      updateAddBtnState(container);
    }
  });
  document.querySelectorAll('.quiz-form').forEach(form => {
    form.addEventListener('submit', () => { reindex(form); });
  });
})();
</script>
<script>
// Module edit/content panel toggles with persistence (hardened against flicker)
(function initModulePanelToggles(){
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded', initModulePanelToggles); return;}
  if(window.__modulePanelTogglesInitV2) return; window.__modulePanelTogglesInitV2 = true;
  let lastClick = 0;
  function openPanel(moduleId, panelType){
    const editPanel = document.getElementById('editModuleForm-'+moduleId);
    const contentPanel = document.getElementById('contentForm-'+moduleId);
    const targetPanel = panelType === 'edit' ? editPanel : contentPanel;
    if(!targetPanel) return;
    // Hide all others first
    document.querySelectorAll('.module-panel').forEach(p=>{ if(p!==targetPanel) p.classList.add('d-none'); });
    targetPanel.classList.remove('d-none');
    try { localStorage.setItem('openModulePanel', JSON.stringify({moduleId, panelType})); } catch(e){}
  }
  document.addEventListener('click', function(e){
    // Close buttons
    const closeBtn = e.target.closest('.module-panel-close');
    if(closeBtn){
      const target = document.getElementById(closeBtn.getAttribute('data-target'));
      if(target){ target.classList.add('d-none'); try { localStorage.removeItem('openModulePanel'); } catch(e){} }
      return;
    }
    const btn = e.target.closest('.module-toggle');
    if(!btn) return;
    e.preventDefault();
    const now = performance.now();
    if(now - lastClick < 40) return; // debounce double-fire
    lastClick = now;
    const moduleId = btn.getAttribute('data-module-id');
    const panelType = btn.getAttribute('data-panel');
    openPanel(moduleId, panelType);
  });
})();
</script>
<script>
// Restore last open module panel (and optionally tab) after reload/navigation
(function restoreModulePanel(){
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded', restoreModulePanel); return;}
  function attemptRestore(){
    let data = null;
    try { data = JSON.parse(localStorage.getItem('openModulePanel')||'null'); } catch(e){ data=null; }
    if(!data) return;
    const { moduleId, panelType } = data;
    const panel = document.getElementById((panelType==='edit'?'editModuleForm-':'contentForm-')+moduleId);
    if(!panel) return; // Might belong to another course that was deleted
    // Ensure correct course section is visible
    const courseId = panel.getAttribute('data-course-id');
    if(courseId){
      const courseItem = document.querySelector('.course-item[data-course-id="'+courseId+'"]');
      if(courseItem){ courseItem.click(); }
    }
    // Slight delay to allow course view to render
    setTimeout(()=>{ panel.classList.remove('d-none'); }, 120);
  }
  // Run after initial selection script likely finished
  setTimeout(attemptRestore, 250);
})();
</script>
<script>
// Persist Add Module form open state
(function initAddModulePersistence(){
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded', initAddModulePersistence); return;}
})();
</script>
<style>
  .quiz-question-block legend { font-size: 0.8rem; }
</style>
{% endblock %}
