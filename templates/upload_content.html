{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Upload / Manage Module Content</h2>
  <p class="text-muted">Upload slides (PDF / PPTX), add a YouTube video URL, or create a quiz (up to 5 questions) for an existing module.</p>
  <a href="{{ url_for('main.trainer_portal') }}" class="btn btn-secondary mb-3">Back to Trainer Portal</a>

  <form method="POST" enctype="multipart/form-data" class="card p-3 mb-4">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Module</label>
        <select name="module_id" class="form-select" required>
          <option value="">-- Select Module --</option>
          {% for m in modules %}
            <option value="{{ m.module_id }}">{{ m.module_type }} - {{ m.series_number or 'N/A' }} - {{ m.module_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Content Type</label>
        <select name="content_type" id="content_type" class="form-select" required onchange="toggleContentBlocks()">
          <option value="">-- Choose --</option>
          <option value="slide">Slide (PDF / PPTX)</option>
            <option value="video">YouTube Video</option>
          <option value="quiz">Quiz</option>
        </select>
      </div>
    </div>

    <!-- Slide Upload -->
    <div id="block-slide" class="mt-3" style="display:none;">
      <label class="form-label">Slide File</label>
      <input type="file" name="slide_file" accept=".pdf,.ppt,.pptx" class="form-control" />
      <div class="form-text">Accepted: PDF, PPTX. A unique name will be generated if a file with the same name exists.</div>
    </div>

    <!-- Video URL -->
    <div id="block-video" class="mt-3" style="display:none;">
      <label class="form-label">YouTube URL</label>
      <input type="url" name="youtube_url" class="form-control" placeholder="https://www.youtube.com/watch?v=..." />
    </div>

    <!-- Quiz Builder -->
    <div id="block-quiz" class="mt-3" style="display:none;">
      <p class="fw-bold">Quiz (Up to 5 Questions)</p>
      <div class="d-flex align-items-center gap-2 mb-2 qcount-controls">
        <button type="button" class="btn btn-sm btn-outline-secondary qcount-decr">&minus;</button>
        <input type="number" min="1" max="5" value="1" class="form-control form-control-sm qcount-input" style="width:80px" />
        <button type="button" class="btn btn-sm btn-outline-secondary qcount-incr">+</button>
        <small class="text-muted ms-2">Questions</small>
      </div>
      <div class="accordion" id="quizAccordion">
        {% for qn in range(1,6) %}
        <div class="accordion-item mb-2 quiz-panel" data-qnum="{{ qn }}" style="display: none;">
          <h2 class="accordion-header" id="heading{{ qn }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ qn }}">
              Question {{ qn }}
            </button>
          </h2>
          <div id="collapse{{ qn }}" class="accordion-collapse collapse" data-bs-parent="#quizAccordion">
            <div class="accordion-body">
              <div class="mb-2">
                <label class="form-label">Question Text</label>
                <input type="text" class="form-control" name="quiz_question_{{ qn }}" />
              </div>
              <div class="row g-2">
                {% for an in range(1,6) %}
                <div class="col-md-6">
                  <label class="form-label small mb-0">Answer {{ an }}</label>
                  <input type="text" class="form-control form-control-sm" name="answer_{{ qn }}_{{ an }}" />
                </div>
                {% endfor %}
              </div>
              <div class="mt-2">
                <label class="form-label">Correct Answer (1-5)</label>
                <select name="correct_answer_{{ qn }}" class="form-select form-select-sm">
                  <option value="">--</option>
                  {% for an in range(1,6) %}
                    <option value="{{ an }}">{{ an }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="alert alert-info mt-2 py-2">Leave unused questions blank; they'll be ignored.</div>
    </div>

    <div class="mt-4">
      <button type="submit" class="btn btn-primary">Save Content</button>
    </div>
  </form>
</div>
<script>
function toggleContentBlocks(){
  const val = document.getElementById('content_type').value;
  ['slide','video','quiz'].forEach(t => {
    document.getElementById('block-'+t).style.display = (val===t)?'block':'none';
  });
}
// Quiz count control for upload_content page
document.addEventListener('DOMContentLoaded', function(){
  const qDecr = document.querySelector('.qcount-decr');
  const qIncr = document.querySelector('.qcount-incr');
  const qInput = document.querySelector('.qcount-input');
  const panels = Array.from(document.querySelectorAll('#quizAccordion .quiz-panel'));
  function showCount(n){
    n = Math.max(1, Math.min(5, parseInt(n,10)||1));
    panels.forEach((p, idx)=> { p.style.display = (idx < n) ? '' : 'none'; });
    if (qInput) qInput.value = n;
  }
  qDecr && qDecr.addEventListener('click', ()=> showCount(Math.max(1, parseInt(qInput.value||'1',10)-1)));
  qIncr && qIncr.addEventListener('click', ()=> showCount(Math.min(5, parseInt(qInput.value||'1',10)+1)));
  // Debounced input so typing updates panels
  if (qInput){
    let _t = null;
    qInput.addEventListener('input', (e)=>{
      clearTimeout(_t);
      const raw = e.target.value;
      _t = setTimeout(()=> showCount(raw), 350);
    });
    // Also handle Enter immediately
    qInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); showCount(qInput.value); } });
  }
   // initialize hidden until quiz block visible; still set default
   showCount(1);
 });
</script>
{% endblock %}
