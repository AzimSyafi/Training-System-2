{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="mb-4">
    <h2 class="h4">Agency Portal</h2>
    {% if agency %}
      <div class="row g-3">
        <div class="col-md-6">
          <div class="text-muted">{{ agency.agency_name }} (ID: {{ agency.agency_id }})</div>
          <div class="small text-muted">Email: {{ agency.email }} | Phone: {{ agency.contact_number }}</div>
        </div>
        <div class="col-md-6 text-md-end">
          {% if current_user.__class__.__name__ == 'AgencyAccount' %}
            <button id="toggleAgencyEdit" class="btn btn-outline-secondary btn-sm">Edit agency details</button>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <div id="agencyDetailsCard" class="card mb-4">
    <div class="card-header">Agency Details</div>
    <div class="card-body">
      {% if not agency %}
        <div class="text-muted">No agency associated with this account.</div>
      {% else %}
        <div id="agencyView">
          <p><strong>Name:</strong> {{ agency.agency_name }}</p>
          <p><strong>PIC:</strong> {{ agency.PIC }}</p>
          <p><strong>Email:</strong> {{ agency.email }}</p>
          <p><strong>Contact:</strong> {{ agency.contact_number }}</p>
          <p><strong>Address:</strong> {{ agency.address }}</p>
        </div>

        {% if current_user.__class__.__name__ == 'AgencyAccount' %}
        <form id="agencyEditForm" method="post" action="{{ url_for('main.agency_update_details') }}" style="display:none;">
          <div class="mb-3">
            <label for="agency_name" class="form-label">Agency name</label>
            <input id="agency_name" name="agency_name" class="form-control" value="{{ agency.agency_name }}" />
          </div>
          <div class="mb-3">
            <label for="PIC" class="form-label">Person in Charge (PIC)</label>
            <input id="PIC" name="PIC" class="form-control" value="{{ agency.PIC }}" />
          </div>
          <div class="mb-3">
            <label for="agency_email" class="form-label">Email</label>
            <input id="agency_email" name="email" type="email" class="form-control" value="{{ agency.email }}" />
          </div>
          <div class="mb-3">
            <label for="contact_number" class="form-label">Contact number</label>
            <input id="contact_number" name="contact_number" class="form-control" value="{{ agency.contact_number }}" />
          </div>
          <div class="mb-3">
            <label for="agency_address" class="form-label">Address</label>
            <textarea id="agency_address" name="address" class="form-control" rows="3">{{ agency.address }}</textarea>
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Save changes</button>
            <button type="button" id="cancelAgencyEdit" class="btn btn-outline-secondary">Cancel</button>
          </div>
        </form>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <div class="row g-4">
    <div class="col-md-5">
      <div class="card mb-3">
        <div class="card-header">Add New User</div>
        <div class="card-body">
          <form method="post" action="{{ url_for('main.agency_create_user') }}">
            <div class="mb-3">
              <label for="new_full_name" class="form-label">Full name</label>
              <input id="new_full_name" name="full_name" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="new_user_email" class="form-label">Email</label>
              <input id="new_user_email" type="email" name="email" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="new_user_password" class="form-label">Password</label>
              <input id="new_user_password" type="password" name="password" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="new_user_category" class="form-label">User category</label>
              <select id="new_user_category" name="user_category" class="form-select">
                <option value="citizen">Citizen</option>
                <option value="foreigner">Foreigner</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Create user</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Import Users from Excel</div>
        <div class="card-body">
          <form method="post" action="{{ url_for('main.agency_bulk_create_users') }}" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="excel_file" class="form-label">Upload Excel File</label>
              <input id="excel_file" name="excel_file" type="file" class="form-control" accept=".xlsx,.xls" required />
              <div class="form-text">
                Excel file should have 3 columns: <strong>Name</strong>, <strong>Email</strong>, <strong>Citizenship</strong>
                <br>First row should be headers. Citizenship values: "citizen" or "foreigner"
              </div>
            </div>
            <div class="alert alert-info mb-3">
              <small>
                <strong>Note:</strong> Default password for all imported users will be: <code>Welcome123!</code>
                <br>Users should change their password after first login.
              </small>
            </div>
            <button type="submit" class="btn btn-success">
              <i class="bi bi-upload"></i> Import Users
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-7">
      <div class="card">
        <div class="card-header">Your Users</div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table id="agencyUsersTable" class="table table-striped mb-0" data-responsive-table="true">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Citizenship</th>
                  <th>Number Series</th>
                </tr>
              </thead>
              <tbody>
                {% if agency_users and agency_users|length > 0 %}
                  {% for user in agency_users %}
                  <tr>
                    <td data-label="Name" data-primary="true">{{ user.full_name }}</td>
                    <td data-label="Email" data-secondary="true">{{ user.email }}</td>
                    <td data-label="Citizenship">{{ (user.user_category or 'citizen')|capitalize }}</td>
                    <td data-label="Number Series">
                      {% if user.number_series %}
                        <span class="badge bg-secondary">{{ user.number_series }}</span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                <tr>
                  <td colspan="4" class="text-center text-muted">No users found for this agency.</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const toggle = document.getElementById('toggleAgencyEdit');
  const form = document.getElementById('agencyEditForm');
  const view = document.getElementById('agencyView');
  const cancel = document.getElementById('cancelAgencyEdit');
  if(toggle && form && view){
    toggle.addEventListener('click', function(){
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      view.style.display = form.style.display === 'none' ? 'block' : 'none';
    });
  }
  if(cancel && form && view){
    cancel.addEventListener('click', function(){
      form.style.display = 'none';
      view.style.display = 'block';
    });
  }
});
</script>
{% endblock %}
