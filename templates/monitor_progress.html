{% extends "base.html" %}
{% block title %}Progress Monitor{% endblock %}
{% block content %}
<div class="container-fluid py-4">
  <h2 class="mb-3 d-flex align-items-center gap-3">
    <span><i class="fas fa-chart-line"></i> Progress Monitoring</span>
    {% set rows = course_progress_rows or [] %}
    <small class="text-muted">{{ rows|length }} result{{ '' if rows|length == 1 else 's' }}</small>
  </h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Filters -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form method="get" action="{{ url_for('main.monitor_progress') }}" class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label" for="mp_q">Search</label>
          <input id="mp_q" type="text" class="form-control" name="q" placeholder="User, Agency, Course" value="{{ (filters.q if filters else request.args.get('q')) or '' }}">
        </div>
        <div class="col-md-2">
          <label class="form-label" for="mp_agency">Agency</label>
          <select id="mp_agency" class="form-select" name="agency_id">
            <option value="">All agencies</option>
            {% for a in (agencies or []) %}
              <option value="{{ a.agency_id }}" {% if filters and filters.agency_id==a.agency_id %}selected{% endif %}>{{ a.agency_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label" for="mp_course">Course</label>
          <select id="mp_course" class="form-select" name="course_id">
            <option value="">All courses</option>
            {% for c in (courses or []) %}
              <option value="{{ c.course_id }}" {% if filters and filters.course_id==c.course_id %}selected{% endif %}>{{ c.name }} ({{ c.code }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label" for="mp_status">Status</label>
          <select id="mp_status" class="form-select" name="status">
            {% set st = (filters.status if filters else request.args.get('status')) or '' %}
            <option value="" {% if st=='' %}selected{% endif %}>All</option>
            <option value="in_progress" {% if st=='in_progress' %}selected{% endif %}>In Progress</option>
            <option value="completed" {% if st=='completed' %}selected{% endif %}>Completed</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="mp_min_progress">Progress % range</label>
          <div class="input-group">
            <input id="mp_min_progress" type="number" class="form-control" name="min_progress" min="0" max="100" step="1" placeholder="Min" value="{{ (filters.min_progress if filters else request.args.get('min_progress')) or '' }}">
            <span class="input-group-text">-</span>
            <input id="mp_max_progress" type="number" class="form-control" name="max_progress" min="0" max="100" step="1" placeholder="Max" aria-label="Max progress" value="{{ (filters.max_progress if filters else request.args.get('max_progress')) or '' }}">
          </div>
        </div>
         <div class="col-12 d-flex gap-2 mt-1">
          <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> Apply</button>
          <a href="{{ url_for('main.monitor_progress') }}" class="btn btn-outline-secondary">Reset</a>
        </div>
      </form>
    </div>
  </div>

  {% set rows = course_progress_rows or [] %}
  {% if rows and rows|length > 0 %}
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive px-4 pt-4 pb-2">
        <table class="table table-striped mb-0 align-middle" id="progressTable" data-paginate="true" data-items-per-page="50" data-responsive-table="true">
          <thead class="table-light">
            <tr>
              <th data-label="User" data-primary="true">User</th>
              <th data-label="Course" data-secondary="true">Course</th>
              <th data-label="Agency">Agency</th>
              <th data-label="Progress">Progress</th>
              <th data-label="Avg Score">Avg Score</th>
              <th data-label="Status">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr>
              <td>
                <a href="#" class="text-decoration-none fw-semibold user-progress-link" data-user-name="{{ r.user_name }}" data-agency-name="{{ r.agency_name }}" style="cursor: pointer;">
                  {{ r.user_name }}
                </a>
              </td>
              <td>{{ r.course_name }} <span class="badge bg-secondary">{{ r.course_code }}</span></td>
              <td>{{ r.agency_name }}</td>
              <td>
                <div class="progress" style="height: 20px;">
                  <div class="progress-bar {% if r.progress_pct >= 100 %}bg-success{% elif r.progress_pct >= 50 %}bg-primary{% else %}bg-warning text-dark{% endif %}" role="progressbar" style="width: {{ r.progress_pct }}%;" aria-valuenow="{{ r.progress_pct }}" aria-valuemin="0" aria-valuemax="100">{{ r.progress_pct }}%</div>
                </div>
              </td>
              <td>
                {% if r.score is not none %}
                  <span class="fw-semibold {% if r.score <= 50 %}text-danger{% elif r.score > 75 %}text-success{% else %}text-primary{% endif %}">{{ r.score }}</span>%
                {% else %}-{% endif %}
              </td>
              <td>
                {% if r.status == 'Completed' %}
                  <span class="badge bg-success">Completed</span>
                {% else %}
                  <span class="badge bg-warning text-dark">In Progress</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
    <div class="alert alert-info">No course progress records yet.</div>
  {% endif %}
</div>

<!-- User Progress Detail Modal -->
<div class="modal fade" id="userProgressModal" tabindex="-1" aria-labelledby="userProgressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userProgressModalLabel">
          <i class="fas fa-user-chart"></i> User Progress Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="userProgressContent">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
// Store progress data for modal
const progressData = {{ rows|tojson|safe }};

function showUserProgressModal(userName, agencyName) {
  console.log('Opening modal for:', userName, agencyName);
  console.log('Progress data:', progressData);
  
  // Filter progress data for this user
  const userProgress = progressData.filter(r => r.user_name === userName);
  console.log('Filtered user progress:', userProgress);
  
  if (userProgress.length === 0) {
    console.warn('No progress data found for user:', userName);
    return;
  }
  
  // Escape HTML to prevent XSS
  const escapeHtml = (text) => {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  };
  
  // Build modal content
  let content = `
    <div class="mb-4 pb-3 border-bottom">
      <h5 class="mb-2 fw-bold"><i class="fas fa-user me-2"></i>${escapeHtml(userName)}</h5>
      <p class="text-muted mb-0"><i class="fas fa-building me-2"></i>${escapeHtml(agencyName || 'No Agency')}</p>
    </div>
    
    <h6 class="mb-3 fw-semibold">Course Progress (${userProgress.length} course${userProgress.length !== 1 ? 's' : ''})</h6>
    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
      <table class="table table-striped table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Course</th>
            <th>Progress</th>
            <th>Avg Score</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  userProgress.forEach(r => {
    const progressBarColor = r.progress_pct >= 100 ? 'bg-success' : (r.progress_pct >= 50 ? 'bg-primary' : 'bg-warning text-dark');
    const scoreColor = r.score !== null ? (r.score <= 50 ? 'text-danger' : (r.score > 75 ? 'text-success' : 'text-primary')) : '';
    const scoreText = r.score !== null ? `<span class="fw-semibold ${scoreColor}">${r.score}</span>%` : '-';
    const statusBadge = r.status === 'Completed' ? '<span class="badge bg-success">Completed</span>' : '<span class="badge bg-warning text-dark">In Progress</span>';
    
    content += `
      <tr>
        <td>
          <div>${escapeHtml(r.course_name)}</div>
          <small class="text-muted">${escapeHtml(r.course_code)}</small>
        </td>
        <td>
          <div class="progress" style="height: 20px; min-width: 120px;">
            <div class="progress-bar ${progressBarColor}" role="progressbar" style="width: ${r.progress_pct}%;" aria-valuenow="${r.progress_pct}" aria-valuemin="0" aria-valuemax="100">
              ${r.progress_pct}%
            </div>
          </div>
        </td>
        <td>${scoreText}</td>
        <td>${statusBadge}</td>
      </tr>
    `;
  });
  
  content += `
        </tbody>
      </table>
    </div>
  `;
  
  // Update modal content and show
  document.getElementById('userProgressContent').innerHTML = content;
  const modal = new bootstrap.Modal(document.getElementById('userProgressModal'));
  modal.show();
}

// Add event listeners to all user progress links
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.user-progress-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const userName = this.getAttribute('data-user-name');
      const agencyName = this.getAttribute('data-agency-name');
      showUserProgressModal(userName, agencyName);
    });
  });
});
</script>
{% endblock %}
