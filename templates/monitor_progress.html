{% extends "base.html" %}
{% block title %}Progress Monitor{% endblock %}
{% block content %}
<div class="container-fluid py-4">
  <h2 class="mb-4"><i class="fas fa-chart-line"></i> Progress Monitoring</h2>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  {% if user_modules and user_modules|length > 0 %}
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>User</th>
              <th>Module</th>
              <th>Agency</th>
              <th>Status</th>
              <th>Score</th>
              <th>Completion Date</th>
              <th>Certificate</th>
            </tr>
          </thead>
          <tbody>
            {% for um, user, module, agency in user_modules %}
            <tr>
              <td>{{ user.full_name }}</td>
              <td>{{ module.module_name }}</td>
              <td>{{ agency.agency_name }}</td>
              <td>
                {% if um.is_completed %}
                  <span class="badge bg-success">Completed</span>
                {% else %}
                  <span class="badge bg-warning text-dark">In Progress</span>
                {% endif %}
              </td>
              <td>
                {% if um.is_completed %}
                  <span class="fw-semibold {% if um.score <= 50 %}text-danger{% elif um.score > 75 %}text-success{% else %}text-primary{% endif %}">{{ um.score|round(0, 'floor') }}%</span>
                {% else %}-{% endif %}
              </td>
              <td>{% if um.completion_date %}{{ um.completion_date.strftime('%Y-%m-%d %H:%M') }}{% else %}-{% endif %}</td>
              <td>
                {% set key = (user.User_id, module.module_id) %}
                {% if key in existing_certs %}
                  <span class="badge bg-info"><i class="fas fa-check"></i> Issued</span>
                {% elif um.is_completed and um.score > 50 %}
                  <form method="POST" action="{{ safe_url_for('issue_certificate') }}" class="d-inline">
                    <input type="hidden" name="user_id" value="{{ user.User_id }}">
                    <input type="hidden" name="module_id" value="{{ module.module_id }}">
                    <button type="submit" class="btn btn-sm btn-outline-success"><i class="fas fa-certificate"></i> Issue</button>
                  </form>
                {% else %}
                  <span class="text-muted small">Not Eligible</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
    <div class="alert alert-info">No progress records yet.</div>
  {% endif %}
</div>
{% endblock %}
