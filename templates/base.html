<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Security Training System{% endblock %}</title>
    {% set always_light = request.endpoint in ['main.index','main.onboarding'] %}
    <script>
        // Prevent BFCache from showing protected pages after logout (handles multiple back presses)
        (function(){
            function shouldReloadFromBFCache(evt){
                try {
                    if (evt && evt.persisted) return true; // bfcache restore
                    var navEntry = (performance && performance.getEntriesByType) ? performance.getEntriesByType('navigation')[0] : null;
                    if (navEntry && navEntry.type === 'back_forward') return true;
                    // Fallback for older browsers
                    if (performance && performance.navigation && performance.navigation.type === 2) return true;
                } catch(e) {}
                return false;
            }
            window.addEventListener('pageshow', function(e){
                if (shouldReloadFromBFCache(e)) {
                    // Force a fresh request so server auth redirects apply
                    window.location.reload();
                }
            });
        })();
    </script>
    <script>
        // Early theme application (skip dark for always-light endpoints)
        (function() {
            var ALWAYS_LIGHT = {{ 'true' if always_light else 'false' }};
            // Use database preference for logged-in users
            var USER_DARK_MODE = {{ 'true' if current_user.is_authenticated and current_user.dark_mode_enabled else 'false' }};
            try {
                if (!ALWAYS_LIGHT) {
                    if (USER_DARK_MODE) {
                        document.documentElement.classList.add('darkmode');
                        // Sync localStorage with database preference
                        localStorage.setItem('theme-preference', 'dark');
                    } else {
                        // Clear localStorage if user preference is light
                        localStorage.setItem('theme-preference', 'light');
                    }
                } else {
                    // Ensure any stale dark class removed
                    document.documentElement.classList.remove('darkmode');
                }
            } catch (e) { /* ignore */ }
        })();
    </script>
    <script>
        // Early sidebar collapse application to avoid flash of expanded sidebar
        (function(){
            try {
                if(localStorage.getItem('sidebar-collapsed') === 'true') {
                    document.documentElement.classList.add('prefers-sidebar-collapsed');
                }
            } catch(e) {/* ignore */}
        })();
    </script>
    {% if USE_TAILWIND_CDN %}
      <script src="https://cdn.tailwindcss.com"></script>
    {% else %}
      <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
    {% endif %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --bg-body: #f8fafc;
            --text-color: #111827;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            /* SIDEBAR COLORS (Light/Default) - These are the "Pic 1" colors */
            --sidebar-bg: #1e40af;
            --sidebar-link: #dbeafe;
            --sidebar-link-hover-bg: #3b82f6;
            --sidebar-link-active-border: #ffffff;
            --link-color: #1d4ed8;
            --link-hover-color: #1e3a8a;
            --input-bg: #ffffff;
            --input-text: #111827;
            --input-border: #cbd5e1;
            --table-striped-bg: #f1f5f9;
            --dropdown-bg: #ffffff;
            --dropdown-link: #111827;
            --nav-tabs-border: #cbd5e1;
            --nav-tabs-link-hover-bg: #f1f5f9;
            --nav-tabs-link-active-bg: #ffffff;
            --nav-tabs-link-active-color: #111827;
            --sidebar-expanded: 200px; /* updated for demo integration */
            --sidebar-collapsed: 78px;  /* collapsed width updated from 70px */
            --nav-item-padding-y: 0.9rem; /* increased from 0.65rem */
            --nav-item-min-height: 48px;   /* ensure enough vertical space */
            --sidebar-font-size: 1.05rem; /* slightly enlarged sidebar text */
            /* segmented sidebar colors */
            --sidebar-icon-color: #ffffff; /* strong icon */
            --sidebar-text-color: var(--sidebar-link); /* lighter label */
        }
        body.dark-mode,
        html.darkmode body {
            --bg-body: #0f172a;
            --text-color: #ffffff;
            --card-bg: #1e3a5f;
            --border-color: #334155;
            
            /* SIDEBAR COLORS FIXED: Forced to match Light Mode (Pic 1) style */
            --sidebar-bg: #1e40af;           /* Was #0f2749 */
            --sidebar-link: #dbeafe;         /* Was #93c5fd */
            --sidebar-link-hover-bg: #3b82f6;/* Was #1d4ed8 */
            --sidebar-link-active-border: #ffffff; /* Was #fbbf24 */
            
            --link-color: #60a5fa;
            --link-hover-color: #bfdbfe;
            --input-bg: #1e3a5f;
            --input-text: #ffffff;
            --input-border: #475569;
            --table-striped-bg: #1e3a5f;
            --dropdown-bg: #1e3a5f;
            --dropdown-link: #ffffff;
            --nav-tabs-border: #334155;
            --nav-tabs-link-hover-bg: #1e3a5f;
            --nav-tabs-link-active-bg: #1e3a5f;
            --nav-tabs-link-active-color: #ffffff;
            /* segmented sidebar colors (dark) - Reset to match light mode */
            --sidebar-icon-color: #ffffff;
            --sidebar-text-color: var(--sidebar-link);
        }
        body { background-color: var(--bg-body); color: var(--text-color); }
        body.theme-transition { transition: background-color .3s, color .3s; }
        a { color: var(--link-color); }
        a:hover { color: var(--link-hover-color); }
        .sidebar { 
            background: var(--sidebar-bg); 
            width: var(--sidebar-expanded); 
            min-height: 100vh; 
            position: fixed; 
            top: 0; 
            left: 0; 
            /* Increased Z-Index to ensure it stays above overlay content on desktop */
            z-index: 1040; 
            display: flex; 
            flex-direction: column; 
            max-height: 100vh; 
            overflow-y: auto; 
            transition: width .3s ease; 
        }
        .sidebar.collapsed { width: var(--sidebar-collapsed); overflow-y: hidden; }
        body.no-sidebar .sidebar { display: none; }
        .main-content { margin-left: var(--sidebar-expanded); padding: 2rem 1rem 1rem 1rem; transition: margin-left .3s ease; }
        .main-content.collapsed { margin-left: var(--sidebar-collapsed); }
        body.no-sidebar .main-content { margin-left: 0; }

        .sidebar nav { padding-top: .25rem; }
        .sidebar .nav-link { /* updated vertical sizing */
            display: flex;
            align-items: center;
            gap: .85rem;
            padding: var(--nav-item-padding-y) 1rem;
            min-height: var(--nav-item-min-height);
            position: relative;
            line-height: 1.2;
            overflow: hidden;
            color: var(--sidebar-icon-color); /* base/icon color */
            font-size: var(--sidebar-font-size);
        }
        .sidebar .nav-link i { min-width: 20px; text-align: center; color: var(--sidebar-icon-color); }
        .sidebar .nav-link .link-text { display: inline-block; white-space: nowrap; max-width: 140px; overflow: hidden; opacity: 1; transition: max-width .28s ease, opacity .2s ease; color: var(--sidebar-text-color); }
        .sidebar .nav-link.active, .sidebar .nav-link:hover { background: var(--sidebar-link-hover-bg); border-left: 3px solid var(--sidebar-link-active-border); }
        .sidebar.collapsed .nav-link { /* keep same vertical padding when collapsed */
            justify-content: center;
            gap: 0;
            padding: var(--nav-item-padding-y) 0;
            min-height: var(--nav-item-min-height);
        }
        .sidebar.collapsed .nav-link .link-text { max-width: 0; opacity: 0; }

        #sidebar-toggle { 
            height: 60px; 
            background: none; 
            border: 0; 
            color: #fff; 
            font-size: var(--sidebar-font-size); 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: .65rem 1rem; 
            /* Force pointer events to ensure it receives clicks */
            cursor: pointer !important; 
            pointer-events: auto !important;
            text-align: left; 
            overflow: hidden;
            /* Fix for clickable area on desktop - High Z-Index */
            position: relative;
            z-index: 1050;
        }
        #sidebar-toggle i { min-width: 20px; text-align: center; color: #fff; }
        #sidebar-toggle .toggle-text { display: none; } /* Hide any text, show only icon */
        #sidebar-toggle:hover { background: var(--sidebar-link-hover-bg); color: #fff; }
        .sidebar.collapsed #sidebar-toggle { height: 60px; justify-content: center; gap: 0; padding: .65rem 0; }

        .sidebar__spacer { flex: 1 1 auto; }
        .profile-block { position: relative; padding: 1rem; display: flex; align-items: center; }
        .profile-trigger { display: flex; align-items: center; gap: .8rem; width: 100%; background: none; border: 0; color: #fff; cursor: pointer; border-radius: 6px; padding: 4px; text-align: left; min-height: var(--nav-item-min-height); font-size: var(--sidebar-font-size); }
        .profile-trigger:hover { background: rgba(255, 255, 255, .1); }
        .profile-avatar { width: 48px !important; height: 48px !important; border-radius: 50%; background: #3b82f6; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem; overflow: hidden; flex-shrink: 0; }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .profile-text { display: flex; flex-direction: column; overflow: hidden; }
        .profile-text .user-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--sidebar-text-color); }
        .profile-text .superadmin-badge { font-size: 0.65rem; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
        .sidebar.collapsed .profile-block { padding: .75rem 0 .9rem; justify-content: center; }
        .sidebar.collapsed .profile-trigger { justify-content: center; width: auto; }
        .sidebar.collapsed .profile-text { max-width: 0; opacity: 0; }

        /* Floating profile menu (detached from sidebar) */
        .profile-menu { position: fixed; top:0; left:0; opacity:0; visibility:hidden; transform:translateY(4px); transition:opacity .18s ease, transform .18s ease, visibility .18s; background: var(--card-bg); color: var(--text-color); border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.18); padding:.5rem 0; width:220px; list-style:none; margin:0; z-index:1060; }
        .profile-menu.open { opacity:1; visibility:visible; transform:translateY(0); }
        .profile-menu button, .profile-menu a { display:flex; align-items:center; gap:.65rem; width:100%; background:none; border:0; padding:.55rem 1rem; text-align:left; text-decoration:none; font-size:.9rem; color:inherit; cursor:pointer; }
        .profile-menu button:hover, .profile-menu a:hover { background: var(--nav-tabs-link-hover-bg, #f1f5f9); }
        .profile-menu .logout { color:#ef4444; }
        body.dark-mode .profile-menu { background:var(--card-bg); color:var(--text-color); }
        /* Make profile/logout menu solid white on the trainer portal (override dark-mode transparency) */
        body.trainer-page .profile-menu,
        html.darkmode body.trainer-page .profile-menu,
        body.dark-mode.trainer-page .profile-menu {
            background: #ffffff !important;
            color: #111827 !important;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12) !important;
        }
        body.trainer-page .profile-menu button, body.trainer-page .profile-menu a { color: inherit; }
        body.trainer-page .profile-menu button:hover, body.trainer-page .profile-menu a:hover { background: #f1f5f9 !important; }
        /* Force logout text/icon to red even where trainer-page overrides color */
        .profile-menu .logout { color: #ef4444 !important; }
        body.trainer-page .profile-menu .logout { color: #ef4444 !important; }
        /* Ensure the icon inside logout is explicitly red (for some icon/font setups) */
        .profile-menu .logout i, body.trainer-page .profile-menu .logout i { color: #ef4444 !important; }
        @media (max-width:768px){
            .profile-menu { left:50% !important; top:auto !important; bottom: env(safe-area-inset-bottom, 16px); transform:translate(-50%,4px); width: min(260px,90vw); }
            .profile-menu.open { transform:translate(-50%,0); }
        }

        body.dark-mode .bg-white, html.darkmode body .bg-white { background-color: var(--card-bg)!important; color: var(--text-color)!important; }
        body.dark-mode .bg-light, html.darkmode body .bg-light { background-color: var(--card-bg)!important; color: var(--text-color)!important; }
        body.dark-mode .text-dark, html.darkmode body .text-dark { color: var(--text-color)!important; }
        body.dark-mode .card, html.darkmode body .card { background-color: var(--card-bg)!important; color: var(--text-color)!important; }
        body.dark-mode .card-header.bg-white, html.darkmode body .card-header.bg-white { background-color: var(--card-bg)!important; color: var(--text-color)!important; }
        body.dark-mode .card-footer.bg-white, html.darkmode body .card-footer.bg-white { background-color: var(--card-bg)!important; color: var(--text-color)!important; }
        body.dark-mode .card-body, html.darkmode body .card-body { color: var(--text-color)!important; }
        body.dark-mode .table, html.darkmode body .table { background-color: var(--card-bg); --bs-table-bg: var(--card-bg); }
        body.dark-mode .table thead, html.darkmode body .table thead { background-color: var(--card-bg); }
        body.dark-mode .table-hover tbody tr:hover > * , html.darkmode body .table-hover tbody tr:hover > * { --bs-table-accent-bg: #24324a; color: var(--text-color); }
        body.dark-mode .table-striped > tbody > tr:nth-of-type(odd) > * , html.darkmode body .table-striped > tbody > tr:nth-of-type(odd) > * { --bs-table-accent-bg: #1b2535; color: var(--text-color); }
        body.dark-mode .table-striped > tbody > tr:nth-of-type(even) > * , html.darkmode body .table-striped > tbody > tr:nth-of-type(even) > * { --bs-table-accent-bg: var(--card-bg)!important; }
        body.dark-mode .dropdown-menu.bg-white, html.darkmode body .dropdown-menu.bg-white { background-color: var(--dropdown-bg)!important; }
        body.dark-mode .border, html.darkmode body .border { border-color: var(--border-color)!important; }
        body.dark-mode .shadow, html.darkmode body .shadow { box-shadow: 0 2px 6px rgba(0,0,0,0.6)!important; }
        body.dark-mode .text-muted, html.darkmode body .text-muted { color: #cbd5e1!important; }
        body.dark-mode .text-gray-700, html.darkmode body .text-gray-700 { color: #ffffff!important; }
        body.dark-mode .text-gray-800, html.darkmode body .text-gray-800 { color: #ffffff!important; }
        body.dark-mode .text-gray-900, html.darkmode body .text-gray-900 { color: #ffffff!important; }
        body.dark-mode .text-gray-600, html.darkmode body .text-gray-600 { color: #e5e7eb!important; }
        body.dark-mode .text-gray-500, html.darkmode body .text-gray-500 { color: #d1d5db!important; }
        body.dark-mode .text-blue-900, html.darkmode body .text-blue-900 { color: #93c5fd!important; }
        body.dark-mode .text-blue-700, html.darkmode body .text-blue-700 { color: #60a5fa!important; }
        body.dark-mode .text-blue-600, html.darkmode body .text-blue-600 { color: #60a5fa!important; }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4, body.dark-mode h5, body.dark-mode h6,
        html.darkmode body h1, html.darkmode body h2, html.darkmode body h3, html.darkmode body h4, html.darkmode body h5, html.darkmode body h6 {
            color: #ffffff!important;
        }
        body.dark-mode .table-dark, html.darkmode body .table-dark { background-color:#24324a; }
        body.dark-mode .table-dark th, body.dark-mode .table-dark td, html.darkmode body .table-dark th, html.darkmode body .table-dark td { border-color: #334155; }
        body.dark-mode .btn-light, html.darkmode body .btn-light { background-color: #334155; color: #f1f5f9; border-color: #475569; }
        body.dark-mode .btn-outline-secondary, html.darkmode body .btn-outline-secondary { color: #f1f5f9; border-color: #64748b; }
        body.dark-mode .btn-outline-secondary:hover, html.darkmode body .btn-outline-secondary:hover { background:#475569; }
        body.dark-mode .form-text, html.darkmode body .form-text { color:#94a3b8!important; }
        body.dark-mode .bg-body, html.darkmode body .bg-body { background-color: var(--bg-body)!important; }
        body.dark-mode .modal-content.bg-white, html.darkmode body .modal-content.bg-white {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
        }
        body.dark-mode .modal-content, html.darkmode body .modal-content {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
        }
        body.dark-mode .modal-header, html.darkmode body .modal-header {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
            border-color: var(--border-color)!important;
        }
        body.dark-mode .modal-body, html.darkmode body .modal-body {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
        }
        body.dark-mode .modal-footer, html.darkmode body .modal-footer {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
            border-color: var(--border-color)!important;
        }
        body.dark-mode .modal-title, html.darkmode body .modal-title {
            color: #ffffff!important;
        }
        body.dark-mode .text-secondary, html.darkmode body .text-secondary { color: #cbd5e1!important; }
        body.dark-mode .text-body, html.darkmode body .text-body { color: var(--text-color)!important; }
        body.dark-mode .text-body-secondary, html.darkmode body .text-body-secondary { color:#94a3b8!important; }
        body.dark-mode .table>:not(caption)>*>* , html.darkmode body .table>:not(caption)>*>* { background-color: var(--card-bg)!important; box-shadow: inset 0 0 0 9999px transparent; }
        body.dark-mode .table-striped > tbody > tr:nth-of-type(odd) > * , html.darkmode body .table-striped > tbody > tr:nth-of-type(odd) > * { background-color:#223047!important; }
        body.dark-mode .table-striped > tbody > tr:nth-of-type(even) > * , html.darkmode body .table-striped > tbody > tr:nth-of-type(even) > * { background-color: var(--card-bg)!important; }
        body.dark-mode .table-hover>tbody>tr:hover>* , html.darkmode body .table-hover>tbody>tr:hover>* { background-color:#2d405c!important; }
        body.dark-mode, html.darkmode body {
            --bs-body-bg: var(--bg-body);
            --bs-body-color: var(--text-color);
            --bs-card-bg: var(--card-bg);
            --bs-card-color: var(--text-color);
            --bs-table-color: var(--text-color);
            --bs-table-bg: var(--card-bg);
            --bs-dropdown-bg: var(--dropdown-bg);
            --bs-dropdown-color: var(--dropdown-link);
        }
        body.dark-mode .card, html.darkmode body .card {
            color: var(--text-color);
            background-color: var(--card-bg)!important;
        }
        body.dark-mode .card-header, html.darkmode body .card-header {
            background: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        body.dark-mode .card-body, html.darkmode body .card-body {
            color: var(--text-color);
            background-color: var(--card-bg);
        }
        body.dark-mode .card h1, body.dark-mode .card h2, body.dark-mode .card h3, body.dark-mode .card h4, body.dark-mode .card h5, body.dark-mode .card h6,
        html.darkmode body .card h1, html.darkmode body .card h2, html.darkmode body .card h3, html.darkmode body .card h4, html.darkmode body .card h5, html.darkmode body .card h6 {
            color: #ffffff!important;
        }
        body.dark-mode .card p, body.dark-mode .card span, body.dark-mode .card div,
        html.darkmode body .card p, html.darkmode body .card span, html.darkmode body .card div {
            color: #ffffff;
        }
        body.dark-mode .table thead th:not(.bg-white):not(.table-dark), html.darkmode body .table thead th:not(.bg-white):not(.table-dark) {
            background: var(--card-bg);
            color: var(--text-color);
        }
        /* Form elements */
        body.dark-mode label, html.darkmode body label {
            color: #e5e7eb!important;
        }
        body.dark-mode .form-control, html.darkmode body .form-control {
            background-color: var(--input-bg)!important;
            color: var(--input-text)!important;
            border-color: var(--input-border)!important;
        }
        body.dark-mode .form-select, html.darkmode body .form-select {
            background-color: var(--input-bg)!important;
            color: var(--input-text)!important;
            border-color: var(--input-border)!important;
        }
        body.dark-mode input, html.darkmode body input {
            background-color: var(--input-bg)!important;
            color: var(--input-text)!important;
            border-color: var(--input-border)!important;
        }
        body.dark-mode textarea, html.darkmode body textarea {
            background-color: var(--input-bg)!important;
            color: var(--input-text)!important;
            border-color: var(--input-border)!important;
        }
        body.dark-mode select, html.darkmode body select {
            background-color: var(--input-bg)!important;
            color: var(--input-text)!important;
            border-color: var(--input-border)!important;
        }
        /* List groups */
        body.dark-mode .list-group-item, html.darkmode body .list-group-item {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
            border-color: var(--border-color)!important;
        }
        /* Alerts */
        .alert-dismissible {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            padding-right: 3rem !important;
        }
        .alert-dismissible .btn-close {
            position: absolute !important;
            right: 1rem !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            padding: 0.5rem !important;
            margin: 0 !important;
        }
        body.dark-mode .alert, html.darkmode body .alert {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
            border-color: var(--border-color)!important;
        }
        /* Badges with proper contrast */
        body.dark-mode .badge.bg-secondary, html.darkmode body .badge.bg-secondary {
            background-color: #475569!important;
            color: #ffffff!important;
        }
        /* Breadcrumbs */
        body.dark-mode .breadcrumb, html.darkmode body .breadcrumb {
            background-color: var(--card-bg)!important;
        }
        body.dark-mode .breadcrumb-item, html.darkmode body .breadcrumb-item {
            color: var(--text-color)!important;
        }
        /* Progress bars */
        body.dark-mode .progress, html.darkmode body .progress {
            background-color: #334155!important;
        }
        /* Nav tabs */
        body.dark-mode .nav-tabs, html.darkmode body .nav-tabs {
            border-color: var(--border-color)!important;
        }
        body.dark-mode .nav-tabs .nav-link, html.darkmode body .nav-tabs .nav-link {
            color: var(--text-color)!important;
        }
        body.dark-mode .nav-tabs .nav-link.active, html.darkmode body .nav-tabs .nav-link.active {
            background-color: var(--card-bg)!important;
            color: #ffffff!important;
            border-color: var(--border-color)!important;
        }
        /* Pagination */
        body.dark-mode .pagination .page-link, html.darkmode body .pagination .page-link {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
            border-color: var(--border-color)!important;
        }
        body.dark-mode .pagination .page-item.active .page-link, html.darkmode body .pagination .page-item.active .page-link {
            background-color: #3b82f6!important;
            border-color: #3b82f6!important;
        }
        /* Accordion */
        body.dark-mode .accordion-item, html.darkmode body .accordion-item {
            background-color: var(--card-bg)!important;
            border-color: var(--border-color)!important;
        }
        body.dark-mode .accordion-button, html.darkmode body .accordion-button {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
        }
        body.dark-mode .accordion-body, html.darkmode body .accordion-body {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
        }
        /* Offcanvas */
        body.dark-mode .offcanvas, html.darkmode body .offcanvas {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
        }
        /* Toast */
        body.dark-mode .toast, html.darkmode body .toast {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
        }
        /* Popover */
        body.dark-mode .popover, html.darkmode body .popover {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
        }
        /* Tooltip */
        body.dark-mode .tooltip-inner, html.darkmode body .tooltip-inner {
            background-color: var(--card-bg)!important;
            color: var(--text-color)!important;
        }
        .sidebar.collapsed .user-avatar { margin-right:0; }
        .sidebar.collapsed .nav-link .link-text { opacity:0; width:0; overflow:hidden; }
        @media (prefers-reduced-motion: reduce) {
            .user-details, .sidebar .nav-link .link-text { transition:none; }
        }
        /* Pre-paint collapsed state (removed after JS initializes) */
        html.prefers-sidebar-collapsed body:not(.no-sidebar) .sidebar { width: var(--sidebar-collapsed); overflow-y:hidden; }
        html.prefers-sidebar-collapsed body:not(.no-sidebar) .main-content { margin-left: var(--sidebar-collapsed); }
        html.prefers-sidebar-collapsed body:not(.no-sidebar) .sidebar .nav-link { justify-content:center; gap:0; padding: var(--nav-item-padding-y) 0; }
        html.prefers-sidebar-collapsed body:not(.no-sidebar) .sidebar .nav-link .link-text { max-width:0; opacity:0; }
        html.prefers-sidebar-collapsed body:not(.no-sidebar) .sidebar .profile-block { padding:.75rem 0 .9rem; justify-content:center; }
        html.prefers-sidebar-collapsed body:not(.no-sidebar) .sidebar .profile-trigger { justify-content:center; width:auto; }
        html.prefers-sidebar-collapsed body:not(.no-sidebar) .sidebar .profile-text { max-width:0; opacity:0; }

        /* Module card styles moved to static CSS for reuse */
        /* module_cards.css provides .module-card-rounded and .module-inner-panel-blue */
        /* load module card stylesheet */

        /* Removed hiding of sidebar items on agency page so user links remain visible. */
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/module_cards.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive-tables.css') }}">
    <script src="{{ url_for('static', filename='table_pagination.js') }}" defer></script>
    <script src="{{ url_for('static', filename='responsiveTable.js') }}" defer></script>
    <script src="{{ url_for('static', filename='modal_utils.js') }}"></script>
    {% block styles %}{% endblock %}
</head>
<body class="{% if request.endpoint in ['index','main.login','main.signup','main.onboarding','main.module_quiz'] %}no-sidebar{% endif %}{% if request.endpoint == 'main.agency' %} agency-page{% endif %}{% if request.endpoint == 'main.trainer_portal' %} trainer-page{% endif %}">
    {% if request.endpoint not in ['index','main.login','main.signup','main.onboarding'] %}
    <div class="sidebar" id="sidebar" aria-label="Main Sidebar">
        <button id="sidebar-toggle" aria-expanded="true" aria-controls="sidebar" type="button">
            <i class="fas fa-bars"></i><span class="link-text"></span>
        </button>
        <nav class="nav flex-column" aria-label="Primary Navigation">
            {% if current_user.is_authenticated and current_user.__class__.__name__ == 'Trainer' %}
                <a class="nav-link {% if request.endpoint=='main.trainer_portal' and request.view_args.get('section') == 'dashboard' %}active{% endif %}" href="{{ url_for('main.trainer_portal', section='dashboard') }}"><i class="fas fa-gauge"></i><span class="link-text">Dashboard</span></a>
                <a class="nav-link {% if request.endpoint=='main.trainer_course_management' %}active{% endif %}" href="{{ url_for('main.trainer_course_management') }}"><i class="fas fa-layer-group"></i><span class="link-text">Course Management</span></a>
                <a class="nav-link {% if request.endpoint=='main.trainer_portal' and request.view_args.get('section') == 'progress' %}active{% endif %}" href="{{ url_for('main.trainer_portal', section='progress') }}"><i class="fas fa-chart-line"></i><span class="link-text">Trainee Progress</span></a>
            {% elif current_user.is_authenticated and current_user.__class__.__name__ == 'AgencyAccount' %}
                <a class="nav-link {% if request.endpoint=='main.agency_portal' %}active{% endif %}" href="{{ url_for('main.agency_portal') }}"><i class="fas fa-gauge"></i><span class="link-text">Dashboard</span></a>
                <a class="nav-link {% if request.endpoint=='main.agency_progress_monitor' %}active{% endif %}" href="{{ url_for('main.agency_progress_monitor') }}"><i class="fas fa-chart-line"></i><span class="link-text">Progress Monitor</span></a>
                <a class="nav-link {% if request.endpoint=='main.agency' %}active{% endif %}" href="{{ url_for('main.agency') }}"><i class="fas fa-building"></i><span class="link-text">Agency</span></a>
            {% elif current_user.is_authenticated and current_user.__class__.__name__ != 'Admin' %}
                <a class="nav-link {% if request.endpoint=='main.user_dashboard' %}active{% endif %}" href="{{ safe_url_for('main.user_dashboard') }}"><i class="fas fa-gauge"></i><span class="link-text">Dashboard</span></a>
                <a class="nav-link {% if request.endpoint=='main.profile' %}active{% endif %}" href="{{ url_for('main.profile') }}"><i class="fas fa-user"></i><span class="link-text">My Profile</span></a>

                {% if (current_user.role | default('')) == 'authority' %}
                    <a class="nav-link {% if request.endpoint == 'authority.authority_portal' %}active{% endif %}" href="{{ url_for('authority.authority_portal') }}"><i class="fas fa-certificate"></i><span class="link-text">Certificates</span></a>
                {% else %}
                    {% if (current_user.role | default('')) != 'authority' %}
                        <a class="nav-link {% if request.endpoint=='main.courses' %}active{% endif %}" href="{{ url_for('main.courses') }}"><i class="fas fa-layer-group"></i><span class="link-text">Courses</span></a>
                        <a class="nav-link {% if request.endpoint=='main.my_certificates' %}active{% endif %}" href="{{ url_for('main.my_certificates') }}"><i class="fas fa-certificate"></i><span class="link-text">Certificates</span></a>
                        <a class="nav-link {% if request.endpoint=='main.agency' %}active{% endif %}" href="{{ url_for('main.agency') }}"><i class="fas fa-building"></i><span class="link-text">Agency</span></a>
                    {% endif %}
                {% endif %}
            {% elif current_user.is_authenticated and current_user.__class__.__name__ == 'Admin' %}
                <a class="nav-link {% if request.endpoint=='main.admin_dashboard' %}active{% endif %}" href="{{ url_for('main.admin_dashboard') }}"><i class="fas fa-gauge"></i><span class="link-text">Dashboard</span></a>
                <a class="nav-link {% if request.endpoint=='main.admin_users' %}active{% endif %}" href="{{ url_for('main.admin_users') }}"><i class="fas fa-user-gear"></i><span class="link-text">Account</span></a>
                <a class="nav-link {% if request.endpoint=='main.admin_course_management' %}active{% endif %}" href="{{ url_for('main.admin_course_management') }}"><i class="fas fa-layer-group"></i><span class="link-text">Course</span></a>
                <a class="nav-link {% if request.endpoint=='main.admin_certificates' %}active{% endif %}" href="{{ url_for('main.admin_certificates') }}"><i class="fas fa-certificate"></i><span class="link-text">Certificates</span></a>
                <a class="nav-link {% if request.endpoint=='main.monitor_progress' %}active{% endif %}" href="{{ url_for('main.monitor_progress') }}"><i class="fas fa-chart-line"></i><span class="link-text">Progress</span></a>
                <a class="nav-link {% if request.endpoint=='main.admin_agencies' %}active{% endif %}" href="{{ url_for('main.admin_agencies') }}"><i class="fas fa-building"></i><span class="link-text">Agency</span></a>
            {% else %}
                <a class="nav-link {% if request.endpoint=='main.login' %}active{% endif %}" href="{{ url_for('main.login') }}"><i class="fas fa-sign-in-alt"></i><span class="link-text">Login</span></a>
                <a class="nav-link {% if request.endpoint=='main.signup' %}active{% endif %}" href="{{ url_for('main.signup') }}"><i class="fas fa-user-plus"></i><span class="link-text">Sign Up</span></a>
            {% endif %}
        </nav>
        <div class="sidebar__spacer"></div>
        {% if current_user.is_authenticated %}
        <div class="profile-block" id="profileBlock">
            <button class="profile-trigger" id="profileTrigger" aria-haspopup="true" aria-expanded="false" aria-controls="profileMenu">
                <span class="profile-avatar">
                    {% if current_user.profile_pic %}
                        <img src="{{ current_user.profile_pic_url }}" alt="User avatar">
                    {% else %}
                        {{ current_user.username[0]|upper }}
                    {% endif %}
                </span>
                <span class="profile-text">
                    <span class="user-name link-text">{{ current_user.username }}</span>
                    {% if is_superadmin() %}
                    <span class="superadmin-badge">Superadmin</span>
                    {% endif %}
                </span>
            </button>
        </div>
        {% endif %}
    </div>
    {% endif %}
    <!-- Floating profile menu placed once at root -->
    {% if current_user.is_authenticated %}
    <ul class="profile-menu" id="profileMenu" role="menu" aria-label="User menu">
        <li role="presentation">
            <button id="darkmode-toggle" type="button" role="menuitem" class="d-flex align-items-center gap-2"><i class="fas fa-moon" id="darkmode-icon"></i><span>Dark Mode</span></button>
        </li>
        <li role="presentation">
            <a href="{{ url_for('main.change_password') }}" role="menuitem" class="d-flex align-items-center gap-2" style="color: inherit; text-decoration: none; padding: 0.5rem 1rem; display: flex;"><i class="fas fa-key"></i><span>Change Password</span></a>
        </li>
        <li role="presentation">
            <form action="{{ url_for('main.logout') }}" method="post" class="m-0" role="none">
                <button class="logout d-flex align-items-center gap-2" type="submit" role="menuitem"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button>
            </form>
        </li>
    </ul>
    {% endif %}
    <div class="main-content{% if request.endpoint == 'index' %} w-100 m-0 p-0{% endif %}" id="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            const ALWAYS_LIGHT = {{ 'true' if always_light else 'false' }};
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const darkToggleBtn = document.getElementById('darkmode-toggle');
            const darkToggleIcon = document.getElementById('darkmode-icon');
            const profileBlock = document.getElementById('profileBlock');
            const profileTrigger = document.getElementById('profileTrigger');
            const profileMenu = document.getElementById('profileMenu');

            function applyTheme(theme) {
                if (theme === 'dark' && !ALWAYS_LIGHT) {
                    document.body.classList.add('dark-mode');
                    if (darkToggleIcon) { darkToggleIcon.classList.remove('fa-moon'); darkToggleIcon.classList.add('fa-sun', 'dark-mode-indicator-active'); }
                } else {
                    document.body.classList.remove('dark-mode');
                    document.documentElement.classList.remove('darkmode');
                    if (darkToggleIcon) { darkToggleIcon.classList.remove('fa-sun', 'dark-mode-indicator-active'); darkToggleIcon.classList.add('fa-moon'); }
                }
            }

            const saved = localStorage.getItem('theme-preference');
            const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (ALWAYS_LIGHT) { applyTheme('light'); } else { applyTheme(saved || (prefers ? 'dark' : 'light')); }
            requestAnimationFrame(() => document.body.classList.add('theme-transition'));

            if (darkToggleBtn && !ALWAYS_LIGHT) {
                darkToggleBtn.addEventListener('click', () => {
                    const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
                    applyTheme(newTheme);
                    localStorage.setItem('theme-preference', newTheme);
                    if (newTheme === 'dark') document.documentElement.classList.add('darkmode'); else document.documentElement.classList.remove('darkmode');
                    
                    // Save to database
                    fetch('{{ url_for("main.api_save_theme_preference") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            dark_mode: newTheme === 'dark'
                        })
                    }).catch(err => console.error('Failed to save theme preference:', err));
                });
            } else if (darkToggleBtn && ALWAYS_LIGHT) {
                darkToggleBtn.disabled = true;
                darkToggleBtn.classList.add('disabled');
            }

            if (sidebar && mainContent) {
                if (localStorage.getItem('sidebar-collapsed') === 'true') {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('collapsed');
                }
                // Remove pre-paint helper class now that real classes are applied
                document.documentElement.classList.remove('prefers-sidebar-collapsed');
                
                const toggleBtn = document.getElementById('sidebar-toggle');
                if(toggleBtn) toggleBtn.setAttribute('aria-expanded', !sidebar.classList.contains('collapsed'));
            } else {
                // Ensure helper removed even if sidebar absent
                document.documentElement.classList.remove('prefers-sidebar-collapsed');
            }

            // Aggressive Event handling for sidebar toggle
            // Use capturing phase (true) to intercept click before bubbling up, 
            // and stop propagation to prevent conflicting scripts (like responsive.js) from overriding.
            const toggleBtnDirect = document.getElementById('sidebar-toggle');
            if(toggleBtnDirect) {
                toggleBtnDirect.addEventListener('click', function(event) {
                    // Stop other scripts (like responsive.js) from interfering
                    event.stopPropagation();
                    // If external scripts use the same listener, try to prevent them
                    // (Note: stopImmediatePropagation works if this listener is attached FIRST. 
                    // Since this script runs before responsive.js, it should block responsive.js listeners if they are attached later.)
                    if(event.stopImmediatePropagation) event.stopImmediatePropagation(); 

                    const sidebar = document.getElementById('sidebar');
                    const mainContent = document.getElementById('main-content');
                    
                    if (sidebar && mainContent) {
                        sidebar.classList.toggle('collapsed');
                        mainContent.classList.toggle('collapsed');
                        
                        // Force layout update logic
                        const isCollapsed = sidebar.classList.contains('collapsed');
                        localStorage.setItem('sidebar-collapsed', isCollapsed);
                        this.setAttribute('aria-expanded', !isCollapsed);
                    }
                }, true); // Use capture phase
            }

            function closeMenu(){ if(profileMenu){ profileMenu.classList.remove('open'); if(profileTrigger) profileTrigger.setAttribute('aria-expanded','false'); } }
            function positionMenu(){
                if(!profileTrigger || !profileMenu || !sidebar) return;
                if(window.matchMedia('(max-width:768px)').matches){
                    // mobile bottom sheet style handled by CSS
                    return;
                }
                const triggerRect = profileTrigger.getBoundingClientRect();
                const sidebarRect = sidebar.getBoundingClientRect();
                const gap = 8;
                // Place to right of sidebar
                const left = sidebarRect.right + gap;
                // Align vertically centered to trigger
                const menuHeight = profileMenu.offsetHeight || 0;
                let top = triggerRect.top + (triggerRect.height/2) - (menuHeight/2);
                // Clamp within viewport
                const margin = 12;
                if(top < margin) top = margin;
                const maxTop = window.innerHeight - menuHeight - margin;
                if(top > maxTop) top = maxTop;
                profileMenu.style.left = left + 'px';
                profileMenu.style.top = top + 'px';
            }
            if(profileTrigger && profileMenu){
                profileTrigger.addEventListener('click', (e)=>{
                    e.stopPropagation();
                    const opening = !profileMenu.classList.contains('open');
                    closeMenu();
                    if(opening){
                        profileMenu.classList.add('open');
                        profileTrigger.setAttribute('aria-expanded','true');
                        // Wait next frame so menu has dimensions
                        requestAnimationFrame(()=>{ positionMenu(); });
                    }
                });
                window.addEventListener('resize', ()=>{ if(profileMenu.classList.contains('open')) positionMenu(); });
                window.addEventListener('scroll', ()=>{ if(profileMenu.classList.contains('open')) positionMenu(); }, { passive:true });
                document.addEventListener('click', (e)=>{ if(profileMenu.classList.contains('open') && !profileMenu.contains(e.target)) closeMenu(); });
                document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });
            }
        });
    </script>
    <script src="{{ url_for('static', filename='responsive.js') }}?v=20251117"></script>
    {% block scripts %}{% endblock %}
</body>
</html>