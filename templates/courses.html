{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4">
  <h2 class="text-2xl font-bold mb-6 text-blue-900">Courses</h2>
  <div class="flex flex-row gap-8 justify-center flex-wrap">
    {% for course in course_progress %}
      {# Defensive: skip rendering if course not allowed for this user (in case backend broadens list later) #}
      {% if course.allowed_category == 'both' or course.allowed_category == user_category %}
      <div class="max-w-md w-[350px] rounded-xl shadow-md overflow-hidden bg-white border border-gray-200 flex flex-col">
        <div class="h-24 bg-[url('/pattern.svg')] bg-cover bg-center"></div>
        <div class="p-4 flex flex-col flex-1">
          <h2 class="text-blue-700 font-semibold text-lg mb-1">
            {{ course.name }}
          </h2>
          {% if course.percent == 100 %}
          <p class="text-xs mb-3 text-gray-600">Overall Score:
            <span class="font-semibold {% if course.overall_percentage < 50 %}text-red-600{% elif course.overall_percentage > 75 %}text-green-600{% else %}text-blue-600{% endif %}">{{ course.overall_percentage }}%</span>
          </p>
          {% endif %}
          <div class="flex items-center justify-between mb-4">
            <div style="width: 66.66%; background-color: #e5e7eb; border-radius: 9999px; height: 10px;">
              <div style="background-color: #3b82f6; height: 100%; border-radius: 9999px; width: {{ course.percent }}%; transition: width 0.5s;"></div>
            </div>
            <div class="ml-2 text-xs text-gray-600 whitespace-nowrap">{{ course.percent }}% complete</div>
          </div>
          <a href="/modules/{{ course.code }}" class="block w-full text-center border border-blue-700 bg-white text-blue-700 hover:bg-blue-700 hover:text-white font-semibold py-2 rounded-lg transition mb-2">Access Course</a>
          <button class="block w-full text-center border border-green-700 bg-green-700 text-white font-semibold py-2 rounded-lg transition mb-2 {% if course.percent < 100 %}opacity-50 cursor-not-allowed{% endif %}" onclick="if({{ course.percent }} === 100){completeCourse('{{ course.code }}')}" {% if course.percent < 100 %}disabled{% endif %}>Complete Course</button>
          {% if course.percent == 100 and course.overall_percentage < 50 %}
          <button class="block w-full text-center border border-yellow-600 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 rounded-lg transition" onclick="reattemptCourse('{{ course.code }}')" title="Overall score below 50% - you can reattempt">Reattempt Course</button>
          {% endif %}
        </div>
      </div>
      {% endif %}
    {% endfor %}
    {% if course_progress|length == 0 %}
      <div class="text-gray-600">No courses available for your category.</div>
    {% endif %}
  </div>
</div>
<script>
function completeCourse(courseCode) {
  fetch('/api/complete_course', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ course_code: courseCode })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert('Course completed! Certificate processed.');
      location.reload();
    } else {
      alert('Error: ' + (data.message || 'Could not complete course.'));
    }
  });
}
function reattemptCourse(courseCode){
  if(!confirm('Reattempt will reset all module progress for this course. Continue?')) return;
  fetch('/api/reattempt_course/' + courseCode, {method:'POST', headers:{'Content-Type':'application/json'}})
    .then(r=>r.json())
    .then(d=>{ if(d.success){ alert('Course reset. You can start again.'); location.reload(); } else { alert('Reattempt failed: ' + (d.message||'Unknown error')); } });
}
</script>
{% endblock %}
