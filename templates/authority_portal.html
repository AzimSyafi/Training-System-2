{% extends 'base.html' %}
{% block title %}Authority Portal{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <h2 class="mb-0">Certificates Approval</h2>
    <div class="d-flex gap-2 align-items-center">
      <a href="{{ url_for('authority.authority_portal', status='pending') }}" class="btn btn-outline-primary {% if selected_status=='pending' %}active{% endif %}"><i class="fas fa-hourglass-half me-1"></i> Pending</a>
      <a href="{{ url_for('authority.authority_portal', status='approved') }}" class="btn btn-outline-success {% if selected_status=='approved' %}active{% endif %}"><i class="fas fa-check me-1"></i> Approved</a>
      <a href="{{ url_for('authority.authority_portal', status='all') }}" class="btn btn-outline-secondary {% if selected_status=='all' %}active{% endif %}"><i class="fas fa-list me-1"></i> All</a>
    </div>
  </div>
  <div class="card mb-3">
    <div class="card-body">
      <form class="row g-2" method="get" action="{{ url_for('authority.authority_portal') }}">
        <div class="col-sm-3">
          <label class="form-label">Status</label>
          <select name="status" class="form-select">
            <option value="pending" {% if selected_status=='pending' %}selected{% endif %}>Pending</option>
            <option value="approved" {% if selected_status=='approved' %}selected{% endif %}>Approved</option>
            <option value="all" {% if selected_status=='all' %}selected{% endif %}>All</option>
          </select>
        </div>
        <div class="col-sm-6">
          <label class="form-label">Search</label>
          <input type="text" class="form-control" name="q" value="{{ search_query or '' }}" placeholder="Search by user, course, SG ID, or cert ID" />
        </div>
        <div class="col-sm-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i> Apply Filters</button>
        </div>
      </form>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="text-muted">
      Showing {{ rows|length }} result(s)
      <span id="selectedCount" class="badge bg-primary ms-2" style="display: none;">0 selected</span>
    </div>
    <div>
      <button id="approveBtn" class="btn btn-primary" {% if selected_status!='pending' %}disabled{% endif %}>
        <i class="fas fa-check me-1"></i> Approve Selected
      </button>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped align-middle" id="pendingTable">
          <thead>
            <tr>
              {% if selected_status=='pending' %}
              <th>
                <input type="checkbox" id="select-all" aria-label="Select all certificates">
              </th>
              {% endif %}
              <th>Cert ID</th>
              <th>User</th>
              <th>Course</th>
              <th>Issue Date</th>
              <th>Status</th>
              <th>Approved At</th>
              <th>Approved By</th>
            </tr>
          </thead>
          <tbody>
            {% for c in rows %}
            <tr data-cert-id="{{ c.certificate_id }}" data-user-id="{{ c.user_id }}">
              {% if selected_status=='pending' %}
              <td>
                <input type="checkbox" class="cert-checkbox" value="{{ c.certificate_id }}" aria-label="Select certificate {{ c.certificate_id }}">
              </td>
              {% endif %}
              <td>#{{ c.certificate_id }}</td>
              <td>
                {% if c.user %}
                  {{ c.user.full_name }}
                  {% if c.user.number_series %}
                    <div class="text-muted small">{{ c.user.number_series }}</div>
                  {% endif %}
                {% else %}
                  User #{{ c.user_id }}
                {% endif %}
              </td>
              <td>
                {% if c.module and c.module.course %}
                  {{ c.module.course.name }}{% if c.module.course.code %} ({{ c.module.course.code }}){% endif %}
                {% elif c.module %}
                  {{ c.module.module_name }}{% if c.module_type %} ({{ c.module_type }}){% endif %}
                {% else %}
                  {{ c.module_id }}{% if c.module_type %} ({{ c.module_type }}){% endif %}
                {% endif %}
              </td>
              <td>{{ c.issue_date }}</td>
              <td class="status-text">
                {% if c.status == 'pending' %}
                  <span class="badge bg-warning text-dark">pending</span>
                {% elif c.status == 'approved' %}
                  <span class="badge bg-success">approved</span>
                {% else %}
                  <span class="badge bg-secondary">{{ c.status }}</span>
                {% endif %}
              </td>
              <td>{% if c.approved_at %}{{ c.approved_at.strftime('%Y-%m-%d %H:%M') }}{% else %}&mdash;{% endif %}</td>
              <td>{% if c.approved_by %}{{ c.approved_by.full_name }}{% else %}&mdash;{% endif %}</td>
            </tr>
            {% else %}
            <tr><td colspan="{% if selected_status=='pending' %}8{% else %}7{% endif %}" class="text-center text-muted">No certificates found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div id="resultArea" class="mt-3" aria-live="polite"></div>
    </div>
  </div>
</div>
<script>
(function(){
  const table = document.getElementById('pendingTable');
  const approveBtn = document.getElementById('approveBtn');
  const resultArea = document.getElementById('resultArea');
  const selectAllCheckbox = document.getElementById('select-all');
  const selectedCountBadge = document.getElementById('selectedCount');
  const csrfToken = {{ csrf_token|tojson }};
  const statusMode = {{ (selected_status or 'pending')|tojson }};

  // Get all selected certificate IDs
  function getSelectedCertIds() {
    const checkboxes = document.querySelectorAll('.cert-checkbox:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.value));
  }

  // Update the selected count badge and button state
  function updateButtonState() {
    if (!approveBtn) return;
    const selectedIds = getSelectedCertIds();
    const count = selectedIds.length;

    if (count > 0) {
      selectedCountBadge.textContent = count + ' selected';
      selectedCountBadge.style.display = 'inline-block';
      approveBtn.disabled = false;
    } else {
      selectedCountBadge.style.display = 'none';
      approveBtn.disabled = true;
    }
  }

  // Select all functionality
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.cert-checkbox');
      checkboxes.forEach(cb => cb.checked = this.checked);
      updateButtonState();
    });
  }

  // Individual checkbox change
  const certCheckboxes = document.querySelectorAll('.cert-checkbox');
  certCheckboxes.forEach(cb => {
    cb.addEventListener('change', updateButtonState);
  });

  // Initial state
  updateButtonState();

  // Approve button click
  if (approveBtn) {
    approveBtn.addEventListener('click', async function() {
      const selectedIds = getSelectedCertIds();
      if (selectedIds.length === 0) {
        alert('Please select at least one certificate to approve.');
        return;
      }

      if (!confirm(`Are you sure you want to approve ${selectedIds.length} certificate(s)?`)) {
        return;
      }

      approveBtn.disabled = true;
      resultArea.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Processing...</div>';

      try {
        const response = await fetch('{{ url_for("authority.bulk_approve") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({
            scope: 'selected',
            cert_ids: selectedIds
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          resultArea.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> Successfully approved ${data.approved} certificate(s).</div>`;

          // Update the table to reflect approved certificates
          selectedIds.forEach(certId => {
            const row = document.querySelector(`tr[data-cert-id="${certId}"]`);
            if (row) {
              const statusCell = row.querySelector('.status-text');
              if (statusCell) {
                statusCell.innerHTML = '<span class="badge bg-success">approved</span>';
              }
              const checkbox = row.querySelector('.cert-checkbox');
              if (checkbox) {
                checkbox.checked = false;
                checkbox.disabled = true;
              }
            }
          });

          updateButtonState();

          // Reload page after 2 seconds to show updated data
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          resultArea.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error: ${data.error || 'Unknown error'}</div>`;
          approveBtn.disabled = false;
        }
      } catch (error) {
        resultArea.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Request failed. Please try again.</div>';
        approveBtn.disabled = false;
      }
    });
  }
})();
</script>
{% endblock %}
