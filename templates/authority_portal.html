{% extends 'base.html' %}
{% block title %}Authority Portal{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <h2 class="mb-0">Certificates Approval</h2>
    <div class="d-flex gap-2 align-items-center">
      <a href="{{ url_for('authority.authority_portal', status='pending') }}" class="btn btn-outline-primary {% if selected_status=='pending' %}active{% endif %}"><i class="fas fa-hourglass-half me-1"></i> Pending</a>
      <a href="{{ url_for('authority.authority_portal', status='approved') }}" class="btn btn-outline-success {% if selected_status=='approved' %}active{% endif %}"><i class="fas fa-check me-1"></i> Approved</a>
      <a href="{{ url_for('authority.authority_portal', status='all') }}" class="btn btn-outline-secondary {% if selected_status=='all' %}active{% endif %}"><i class="fas fa-list me-1"></i> All</a>
    </div>
  </div>
  <div class="card mb-3">
    <div class="card-body">
      <form class="row g-2" method="get" action="{{ url_for('authority.authority_portal') }}">
        <div class="col-sm-3">
          <label class="form-label">Status</label>
          <select name="status" class="form-select">
            <option value="pending" {% if selected_status=='pending' %}selected{% endif %}>Pending</option>
            <option value="approved" {% if selected_status=='approved' %}selected{% endif %}>Approved</option>
            <option value="all" {% if selected_status=='all' %}selected{% endif %}>All</option>
          </select>
        </div>
        <div class="col-sm-6">
          <label class="form-label">Search</label>
          <input type="text" class="form-control" name="q" value="{{ search_query or '' }}" placeholder="Search by user, course, SG ID, or cert ID" />
        </div>
        <div class="col-sm-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i> Apply Filters</button>
        </div>
      </form>
    </div>
  </div>

  {% if users_list %}
  <div class="card mb-3">
    <div class="card-body">
      <h5>Approval Options</h5>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="approval_scope" id="scope_all" value="all" checked>
        <label class="form-check-label" for="scope_all">
          Approve all pending certificates
        </label>
      </div>
      {% for u in users_list %}
      <div class="form-check">
        <input class="form-check-input" type="radio" name="approval_scope" id="scope_user_{{ u.user.User_id }}" value="user_{{ u.user.User_id }}">
        <label class="form-check-label" for="scope_user_{{ u.user.User_id }}">
          Approve all for {{ u.user.full_name }} {% if u.user.number_series %}({{ u.user.number_series }}){% endif %} ({{ u.count }} pending)
        </label>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="text-muted">Showing {{ rows|length }} result(s)</div>
    <div>
      <button id="approveBtn" class="btn btn-primary" {% if selected_status!='pending' or not users_list %}disabled{% endif %}>Approve Selected</button>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped align-middle" id="pendingTable">
          <thead>
            <tr>
              <th>Cert ID</th>
              <th>User</th>
              <th>Course</th>
              <th>Issue Date</th>
              <th>Status</th>
              <th>Approved At</th>
              <th>Approved By</th>
            </tr>
          </thead>
          <tbody>
            {% for c in rows %}
            <tr data-cert-id="{{ c.certificate_id }}" data-user-id="{{ c.user_id }}">
              <td>#{{ c.certificate_id }}</td>
              <td>
                {% if c.user %}
                  {{ c.user.full_name }}
                  {% if c.user.number_series %}
                    <div class="text-muted small">{{ c.user.number_series }}</div>
                  {% endif %}
                {% else %}
                  User #{{ c.user_id }}
                {% endif %}
              </td>
              <td>
                {% if c.module and c.module.course %}
                  {{ c.module.course.name }}{% if c.module.course.code %} ({{ c.module.course.code }}){% endif %}
                {% elif c.module %}
                  {{ c.module.module_name }}{% if c.module_type %} ({{ c.module_type }}){% endif %}
                {% else %}
                  {{ c.module_id }}{% if c.module_type %} ({{ c.module_type }}){% endif %}
                {% endif %}
              </td>
              <td>{{ c.issue_date }}</td>
              <td class="status-text">
                {% if c.status == 'pending' %}
                  <span class="badge bg-warning text-dark">pending</span>
                {% elif c.status == 'approved' %}
                  <span class="badge bg-success">approved</span>
                {% else %}
                  <span class="badge bg-secondary">{{ c.status }}</span>
                {% endif %}
              </td>
              <td>{% if c.approved_at %}{{ c.approved_at.strftime('%Y-%m-%d %H:%M') }}{% else %}&mdash;{% endif %}</td>
              <td>{% if c.approved_by %}{{ c.approved_by.full_name }}{% else %}&mdash;{% endif %}</td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center text-muted">No certificates found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div id="resultArea" class="mt-3" aria-live="polite"></div>
    </div>
  </div>
</div>
<script>
(function(){
  const table = document.getElementById('pendingTable');
  const approveBtn = document.getElementById('approveBtn');
  const resultArea = document.getElementById('resultArea');
  const csrfToken = {{ csrf_token|tojson }};
  const statusMode = {{ (selected_status or 'pending')|tojson }};

  function getSelectedScope(){
    const radios = document.getElementsByName('approval_scope');
    for (let radio of radios) {
      if (radio.checked) {
        if (radio.value === 'all') {
          return {scope: 'all'};
        } else if (radio.value.startsWith('user_')) {
          const userId = parseInt(radio.value.split('_')[1]);
          return {scope: 'user', user_id: userId};
        }
      }
    }
    return null;
  }

  function updateButtonState(){
    if (!approveBtn) return;
    const sel = getSelectedScope();
    approveBtn.disabled = (statusMode !== 'pending') || !sel;
  }

  document.addEventListener('change', function(e){
    if (e.target && e.target.name === 'approval_scope') {
      updateButtonState();
    }
  });

  updateButtonState(); // initial

  if (approveBtn) {
    approveBtn.addEventListener('click', async function(){
      const scopeData = getSelectedScope();
      if (!scopeData) return;
      approveBtn.disabled = true;
      const approvingText = scopeData.scope === 'all' ? 'all pending certificates' : 'certificates for the selected user';
      resultArea.innerHTML = '<div class="alert alert-info">Approving ' + approvingText + '...</div>';
      try {
        const resp = await fetch('{{ url_for('authority.bulk_approve') }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify(scopeData)
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.success) {
          const msg = data.error || 'Request failed';
          resultArea.innerHTML = '<div class="alert alert-danger">' + msg + '</div>';
        } else {
          // Success: update rows and message
          let approved = 0;
          const rows = table.querySelectorAll('tbody tr');
          rows.forEach(row => {
            const statusCell = row.querySelector('.status-text');
            if (statusCell && statusCell.textContent.trim() === 'pending') {
              const userId = parseInt(row.getAttribute('data-user-id'));
              if (scopeData.scope === 'all' || (scopeData.scope === 'user' && userId === scopeData.user_id)) {
                statusCell.innerHTML = '<span class="badge bg-success">approved</span>';
                // Fill approved columns (optimistic)
                const approvedAtCell = row.querySelector('td:nth-child(6)');
                const approvedByCell = row.querySelector('td:nth-child(7)');
                if (approvedAtCell) approvedAtCell.textContent = new Date().toISOString().slice(0,16).replace('T',' ');
                if (approvedByCell) approvedByCell.textContent = 'You';
                approved += 1;
              }
            }
          });
          resultArea.innerHTML = '<div class="alert alert-success">Approved ' + (data.approved ?? approved) + ' certificates.</div>';
        }
      } catch (e) {
        resultArea.innerHTML = '<div class="alert alert-danger">Network error.</div>';
      } finally {
        updateButtonState();
      }
    });
  }
})();
</script>
{% endblock %}
