{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto p-4">
  <!-- Header -->
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">My Profile</h1>
    <div class="flex flex-col gap-2 relative">
      <div class="relative inline-block text-left">
        <button id="exportDropdownBtn" type="button" class="px-4 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700 font-bold flex items-center" tabindex="0">
          <span>Export</span>
          <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </button>
        <div id="exportDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded shadow-lg z-10">
          <button onclick="printProfileSection()" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Print</button>
          <button onclick="downloadProfilePDF()" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Download PDF</button>
        </div>
        <!-- Add a visible debug span to confirm JS loads -->
        <span id="export-debug-msg" class="text-xs text-red-600 ml-2"></span>
      </div>
      <button id="open-profile-modal" class="px-6 py-2 bg-blue-700 text-white rounded shadow hover:bg-blue-800 font-bold">Edit Profile</button>
    </div>
  </div>

  <div id="profile-export-section">
    <!-- Personal Information -->
    <div class="bg-white rounded-xl shadow p-6 mb-8" id="personal-info-section">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-blue-900">Personal Information</h2>
      </div>
      <div class="flex justify-start mb-4">
        <div class="flex gap-6">
          <!-- Profile Picture -->
          <div class="w-32 flex flex-col items-start">
            <img id="profile-img" src="{{ user.profile_pic_url or url_for('static', filename='default_avatar.png') }}" alt="Profile Picture" class="w-28 h-28 rounded-full object-cover border-4 border-blue-200 mb-2">
          </div>

          <!-- Info Fields -->
          <div id="personal-info-fields" class="text-left">
            <div class="text-gray-500 text-sm">Full Name</div>
            <div class="font-semibold text-lg" id="full_name_display">{{ user.full_name }}</div>
            <div class="text-gray-500 text-sm mt-2">User ID</div>
            <div class="font-semibold text-lg">{{ user.displayed_id }}</div>
            <div class="text-gray-500 text-sm mt-2">Email</div>
            <div class="font-semibold text-lg" id="email_display">{{ user.email }}</div>
            <div class="text-gray-500 text-sm mt-2">Address</div>
            <div class="font-semibold text-lg" id="address_display">{{ user.address }}</div>
            <div class="text-gray-500 text-sm mt-2">Postcode</div>
            <div class="font-semibold text-lg" id="postcode_display">{{ user.postcode }}</div>
            <div class="text-gray-500 text-sm mt-2">State</div>
            <div class="font-semibold text-lg" id="state_display">{{ user.state }}</div>
            <!-- Added Country display -->
            <div class="text-gray-500 text-sm mt-2">Country</div>
            <div class="font-semibold text-lg" id="country_display">{{ user.country }}</div>
            <div class="text-gray-500 text-sm mt-2">IC Number</div>
            <div class="font-semibold text-lg" id="ic_number_display">{{ user.ic_number }}</div>
            <div class="text-gray-500 text-sm mt-2">Passport Number</div>
            <div class="font-semibold text-lg" id="passport_number_display">{{ user.passport_number }}</div>
          </div>
        </div>
      </div>
      <div class="flex justify-end mt-4">
        <!-- Removed Edit Profile button from here -->
      </div>
      <div id="personal-info-errors" class="mt-2 text-red-600 text-sm"></div>
    </div>

    <!-- Working Info -->
    <div class="bg-white rounded-xl shadow p-6 mb-8" id="working-info-section">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-blue-900">Working Experience</h2>
      </div>
      <div id="working-info-fields">
        {% if experiences and experiences|length > 0 %}
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for exp in experiences %}
              <div class="border border-gray-200 rounded-lg p-4 shadow-sm">
                <div class="font-semibold text-lg">{{ exp.company_name }}</div>
                {% if exp.position_title %}
                  <div class="text-gray-600">Position: {{ exp.position_title }}</div>
                {% endif %}
                <div class="text-gray-600">Recruitment Date: {{ exp.recruitment_date.strftime('%Y-%m-%d') if exp.recruitment_date else (exp.start_date.strftime('%Y-%m-%d') if exp.start_date else '-') }}</div>
                <div class="text-gray-600">Period: {{ exp.start_date.strftime('%Y-%m-%d') if exp.start_date else '-' }} to {{ exp.end_date.strftime('%Y-%m-%d') if exp.end_date else '-' }}</div>
                {% if exp.visa_number %}
                  <div class="text-gray-600">Visa Number: {{ exp.visa_number }}</div>
                {% endif %}
                {% if exp.visa_expiry_date %}
                  <div class="text-gray-600">Visa Expiry: {{ exp.visa_expiry_date.strftime('%Y-%m-%d') }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-gray-600">No working experience found.</div>
        {% endif %}
      </div>
    </div>

    <!-- Current Workplace & Agency Info -->
    <div class="bg-white rounded-xl shadow p-6 mb-8" id="workplace-section">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-blue-900">Current Workplace & Agency Info</h2>
      </div>
      <div id="workplace-fields">
        <div class="text-gray-500 text-sm">Current Workplace</div>
        <div class="font-semibold text-lg" id="current_workplace_display">{{ user.current_workplace }}</div>
        <div class="text-gray-500 text-sm">Agency ID</div>
        <div class="font-semibold text-lg" id="agency_id_display">{{ user.agency_id }}</div>
        <div class="text-gray-500 text-sm">Agency Name</div>
        <div class="font-semibold text-lg" id="agency_name_display">{{ user.agency.agency_name if user.agency else '' }}</div>
      </div>
      <div id="workplace-edit-actions" class="hidden flex gap-2 mt-4 justify-end">
        <button type="button" class="save-btn bg-blue-700 text-white px-4 py-2 rounded shadow hover:bg-blue-800 font-bold" data-section="workplace">Save</button>
        <button type="button" class="cancel-btn bg-gray-200 text-gray-700 px-4 py-2 rounded shadow hover:bg-gray-300 font-bold" data-section="workplace">Cancel</button>
      </div>
      <div id="workplace-errors" class="mt-2 text-red-600 text-sm"></div>
    </div>

    <!-- Emergency Contact -->
    <div class="bg-white rounded-xl shadow p-6 mb-8" id="emergency-section">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-blue-900">Emergency Contact</h2>
      </div>
      <div id="emergency-fields">
        <div class="text-gray-500 text-sm">Emergency Contact Phone</div>
        <div class="font-semibold text-lg" id="emergency_contact_phone_display">{{ user.emergency_contact_phone }}</div>
        <div class="text-gray-500 text-sm">Emergency Contact Name</div>
        <div class="font-semibold text-lg" id="emergency_contact_display">{{ user.emergency_contact_name }}</div>
        <div class="text-gray-500 text-sm">Emergency Relationship</div>
        <div class="font-semibold text-lg" id="emergency_relationship_display">{{ user.emergency_contact_relationship }}</div>
      </div>
      <div id="emergency-edit-actions" class="hidden flex gap-2 mt-4 justify-end">
        <button type="button" class="save-btn bg-blue-700 text-white px-4 py-2 rounded shadow hover:bg-blue-800 font-bold" data-section="emergency">Save</button>
        <button type="button" class="cancel-btn bg-gray-200 text-gray-700 px-4 py-2 rounded shadow hover:bg-gray-300 font-bold" data-section="emergency">Cancel</button>
      </div>
      <div id="emergency-errors" class="mt-2 text-red-600 text-sm"></div>
    </div>
  </div>

  <!-- Profile Edit Modal -->
  <div id="profile-modal" class="fixed inset-0 bg-gray-900 bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative max-h-[90vh] overflow-y-auto">
      <button id="close-profile-modal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">&times;</button>
      <h2 class="text-xl font-bold mb-4">Edit Personal Information</h2>
      <form id="edit-profile-form" method="POST" action="/profile" enctype="multipart/form-data">
        <div class="mb-4 flex flex-col items-center">
          <img id="modal-profile-img" src="{{ user.profile_pic_url or url_for('static', filename='default_avatar.png') }}" alt="Profile Picture" class="w-24 h-24 rounded-full object-cover border-4 border-blue-200 mb-2">
          <input type="file" name="profile_pic" accept="image/*" class="mt-2" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Full Name</label>
          <input type="text" name="full_name" value="{{ user.full_name }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Email</label>
          <input type="email" name="email" value="{{ user.email }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Address</label>
          <input type="text" name="address" value="{{ user.address }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Postcode</label>
          <input type="text" name="postcode" value="{{ user.postcode }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">State</label>
          <select name="state" class="w-full border rounded px-2 py-1">
            <option value="">Select State</option>
            {% for state in malaysian_states %}
              <option value="{{ state }}" {% if user.state == state %}selected{% endif %}>{{ state }}</option>
            {% endfor %}
          </select>
        </div>
        <!-- Added Country select -->
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Country</label>
          <select name="country" class="w-full border rounded px-2 py-1">
            <option value="">Select country</option>
            <!-- keep existing country options -->
            {% for opt in [
              'Afghanistan','Albania','Algeria','Andorra','Angola','Antigua and Barbuda','Argentina','Armenia','Australia','Austria','Azerbaijan','Bahamas','Bahrain','Bangladesh','Barbados','Belarus','Belgium','Belize','Benin','Bhutan','Bolivia','Bosnia and Herzegovina','Botswana','Brazil','Brunei','Bulgaria','Burkina Faso','Burundi','Cambodia','Cameroon','Canada','Cape Verde','Central African Republic','Chad','Chile','China','Colombia','Comoros','Congo, Democratic Republic of the','Congo, Republic of the','Costa Rica','Cote d\'Ivoire','Croatia','Cuba','Cyprus','Czech Republic','Denmark','Djibouti','Dominica','Dominican Republic','Ecuador','Egypt','El Salvador','Equatorial Guinea','Eritrea','Estonia','Eswatini','Ethiopia','Fiji','Finland','France','Gabon','Gambia','Georgia','Germany','Ghana','Greece','Grenada','Guatemala','Guinea','Guinea-Bissau','Guyana','Haiti','Honduras','Hungary','Iceland','India','Indonesia','Iran','Iraq','Ireland','Israel','Italy','Jamaica','Japan','Jordan','Kazakhstan','Kenya','Kiribati','Kuwait','Kyrgyzstan','Laos','Latvia','Lebanon','Lesotho','Liberia','Libya','Liechtenstein','Lithuania','Luxembourg','Madagascar','Malawi','Malaysia','Maldives','Mali','Malta','Marshall Islands','Mauritania','Mauritius','Mexico','Micronesia','Moldova','Monaco','Mongolia','Montenegro','Morocco','Mozambique','Myanmar','Namibia','Nauru','Nepal','Netherlands','New Zealand','Nicaragua','Niger','Nigeria','North Korea','North Macedonia','Norway','Oman','Pakistan','Palau','Panama','Papua New Guinea','Paraguay','Peru','Philippines','Poland','Portugal','Qatar','Romania','Russia','Rwanda','Saint Kitts and Nevis','Saint Lucia','Saint Vincent and the Grenadines','Samoa','San Marino','Sao Tome and Principe','Saudi Arabia','Senegal','Serbia','Seychelles','Sierra Leone','Singapore','Slovakia','Slovenia','Solomon Islands','Somalia','South Africa','South Korea','South Sudan','Spain','Sri Lanka','Sudan','Suriname','Sweden','Switzerland','Syria','Taiwan','Tajikistan','Tanzania','Thailand','Timor-Leste','Togo','Tonga','Trinidad and Tobago','Tunisia','Turkey','Turkmenistan','Tuvalu','Uganda','Ukraine','United Arab Emirates','United Kingdom','United States','Uruguay','Uzbekistan','Vanuatu','Vatican City','Venezuela','Vietnam','Yemen','Zambia','Zimbabwe' ] %}
              <option value="{{ opt }}" {% if user.country == opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Working Experience (summary)</label>
          <input type="text" name="working_experience" value="{{ user.working_experience }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Recruitment Date</label>
          <input type="date" name="recruitment_date" value="{{ user.recruitment_date }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Visa Number</label>
          <input type="text" name="visa_number" value="{{ user.visa_number }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Visa Expiry Date</label>
          <input type="date" name="visa_expiry_date" value="{{ user.visa_expiry_date }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Current Workplace</label>
          <input type="text" name="current_workplace" value="{{ user.current_workplace }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Agency ID</label>
          <input type="text" name="agency_id" value="{{ user.agency_id }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Agency Name</label>
          <input type="text" name="agency_name" value="{{ user.agency.agency_name if user.agency else '' }}" class="w-full border rounded px-2 py-1" />
        </div>

        <!-- Multi Working Experiences Editor -->
        <div class="mt-4 p-3 border rounded-lg">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Working Experiences</h3>
            <button type="button" id="modal-add-experience" class="px-3 py-1 text-sm bg-blue-100 text-blue-900 rounded hover:bg-blue-200">Add experience</button>
          </div>
          <div class="text-xs text-gray-500 mb-2">Tip: For each experience, please provide at least Company and Start Date (or Recruitment Date) so it can be saved.</div>
          <div id="modal-experience-list" class="flex flex-col gap-3">
            {% if experiences and experiences|length > 0 %}
              {% for exp in experiences %}
                <div class="border rounded p-3 experience-item">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <div>
                      <label class="block text-gray-500 text-xs">Company</label>
                      <input type="text" name="exp_company" value="{{ exp.company_name }}" class="w-full border rounded px-2 py-1" />
                    </div>
                    <div>
                      <label class="block text-gray-500 text-xs">Position</label>
                      <input type="text" name="exp_position" value="{{ exp.position_title or '' }}" class="w-full border rounded px-2 py-1" />
                    </div>
                    <div>
                      <label class="block text-gray-500 text-xs">Recruitment Date</label>
                      <input type="date" name="exp_recruitment" value="{{ exp.recruitment_date.strftime('%Y-%m-%d') if exp.recruitment_date else (exp.start_date.strftime('%Y-%m-%d') if exp.start_date else '') }}" class="w-full border rounded px-2 py-1" />
                    </div>
                    <div>
                      <label class="block text-gray-500 text-xs">Visa Number</label>
                      <input type="text" name="exp_visa_number" value="{{ exp.visa_number or '' }}" class="w-full border rounded px-2 py-1" />
                    </div>
                    <div>
                      <label class="block text-gray-500 text-xs">Start Date</label>
                      <input type="date" name="exp_start" value="{{ exp.start_date.strftime('%Y-%m-%d') if exp.start_date else '' }}" class="w-full border rounded px-2 py-1" />
                    </div>
                    <div>
                      <label class="block text-gray-500 text-xs">End Date</label>
                      <input type="date" name="exp_end" value="{{ exp.end_date.strftime('%Y-%m-%d') if exp.end_date else '' }}" class="w-full border rounded px-2 py-1" />
                    </div>
                    <div>
                      <label class="block text-gray-500 text-xs">Visa Expiry</label>
                      <input type="date" name="exp_visa_expiry" value="{{ exp.visa_expiry_date.strftime('%Y-%m-%d') if exp.visa_expiry_date else '' }}" class="w-full border rounded px-2 py-1" />
                    </div>
                  </div>
                  <div class="flex justify-end mt-2">
                    <button type="button" class="remove-exp px-3 py-1 text-sm bg-red-100 text-red-800 rounded hover:bg-red-200">Remove</button>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="border rounded p-3 experience-item">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                  <div>
                    <label class="block text-gray-500 text-xs">Company</label>
                    <input type="text" name="exp_company" class="w-full border rounded px-2 py-1" />
                  </div>
                  <div>
                    <label class="block text-gray-500 text-xs">Position</label>
                    <input type="text" name="exp_position" class="w-full border rounded px-2 py-1" />
                  </div>
                  <div>
                    <label class="block text-gray-500 text-xs">Recruitment Date</label>
                    <input type="date" name="exp_recruitment" class="w-full border rounded px-2 py-1" />
                  </div>
                  <div>
                    <label class="block text-gray-500 text-xs">Visa Number</label>
                    <input type="text" name="exp_visa_number" class="w-full border rounded px-2 py-1" />
                  </div>
                  <div>
                    <label class="block text-gray-500 text-xs">Start Date</label>
                    <input type="date" name="exp_start" class="w-full border rounded px-2 py-1" />
                  </div>
                  <div>
                    <label class="block text-gray-500 text-xs">End Date</label>
                    <input type="date" name="exp_end" class="w-full border rounded px-2 py-1" />
                  </div>
                  <div>
                    <label class="block text-gray-500 text-xs">Visa Expiry</label>
                    <input type="date" name="exp_visa_expiry" class="w-full border rounded px-2 py-1" />
                  </div>
                </div>
                <div class="flex justify-end mt-2">
                  <button type="button" class="remove-exp px-3 py-1 text-sm bg-red-100 text-red-800 rounded hover:bg-red-200">Remove</button>
                </div>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Emergency Contact</label>
          <input type="text" name="emergency_contact_name" value="{{ user.emergency_contact_name }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Emergency Relationship</label>
          <input type="text" name="emergency_contact_relationship" value="{{ user.emergency_contact_relationship }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div class="mb-2">
          <label class="block text-gray-500 text-sm">Emergency Contact Phone</label>
          <input type="text" name="emergency_contact_phone" value="{{ user.emergency_contact_phone }}" class="w-full border rounded px-2 py-1" />
        </div>
        <div id="modal-profile-errors" class="text-red-600 text-sm mb-2"></div>
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="cancel-profile-modal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded shadow hover:bg-gray-300 font-bold">Cancel</button>
          <button type="submit" id="save-profile-modal" class="bg-blue-700 text-white px-4 py-2 rounded shadow hover:bg-blue-800 font-bold">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="profile-success" class="hidden bg-green-100 text-green-800 px-4 py-2 rounded mb-4"></div>
  <div id="profile-error" class="hidden bg-red-100 text-red-800 px-4 py-2 rounded mb-4"></div>
</div>

<script src="{{ url_for('static', filename='profile_edit.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- Inline script moved to ensure html2pdf is loaded first -->
<script>
function printProfileSection() {
  const printContents = document.getElementById('profile-export-section').outerHTML;
  const win = window.open('', '', 'height=700,width=900');
  win.document.write('<html><head><title>Print Profile</title>');
  win.document.write('<link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">');
  win.document.write('</head><body>');
  win.document.write(printContents);
  win.document.write('</body></html>');
  win.document.close();
  win.focus();
  setTimeout(() => { win.print(); win.close(); }, 500);
}

function downloadProfilePDF() {
  if (confirm('Download as PDF?')) {
    const element = document.getElementById('profile-export-section');
    html2pdf().set({
      margin: 0.5,
      filename: 'profile.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    }).from(element).save();
  }
}

function initModalExperienceEditor(){
  const list = document.getElementById('modal-experience-list');
  const addBtn = document.getElementById('modal-add-experience');
  if(!list || !addBtn) return;
  function bindRemove(btn){
    btn.addEventListener('click', function(){
      const item = this.closest('.experience-item');
      if(item){ item.remove(); }
    });
  }
  list.querySelectorAll('.remove-exp').forEach(bindRemove);
  function createItem(){
    const wrapper = document.createElement('div');
    wrapper.className = 'border rounded p-3 experience-item';
    wrapper.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div>
          <label class="block text-gray-500 text-xs">Company</label>
          <input type="text" name="exp_company" class="w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label class="block text-gray-500 text-xs">Position</label>
          <input type="text" name="exp_position" class="w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label class="block text-gray-500 text-xs">Recruitment Date</label>
          <input type="date" name="exp_recruitment" class="w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label class="block text-gray-500 text-xs">Visa Number</label>
          <input type="text" name="exp_visa_number" class="w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label class="block text-gray-500 text-xs">Start Date</label>
          <input type="date" name="exp_start" class="w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label class="block text-gray-500 text-xs">End Date</label>
          <input type="date" name="exp_end" class="w-full border rounded px-2 py-1" />
        </div>
        <div>
          <label class="block text-gray-500 text-xs">Visa Expiry</label>
          <input type="date" name="exp_visa_expiry" class="w-full border rounded px-2 py-1" />
        </div>
      </div>
      <div class="flex justify-end mt-2">
        <button type="button" class="remove-exp px-3 py-1 text-sm bg-red-100 text-red-800 rounded hover:bg-red-200">Remove</button>
      </div>`;
    bindRemove(wrapper.querySelector('.remove-exp'));
    return wrapper;
  }
  addBtn.addEventListener('click', function(){
    list.appendChild(createItem());
  });
}

document.addEventListener('DOMContentLoaded', function() {
  const openModalBtn = document.getElementById('open-profile-modal');
  const modal = document.getElementById('profile-modal');
  const closeModalBtn = document.getElementById('close-profile-modal');
  const cancelModalBtn = document.getElementById('cancel-profile-modal');
  if (openModalBtn && modal) {
    openModalBtn.onclick = () => { modal.classList.remove('hidden'); initModalExperienceEditor(); };
  }
  if (closeModalBtn && modal) {
    closeModalBtn.onclick = () => { modal.classList.add('hidden'); };
  }
  if (cancelModalBtn && modal) {
    cancelModalBtn.onclick = () => { modal.classList.add('hidden'); };
  }
  // Ensure the Save button performs a normal form submit (avoid JS override)
  const saveProfileBtn = document.getElementById('save-profile-modal');
  if (saveProfileBtn) {
    saveProfileBtn.onclick = null;
  }
  // Dropdown functionality
  const exportDropdownBtn = document.getElementById('exportDropdownBtn');
  const exportDropdown = document.getElementById('exportDropdown');
  if (exportDropdownBtn && exportDropdown) {
    exportDropdownBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (exportDropdown.classList.contains('hidden')) {
        exportDropdown.classList.remove('hidden');
      } else {
        exportDropdown.classList.add('hidden');
      }
    });
    exportDropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });
    document.addEventListener('click', function(e) {
      if (!exportDropdown.classList.contains('hidden')) {
        exportDropdown.classList.add('hidden');
      }
    });
  }
});
</script>
{% endblock %}
