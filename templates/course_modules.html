{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4">
  <!-- styles moved to static/css/module_cards.css -->
  <div class="mb-4 flex justify-between items-center">
    <a href="{{ url_for('courses') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Back to Courses
    </a>

    {% set course_type = modules[0].module_type if modules else '' %}
    {% if current_user.has_completed_all_modules_in_course(course_type) and overall_percentage is defined and overall_percentage < 50 %}
    <button id="reattemptBtn" class="btn btn-warning" onclick="reattemptCourse('{{ course_type.lower() }}')" title="Overall score {{ overall_percentage }}% (below 50%) - you can reattempt">
      <i class="fas fa-redo"></i> Reattempt Course
    </button>
    {% endif %}
  </div>
  <h2 class="text-3xl font-bold mb-1 text-blue-900">{{ course_name }}</h2>
  {% if overall_percentage is defined and current_user.has_completed_all_modules_in_course(course_type) %}
    <p class="text-sm text-gray-600 mb-6">Overall Score: <span class="font-semibold {% if overall_percentage < 50 %}text-red-600{% elif overall_percentage > 75 %}text-green-600{% else %}text-blue-600{% endif %}">{{ overall_percentage }}%</span></p>
  {% endif %}

  {% set first_incomplete_found = false %}
  {% for module in modules %}
    {% set user_module = user_progress.get(module.module_id) %}
    {% set anchor_id = '' %}
    {% if module.unlocked and (not user_module or not user_module.is_completed) and not first_incomplete_found %}
      {% set anchor_id = 'next' %}
      {% set first_incomplete_found = true %}
    {% endif %}
    {% set open_module = False %}
    {% set body_style = 'display:block;' if open_module else 'display:none;' %}
    {% if not module.unlocked %}{% set body_style = body_style + 'pointer-events:none;opacity:0.5;' %}{% endif %}
    <div class="card module-card-rounded shadow mb-6" id="{{ anchor_id }}">
      <div class="card-header bg-blue-800 text-white p-4 flex justify-between items-center {% if not module.unlocked %}opacity-60 cursor-not-allowed{% else %}cursor-pointer{% endif %} {% if not open_module %}collapsed{% endif %}" {% if module.unlocked %}onclick="toggleModule('{{ module.module_id }}')"{% endif %}>
        <div class="flex items-center">
          <h3 class="text-xl font-bold mr-2">{{ module.module_name }}</h3>
          <span class="font-semibold text-xs bg-blue-100 text-blue-800 rounded px-2 py-1 mb-2 inline-block">{{ module.series_number }}</span>
          {% if not module.unlocked %}
            <span class="ml-2 text-red-500" title="Locked"><i class="fas fa-lock"></i> Locked</span>
          {% endif %}
        </div>
        <div></div>
        <i class="fas fa-chevron-down text-xl transition-transform duration-300" id="chevron-{{ module.module_id }}"></i>
      </div>
      <div class="card-body p-6" id="module-content-{{ module.module_id }}" style="{{ body_style }}">
        {% if not module.unlocked %}
          <div class="text-center text-red-500 font-bold mb-4">This module is locked. Complete the previous module to unlock.</div>
        {% endif %}
        {% if module.unlocked %}
        <p class="text-gray-700 mb-6">{{ module.content }}</p>
        <ul class="nav nav-tabs mb-4" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#slide-{{ module.module_id }}" type="button" role="tab">
              <i class="fas fa-file-powerpoint mr-2"></i>Slide
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#video-{{ module.module_id }}" type="button" role="tab">
              <i class="fas fa-video mr-2"></i>Video
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#quizlink-{{ module.module_id }}" type="button" role="tab">
              <i class="fas fa-question-circle mr-2"></i>Quiz
            </button>
          </li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="slide-{{ module.module_id }}" role="tabpanel">
            <div class="bg-blue-50 module-inner-panel-blue p-4 rounded-lg">
              <h4 class="text-lg font-semibold mb-2">Module Slides</h4>
              {% if module.slide_url %}
                {% set slide_url = '/static/uploads/' ~ module.slide_url %}
                {% if module.slide_url.endswith('.pdf') %}
                  <div class="max-w-4xl mx-auto mb-2">
                    <iframe class="w-full h-96 border rounded deferred-iframe" data-src="{{ slide_url }}" allowfullscreen></iframe>
                  </div>
                {% elif module.slide_url.endswith('.pptx') %}
                  <div class="max-w-4xl mx-auto mb-2">
                    {% set absolute_src = (request.url_root ~ 'static/uploads/' ~ module.slide_url) | trim('/') %}
                    <iframe class="w-full h-96 border rounded deferred-iframe" data-src="https://view.officeapps.live.com/op/embed.aspx?src={{ absolute_src | url_encode }}" allowfullscreen></iframe>
                  </div>
                {% else %}
                  <p class="text-gray-600 mb-4">Unsupported slide format. Please use PDF or PPTX.</p>
                {% endif %}
                <a href="{{ slide_url }}" class="btn btn-primary mt-2" download>Download Slide</a>
              {% else %}
                <p class="text-gray-600 mb-4">No slides available for this module.</p>
              {% endif %}
            </div>
          </div>
          <div class="tab-pane fade" id="video-{{ module.module_id }}" role="tabpanel">
            <div class="bg-blue-50 module-inner-panel-blue p-4 rounded-lg">
              <h4 class="text-lg font-semibold mb-2">Instructional Video</h4>
              {% if module.youtube_url %}
              {% set __yid = module.youtube_url|youtube_id %}
              <div class="max-w-4xl mx-auto">
                <div style="position:relative;padding-top:56.25%;">
                  <div style="position:absolute;top:0;left:0;width:100%;height:100%;">
                    <div class="youtube-placeholder" data-youtube-id="{{ __yid }}" aria-label="YouTube video placeholder" style="width:100%;height:100%;"></div>
                  </div>
                </div>
              </div>
              {% else %}
                <p class="text-gray-600 mb-4">No video available for this module.</p>
               {% endif %}
            </div>
          </div>
          <div class="tab-pane fade" id="quizlink-{{ module.module_id }}" role="tabpanel">
            <div class="bg-blue-50 module-inner-panel-blue p-4 rounded-lg">
              <div class="text-lg font-semibold mb-3 flex items-center">Knowledge Check</div>
              {% if user_module and user_module.is_completed %}
                <div class="alert alert-success mb-3 p-2 text-sm">Quiz completed. You can review or reattempt in the Quiz Player.</div>
              {% endif %}
              <p class="text-gray-600 mb-3">Open the dedicated Quiz Player for an immersive experience.</p>
              <a href="{{ url_for('module_quiz', module_id=module.module_id) }}" class="btn btn-primary btn-lg">
                <i class="fas fa-play me-1"></i> Open Quiz Player
              </a>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleModule(moduleId) {
  const content = document.getElementById('module-content-' + moduleId);
  const chevron = document.getElementById('chevron-' + moduleId);
  const header = chevron ? chevron.closest('.card-header') : null;
  if (!content || !chevron || !header) return;
  const open = content.style.display === 'block';
  content.style.display = open ? 'none' : 'block';
  chevron.classList.toggle('fa-chevron-up', !open);
  chevron.classList.toggle('fa-chevron-down', open);
  header.classList.toggle('collapsed', open === true); // add collapsed when hiding body
}
function reattemptCourse(courseType) {
  if (confirm('Are you sure you want to reattempt this course? All your progress will be reset.')) {
    fetch(`/api/reattempt_course/${courseType}`, {method:'POST', headers:{'Content-Type':'application/json'}})
      .then(r=>r.json()).then(data=>{
        if(data.success){ alert('Course reset.'); location.reload(); }
        else { alert('Failed: ' + (data.message||'Unknown')); }
      }).catch(e=>alert('Error: '+e));
  }
}

// Activate deferred iframes and YouTube placeholders to avoid Jinja-in-src lint warnings
function activateDeferredIframes(root=document){
  const iframes = (root || document).querySelectorAll('iframe.deferred-iframe');
  for(const iframe of iframes){
    if(!iframe.getAttribute('src')){
      const src = iframe.getAttribute('data-src');
      if(src) iframe.setAttribute('src', src);
    }
  }
  const placeholders = (root || document).querySelectorAll('.youtube-placeholder');
  for(const ph of placeholders){
    if(ph.dataset.processed) continue;
    const id = ph.getAttribute('data-youtube-id');
    if(!id) continue;
    const iframe = document.createElement('iframe');
    iframe.setAttribute('src', 'https://www.youtube.com/embed/' + id);
    iframe.setAttribute('title', 'YouTube video player');
    iframe.setAttribute('allowfullscreen', '');
    iframe.style.width = '100%'; iframe.style.height = '100%';
    ph.innerHTML = '';
    ph.appendChild(iframe);
    ph.dataset.processed = '1';
  }
}

document.addEventListener('DOMContentLoaded', function(){
  activateDeferredIframes();
});
</script>
{% endblock %}
