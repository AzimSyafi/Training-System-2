{% extends "base.html" %}
{% block title %}Onboarding - Training System{% endblock %}

{% block content %}
<nav class="navbar navbar-light bg-light shadow-sm">
  <div class="container d-flex justify-content-between align-items-center">
    <a class="navbar-brand fw-bold" href="/">TRAINING SYSTEM</a>
    <div>
      {% if current_user.is_authenticated %}
        <a href="{{ safe_url_for('main.user_dashboard') }}" class="btn btn-outline-primary me-2">Dashboard</a>
        <a href="{{ url_for('main.logout') }}" class="btn btn-outline-secondary">Logout</a>
      {% else %}
        <a href="{{ url_for('main.login') }}" class="btn btn-outline-primary me-2">Login</a>
        <a href="{{ url_for('main.signup') }}" class="btn btn-outline-primary">Sign Up</a>
      {% endif %}
    </div>
  </div>
</nav>

<style>
  html, body { height: 100%; margin: 0; display: flex; flex-direction: column; }
  body.signup-bg { background: linear-gradient(120deg, #f8fafc 0%, #f3f4f6 100%); overflow-x: hidden; }
  .blurred-shape { position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.3; z-index: 0; }
  .shape-orange { width: 300px; height: 300px; background: #fd7e14; bottom: -100px; left: -100px; }
  .shape-blue { width: 200px; height: 200px; background: #0d6efd; top: -80px; right: -80px; }
  .auth-wrapper { min-height: calc(100vh - 0px); display: flex; flex-direction: column; position: relative; z-index: 1; }
  .auth-main { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem 1rem; }
  .main-content { flex: 1; }
  .footer { width: 100%; margin-top: auto; left: 0; right: 0; box-shadow: 0 -2px 16px rgba(0,0,0,0.07); background: linear-gradient(90deg, #f8fafc 0%, #e3e7ed 100%); }
  @media (max-width: 768px) { .footer .container { flex-direction: column !important; text-align: center !important; gap: 1rem; } }
  .onboarding-card { max-width: 720px; width: 100%; }
  /* Step indicator: keep items on one line and make lines flexible */
  .step-indicator { display:flex; align-items:center; flex-wrap: nowrap; width: 100%; gap: 0; }
  .step-dot { flex: 0 0 auto; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:600; background:#e5e7eb; color:#374151; margin: 0 10px; }
  .step-dot.active { background:#0d6efd; color:#fff; }
  .step-line { flex: 1 1 auto; min-width: 28px; height:3px; background:#e5e7eb; border-radius:9999px; }
  .step-line.active { background:#0d6efd; }
  /* Passport photo frame ~35x45mm ratio (width:height ≈ 0.78). Using 140x180px for clarity */
  .passport-photo-frame { width: 140px; height: 180px; border: 2px solid #e5e7eb; border-radius: 8px; background: #f9fafb; display: inline-flex; align-items: center; justify-content: center; overflow: hidden; }
  .passport-photo { width: 100%; height: 100%; object-fit: cover; display: none; }
  .passport-photo-placeholder { font-size: 12px; color: #9ca3af; text-align: center; padding: 8px; }
</style>

<div class="blurred-shape shape-orange"></div>
<div class="blurred-shape shape-blue"></div>

<div class="main-content">
  <div class="auth-wrapper d-flex flex-column position-relative" style="height: 100%;">
    <div class="w-100 text-center mb-3">
      <h1 class="fw-bold" style="color: black; font-size: 2.5rem;">Complete your profile</h1>
      <p class="mt-2">You can skip any step and finish later.</p>
    </div>
    <div class="auth-main">
      {% set s = step %}
      {% set total = total_steps %}
      <div class="mx-auto card shadow-lg p-3 p-md-4 rounded-4 onboarding-card">
        <div class="card-header bg-white border-0">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
              <h3 class="mb-0">Onboarding</h3>
              <div class="mt-3 step-indicator">
                {% for i in range(1, total + 1) %}
                  <div class="step-dot{% if i <= s %} active{% endif %}">{{ i }}</div>
                  {% if not loop.last %}
                    <div class="step-line{% if i < s %} active{% endif %}"></div>
                  {% endif %}
                {% endfor %}
              </div>
              <div class="text-muted small mt-2">Step {{ s }} of {{ total }}</div>
            </div>
            {% if user.profile_pic_url %}
              <div class="text-center">
                <img src="{{ user.profile_pic_url }}" alt="Profile picture" class="rounded-circle border" style="width:64px;height:64px;object-fit:cover;">
                <div class="small text-muted mt-1">Current photo</div>
              </div>
            {% endif %}
          </div>
        </div>
        <div class="card-body">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                {% if not (message.startswith('Account created successfully!')) %}
                  <div class="alert alert-{% if category == 'success' %}success{% else %}danger{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                  </div>
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endwith %}

          <form method="POST" action="{{ url_for('main.onboarding', id=id, step=step) }}" enctype="multipart/form-data">
            <input type="hidden" name="step" value="{{ step }}">

            {% if s == 1 %}
              <h5 class="mb-3">Personal Details</h5>
              <div class="row g-3">
                <div class="col-12">
                  <label for="full_name_onboard" class="form-label">Full Name</label>
                  <input id="full_name_onboard" class="form-control" type="text" name="full_name" value="{{ user.full_name or '' }}">
                </div>
                <div class="col-12">
                  <label class="form-label">Citizenship</label>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="user_category" id="citizen" value="citizen" {% if (user.user_category | default('citizen') | lower) == 'citizen' %}checked{% endif %} onchange="toggleIdField()">
                    <label class="form-check-label" for="citizen">Malaysian Citizen</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="user_category" id="foreigner" value="foreigner" {% if (user.user_category | default('citizen') | lower) == 'foreigner' %}checked{% endif %} onchange="toggleIdField()">
                    <label class="form-check-label" for="foreigner">Foreigner</label>
                  </div>
                </div>
                <div class="col-12" id="ic_field" style="display:none;">
                  <label for="ic_number" class="form-label">IC Number</label>
                  <input aria-label="IC Number" class="form-control" type="text" name="ic_number" id="ic_number" value="{{ user.ic_number or '' }}" placeholder="123456-78-9012">
                </div>
                <div class="col-12" id="passport_field" style="display:none;">
                  <label for="passport_number" class="form-label">Passport Number</label>
                  <input aria-label="Passport Number" class="form-control" type="text" name="passport_number" id="passport_number" value="{{ user.passport_number or '' }}" placeholder="A12345678">
                </div>
                <div class="col-12">
                  <label for="onboard-profile-input" class="form-label">Profile Picture</label>
                  <input id="onboard-profile-input" class="form-control" type="file" name="profile_pic" accept="image/*">
                  <div class="form-text">PNG, JPG, JPEG, GIF, or WEBP. Preview shown in passport photo size (35×45 mm ratio).</div>
                  <div class="mt-3">
                    <div class="passport-photo-frame">
                      <img id="onboard-upload-preview" src="{{ user.profile_pic_url or '' }}" alt="Passport photo preview" class="passport-photo" style="{% if user.profile_pic_url %}display:block;{% endif %}">
                      {% if not user.profile_pic_url %}
                        <div id="onboard-upload-placeholder" class="passport-photo-placeholder">Passport photo<br>preview</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% elif s == 2 %}
              <h5 class="mb-3">Contact Details</h5>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="emergency_contact_phone" class="form-label">Phone Number</label>
                  <input id="emergency_contact_phone" class="form-control" type="text" name="emergency_contact_phone" value="{{ user.emergency_contact_phone or '' }}" placeholder="0123456789">
                </div>
                <div class="col-md-6">
                  <label for="postcode_onboard" class="form-label">Postcode</label>
                  <input id="postcode_onboard" class="form-control" type="text" name="postcode" value="{{ user.postcode or '' }}">
                </div>
                <div class="col-12">
                  <label for="address_onboard" class="form-label">Address</label>
                  <textarea id="address_onboard" class="form-control" rows="2" name="address">{{ user.address or '' }}</textarea>
                </div>
                <div class="col-12">
                  <label for="state_onboard" class="form-label">State</label>
                  <select id="state_onboard" class="form-control" name="state">
                    <option value="">Select State</option>
                    {% for state in malaysian_states %}
                      <option value="{{ state }}" {% if user.state == state %}selected{% endif %}>{{ state }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            {% elif s == 3 %}
              <h5 class="mb-3">Work Details</h5>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="current_workplace_onboard" class="form-label">Current Workplace</label>
                  <input id="current_workplace_onboard" class="form-control" type="text" name="current_workplace" value="{{ user.current_workplace or '' }}">
                </div>
                <div class="col-md-6">
                  <label for="recruitment_date_onboard" class="form-label">Recruitment Date</label>
                  <input id="recruitment_date_onboard" class="form-control" type="date" name="recruitment_date" value="{{ user.recruitment_date.strftime('%Y-%m-%d') if user.recruitment_date else '' }}">
                </div>
              </div>

              <hr class="my-4">
              <h5 class="mb-3">Working Experience</h5>
              <div id="experience-list" class="d-flex flex-column gap-3">
                {% if user.work_histories and user.work_histories|length > 0 %}
                  {% for wh in user.work_histories %}
                    <div class="card border rounded-3 p-3 experience-item">
                      <div class="row g-3 align-items-end">
                        <div class="col-md-6">
                          <label class="form-label">Place / Company</label>
                          <input aria-label="Place / Company" type="text" class="form-control" name="exp_company" value="{{ wh.company_name }}" placeholder="Company name">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Position</label>
                          <input aria-label="Position" type="text" class="form-control" name="exp_position" value="{{ wh.position_title or '' }}" placeholder="e.g., Security Guard">
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">Recruitment Date</label>
                          <input aria-label="Experience recruitment date" type="date" class="form-control" name="exp_recruitment" value="{{ wh.recruitment_date.strftime('%Y-%m-%d') if wh.recruitment_date else (wh.start_date.strftime('%Y-%m-%d') if wh.start_date else '') }}">
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">Start Date</label>
                          <input aria-label="Experience start date" type="date" class="form-control" name="exp_start" value="{{ wh.start_date.strftime('%Y-%m-%d') if wh.start_date else '' }}">
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">End Date</label>
                          <input aria-label="Experience end date" type="date" class="form-control" name="exp_end" value="{{ wh.end_date.strftime('%Y-%m-%d') if wh.end_date else '' }}">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Visa Number</label>
                          <input aria-label="Visa Number" type="text" class="form-control" name="exp_visa_number" value="{{ wh.visa_number or '' }}">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Visa Expiry Date</label>
                          <input aria-label="Visa expiry date" type="date" class="form-control" name="exp_visa_expiry" value="{{ wh.visa_expiry_date.strftime('%Y-%m-%d') if wh.visa_expiry_date else '' }}">
                        </div>
                        <div class="col-12 d-flex justify-content-end">
                          <button type="button" class="btn btn-outline-danger btn-sm remove-exp">Remove</button>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="card border rounded-3 p-3 experience-item">
                    <div class="row g-3 align-items-end">
                      <div class="col-md-6">
                        <label class="form-label">Place / Company</label>
                        <input aria-label="Place / Company" type="text" class="form-control" name="exp_company" placeholder="Company name">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Position</label>
                        <input aria-label="Position" type="text" class="form-control" name="exp_position" placeholder="e.g., Security Guard">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Recruitment Date</label>
                        <input aria-label="Experience recruitment date" type="date" class="form-control" name="exp_recruitment">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Start Date</label>
                        <input aria-label="Experience start date" type="date" class="form-control" name="exp_start">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">End Date</label>
                        <input aria-label="Experience end date" type="date" class="form-control" name="exp_end">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Visa Number</label>
                        <input aria-label="Visa Number" type="text" class="form-control" name="exp_visa_number">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Visa Expiry Date</label>
                        <input aria-label="Visa expiry date" type="date" class="form-control" name="exp_visa_expiry">
                      </div>
                      <div class="col-12 d-flex justify-content-end">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-exp">Remove</button>
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>
              <div class="mt-3">
                <button id="add-experience" type="button" class="btn btn-outline-primary btn-sm">Add experience</button>
              </div>
            {% elif s == 4 %}
              <h5 class="mb-3">Emergency Contact</h5>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="emergency_contact_name_onboard" class="form-label">Emergency Contact Name</label>
                  <input id="emergency_contact_name_onboard" class="form-control" type="text" name="emergency_contact_name" value="{{ user.emergency_contact_name or '' }}">
                </div>
                <div class="col-md-6">
                  <label for="emergency_contact_relationship_onboard" class="form-label">Relationship</label>
                  <input id="emergency_contact_relationship_onboard" class="form-control" type="text" name="emergency_contact_relationship" value="{{ user.emergency_contact_relationship or '' }}">
                </div>
                <div class="col-md-6">
                  <label for="emergency_contact_phone" class="form-label">Emergency Contact Phone</label>
                  <input id="emergency_contact_phone" class="form-control" type="text" name="emergency_contact_phone" value="{{ user.emergency_contact_phone or '' }}">
                </div>
              </div>
            {% endif %}

            <div class="d-flex justify-content-between align-items-center mt-4">
              <a class="btn btn-outline-secondary" href="{{ url_for('main.signup') }}">Back to Sign Up</a>
              <div class="d-flex gap-2">
                <button class="btn btn-light" type="submit" name="skip" value="1">Skip for now</button>
                <button class="btn btn-primary" type="submit">{{ 'Save & Finish' if s == total else 'Save & Continue' }}</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="footer bg-light border-top py-4">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center">
    <div class="mb-2 mb-md-0 text-center text-md-start">
      <span class="fw-bold" style="font-size: 1.1rem; color: #222;">&copy; 2025 SHAPADU SECURITY SDN BHD</span>
      <span class="text-muted ms-2" style="font-size: 0.95rem;">All rights reserved.</span>
    </div>
    <div class="d-flex flex-column flex-md-row align-items-center gap-2 gap-md-3 text-center text-md-end">
      <span class="ms-md-3">
        <a href="#" class="me-2" style="color: #495057;"><i class="bi bi-facebook"></i></a>
        <a href="#" class="me-2" style="color: #495057;"><i class="bi bi-twitter"></i></a>
        <a href="#" style="color: #495057;"><i class="bi bi-linkedin"></i></a>
      </span>
    </div>
  </div>
</footer>

<script>
  document.body.classList.add('signup-bg');
  function toggleIdField() {
    const citizen = document.getElementById('citizen');
    const icField = document.getElementById('ic_field');
    const passField = document.getElementById('passport_field');
    if (!citizen || !icField || !passField) return;
    const isCitizen = citizen.checked;
    if (isCitizen) {
      icField.style.display = 'block';
      passField.style.display = 'none';
    } else {
      icField.style.display = 'none';
      passField.style.display = 'block';
    }
  }
  function initExperienceForm(){
    const list = document.getElementById('experience-list');
    const addBtn = document.getElementById('add-experience');
    if(!list || !addBtn) return;
    function bindRemove(btn){
      btn.addEventListener('click', function(){
        const item = this.closest('.experience-item');
        if(item){ item.remove(); }
      });
    }
    // bind existing
    list.querySelectorAll('.remove-exp').forEach(bindRemove);

    function createItem(){
      const wrapper = document.createElement('div');
      wrapper.className = 'card border rounded-3 p-3 experience-item';
      wrapper.innerHTML = `
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label">Place / Company</label>
            <input type="text" class="form-control" name="exp_company" placeholder="Company name">
          </div>
          <div class="col-md-6">
            <label class="form-label">Position</label>
            <input type="text" class="form-control" name="exp_position" placeholder="e.g., Security Guard">
          </div>
          <div class="col-md-4">
            <label class="form-label">Recruitment Date</label>
            <input type="date" class="form-control" name="exp_recruitment">
          </div>
          <div class="col-md-4">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" name="exp_start">
          </div>
          <div class="col-md-4">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" name="exp_end">
          </div>
          <div class="col-md-6">
            <label class="form-label">Visa Number</label>
            <input type="text" class="form-control" name="exp_visa_number">
          </div>
          <div class="col-md-6">
            <label class="form-label">Visa Expiry Date</label>
            <input type="date" class="form-control" name="exp_visa_expiry">
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button type="button" class="btn btn-outline-danger btn-sm remove-exp">Remove</button>
          </div>
        </div>`;
      const removeBtn = wrapper.querySelector('.remove-exp');
      bindRemove(removeBtn);
      return wrapper;
    }
    addBtn.addEventListener('click', function(){
      list.appendChild(createItem());
    });
  }
  function initUploadPreview(){
    const input = document.getElementById('onboard-profile-input');
    const preview = document.getElementById('onboard-upload-preview');
    const placeholder = document.getElementById('onboard-upload-placeholder');
    if(!input || !preview) return;
    input.addEventListener('change', function(){
      const f = this.files && this.files[0];
      if(!f){
        if (preview) preview.style.display = 'none';
        if (placeholder) placeholder.style.display = 'block';
        return;
      }
      preview.src = URL.createObjectURL(f);
       preview.style.display = 'block';
       if (placeholder) placeholder.style.display = 'none';
    });
  }
  window.addEventListener('DOMContentLoaded', function(){
    toggleIdField();
    initExperienceForm();
    initUploadPreview();
  });
</script>
{% endblock %}
