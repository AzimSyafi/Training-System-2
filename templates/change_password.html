{% extends "base.html" %}

{% block title %}Change Password - Security Training System{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0 text-center">
                        <i class="bi bi-shield-lock me-2"></i>Change Password
                    </h4>
                </div>
                <div class="card-body p-4">
                    <!-- Flash Messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                    <i class="bi bi-{% if category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-triangle{% else %}x-circle{% endif %} me-2"></i>
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <p class="text-muted text-center mb-4">
                        Enter your current password and choose a new secure password. You will be logged out after successfully changing your password.
                    </p>

                    <form method="POST" action="{{ url_for('main.change_password') }}" id="changePasswordForm">
                        <!-- Current Password -->
                        <div class="mb-4">
                            <label for="current_password" class="form-label fw-medium">
                                Current Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="bi bi-lock"></i></span>
                                <input
                                    type="password"
                                    class="form-control py-2"
                                    id="current_password"
                                    name="current_password"
                                    required
                                    autocomplete="current-password"
                                    placeholder="Enter current password">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('current_password')">
                                    <i class="bi bi-eye" id="current_password_icon"></i>
                                </button>
                            </div>
                            <div class="error-message text-danger small mt-1" id="current_password_error" style="display: none;">
                                Current password is required
                            </div>
                        </div>

                        <!-- New Password -->
                        <div class="mb-4">
                            <label for="new_password" class="form-label fw-medium">
                                New Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="bi bi-key"></i></span>
                                <input
                                    type="password"
                                    class="form-control py-2"
                                    id="new_password"
                                    name="new_password"
                                    required
                                    minlength="8"
                                    autocomplete="new-password"
                                    placeholder="Enter new password">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('new_password')">
                                    <i class="bi bi-eye" id="new_password_icon"></i>
                                </button>
                            </div>

                            <!-- Password Strength Indicator -->
                            <div class="mt-3">
                                <div class="d-flex align-items-center mb-2">
                                    <small class="text-muted me-2">Password strength:</small>
                                    <div class="flex-grow-1">
                                        <div class="progress" style="height: 5px;">
                                            <div id="password_strength_bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <small id="password_strength_text" class="text-muted"></small>
                            </div>

                            <!-- Password Requirements -->
                            <div class="requirements mt-3">
                                <div class="requirement" id="length-req">
                                    <span class="requirement-icon">•</span>
                                    <span>At least 8 characters</span>
                                </div>
                                <div class="requirement" id="case-req">
                                    <span class="requirement-icon">•</span>
                                    <span>Uppercase and lowercase letters</span>
                                </div>
                                <div class="requirement" id="number-req">
                                    <span class="requirement-icon">•</span>
                                    <span>At least one number</span>
                                </div>
                                <div class="requirement" id="special-req">
                                    <span class="requirement-icon">•</span>
                                    <span>At least one special character</span>
                                </div>
                            </div>
                            <div class="error-message text-danger small mt-1" id="new_password_error" style="display: none;">
                                Please meet all password requirements
                            </div>
                        </div>

                        <!-- Confirm New Password -->
                        <div class="mb-4">
                            <label for="confirm_password" class="form-label fw-medium">
                                Confirm New Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="bi bi-check2-circle"></i></span>
                                <input
                                    type="password"
                                    class="form-control py-2"
                                    id="confirm_password"
                                    name="confirm_password"
                                    required
                                    minlength="8"
                                    autocomplete="new-password"
                                    placeholder="Re-enter new password">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirm_password')">
                                    <i class="bi bi-eye" id="confirm_password_icon"></i>
                                </button>
                            </div>
                            <div id="password_match_feedback" class="form-text mt-1"></div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg py-2" id="submitBtn">
                                <i class="bi bi-shield-check me-2"></i>Change Password
                            </button>
                            <a href="{% if current_user.is_authenticated %}{% if current_user.__class__.__name__ == 'Admin' %}{{ url_for('main.admin_dashboard') }}{% elif current_user.__class__.__name__ == 'Trainer' %}{{ url_for('main.trainer_portal') }}{% elif current_user.__class__.__name__ == 'User' %}{{ url_for('main.user_dashboard') }}{% elif current_user.__class__.__name__ == 'AgencyAccount' %}{{ url_for('main.agency_portal') }}{% else %}{{ url_for('main.index') }}{% endif %}{% else %}{{ url_for('main.index') }}{% endif %}" class="btn btn-outline-secondary py-2">
                                <i class="bi bi-arrow-left me-2"></i>Cancel
                            </a>
                        </div>
                    </form>

                    <!-- Security Tips -->
                    <div class="mt-5 p-4 bg-light rounded-3">
                        <h6 class="mb-3 fw-semibold"><i class="bi bi-lightbulb text-warning me-2"></i>Password Security Tips</h6>
                        <ul class="list-unstyled mb-0">
                            <li class="d-flex align-items-start mb-2">
                                <i class="bi bi-check-circle text-success me-2 mt-1"></i>
                                <span>Use a mix of uppercase, lowercase, numbers, and symbols</span>
                            </li>
                            <li class="d-flex align-items-start mb-2">
                                <i class="bi bi-check-circle text-success me-2 mt-1"></i>
                                <span>Avoid using personal information or common words</span>
                            </li>
                            <li class="d-flex align-items-start mb-2">
                                <i class="bi bi-check-circle text-success me-2 mt-1"></i>
                                <span>Don't reuse passwords from other accounts</span>
                            </li>
                            <li class="d-flex align-items-start">
                                <i class="bi bi-check-circle text-success me-2 mt-1"></i>
                                <span>Consider using a password manager</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle password visibility
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');

    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

// Password strength checker and requirements validation
document.getElementById('new_password').addEventListener('input', function() {
    const password = this.value;
    const strengthBar = document.getElementById('password_strength_bar');
    const strengthText = document.getElementById('password_strength_text');

    // Requirements elements
    const lengthReq = document.getElementById('length-req');
    const caseReq = document.getElementById('case-req');
    const numberReq = document.getElementById('number-req');
    const specialReq = document.getElementById('special-req');

    let strength = 0;
    let text = '';
    let color = '';

    // Check length requirement
    if (password.length >= 8) {
        strength += 25;
        lengthReq.classList.add('valid');
        lengthReq.querySelector('.requirement-icon').textContent = '✓';
        lengthReq.style.color = '#198754';
    } else {
        lengthReq.classList.remove('valid');
        lengthReq.querySelector('.requirement-icon').textContent = '•';
        lengthReq.style.color = '';
    }

    // Check case requirement
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) {
        strength += 25;
        caseReq.classList.add('valid');
        caseReq.querySelector('.requirement-icon').textContent = '✓';
        caseReq.style.color = '#198754';
    } else {
        caseReq.classList.remove('valid');
        caseReq.querySelector('.requirement-icon').textContent = '•';
        caseReq.style.color = '';
    }

    // Check number requirement
    if (/\d/.test(password)) {
        strength += 25;
        numberReq.classList.add('valid');
        numberReq.querySelector('.requirement-icon').textContent = '✓';
        numberReq.style.color = '#198754';
    } else {
        numberReq.classList.remove('valid');
        numberReq.querySelector('.requirement-icon').textContent = '•';
        numberReq.style.color = '';
    }

    // Check special character requirement
    if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
        strength += 25;
        specialReq.classList.add('valid');
        specialReq.querySelector('.requirement-icon').textContent = '✓';
        specialReq.style.color = '#198754';
    } else {
        specialReq.classList.remove('valid');
        specialReq.querySelector('.requirement-icon').textContent = '•';
        specialReq.style.color = '';
    }

    // Update strength indicator
    if (strength <= 25) {
        text = 'Weak';
        color = 'bg-danger';
    } else if (strength <= 50) {
        text = 'Fair';
        color = 'bg-warning';
    } else if (strength <= 75) {
        text = 'Good';
        color = 'bg-info';
    } else {
        text = 'Strong';
        color = 'bg-success';
    }

    strengthBar.style.width = strength + '%';
    strengthBar.className = 'progress-bar ' + color;
    strengthText.textContent = password.length > 0 ? 'Strength: ' + text : '';
});

// Password match validator
const newPassword = document.getElementById('new_password');
const confirmPassword = document.getElementById('confirm_password');
const matchFeedback = document.getElementById('password_match_feedback');
const submitBtn = document.getElementById('submitBtn');

function validatePasswordMatch() {
    if (confirmPassword.value.length === 0) {
        matchFeedback.textContent = '';
        matchFeedback.className = 'form-text';
        confirmPassword.classList.remove('is-invalid', 'is-valid');
        return;
    }

    if (newPassword.value === confirmPassword.value) {
        matchFeedback.innerHTML = '<i class="bi bi-check-circle text-success me-1"></i>Passwords match';
        matchFeedback.className = 'form-text text-success';
        confirmPassword.classList.remove('is-invalid');
        confirmPassword.classList.add('is-valid');
    } else {
        matchFeedback.innerHTML = '<i class="bi bi-x-circle text-danger me-1"></i>Passwords do not match';
        matchFeedback.className = 'form-text text-danger';
        confirmPassword.classList.remove('is-valid');
        confirmPassword.classList.add('is-invalid');
    }
}

newPassword.addEventListener('input', validatePasswordMatch);
confirmPassword.addEventListener('input', validatePasswordMatch);

// Form validation before submit
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    const currentPwd = document.getElementById('current_password').value;
    const newPwd = document.getElementById('new_password').value;
    const confirmPwd = document.getElementById('confirm_password').value;
    let hasErrors = false;

    // Reset error messages
    document.getElementById('current_password_error').style.display = 'none';
    document.getElementById('new_password_error').style.display = 'none';
    document.getElementById('current_password').classList.remove('is-invalid');
    document.getElementById('new_password').classList.remove('is-invalid');

    // Validate current password
    if (!currentPwd) {
        document.getElementById('current_password_error').style.display = 'block';
        document.getElementById('current_password').classList.add('is-invalid');
        hasErrors = true;
    }

    // Validate new password requirements
    const isStrongPassword = newPwd.length >= 8 &&
                            /[a-z]/.test(newPwd) &&
                            /[A-Z]/.test(newPwd) &&
                            /\d/.test(newPwd) &&
                            /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPwd);

    if (!isStrongPassword) {
        document.getElementById('new_password_error').style.display = 'block';
        document.getElementById('new_password').classList.add('is-invalid');
        hasErrors = true;
    }

    // Validate password match
    if (newPwd !== confirmPwd) {
        matchFeedback.innerHTML = '<i class="bi bi-x-circle text-danger me-1"></i>Passwords do not match';
        matchFeedback.className = 'form-text text-danger';
        confirmPassword.classList.add('is-invalid');
        hasErrors = true;
    }

    // Check if new password is different from current
    if (currentPwd === newPwd) {
        alert('New password must be different from your current password.');
        hasErrors = true;
    }

    if (hasErrors) {
        e.preventDefault();
        return false;
    }

    // Disable submit button to prevent double submission
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Changing Password...';
});
</script>

<style>
/* Enhanced styling */
.card {
    border-radius: 12px;
    overflow: hidden;
}

.card-header {
    border-bottom: none;
}

.form-control {
    border-radius: 8px;
    transition: all 0.2s;
}

.form-control:focus {
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    border-color: #0d6efd;
}

.input-group-text {
    border-radius: 8px 0 0 8px;
}

.btn-outline-secondary {
    border-radius: 0 8px 8px 0;
}

.requirements {
    font-size: 0.875rem;
}

.requirement {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
    transition: color 0.3s;
}

.requirement-icon {
    margin-right: 8px;
    font-size: 12px;
    width: 16px;
    text-align: center;
}

.requirement.valid {
    color: #198754;
}

.error-message {
    font-size: 0.875rem;
}

/* Dark mode support */
.darkmode .card {
    background-color: #1a1f2e;
    border-color: #2d3748;
}

.darkmode .card-body {
    color: #e2e8f0;
}

.darkmode .form-control {
    background-color: #2d3748;
    border-color: #4a5568;
    color: #e2e8f0;
}

.darkmode .form-control:focus {
    background-color: #374151;
    border-color: #0d6efd;
    color: #e2e8f0;
}

.darkmode .input-group-text {
    background-color: #2d3748;
    border-color: #4a5568;
    color: #e2e8f0;
}

.darkmode .btn-outline-secondary {
    color: #e2e8f0;
    border-color: #4a5568;
}

.darkmode .btn-outline-secondary:hover {
    background-color: #374151;
    border-color: #4a5568;
    color: #e2e8f0;
}

.darkmode .bg-light {
    background-color: #2d3748 !important;
}

.darkmode .text-muted {
    color: #9ca3af !important;
}

.darkmode .alert {
    border-color: #4a5568;
}

.darkmode .progress {
    background-color: #374151;
}

.darkmode .requirements {
    color: #e2e8f0;
}
</style>
{% endblock %}