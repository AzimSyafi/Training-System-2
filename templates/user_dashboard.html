{% extends "base.html" %}

{% block styles %}
<style>
  /* Reuse trainer stat card style */
  .stats-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:20px; margin-bottom:30px; }
  .stat-card { background:var(--card-bg); border-radius:10px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.05); display:flex; align-items:center; gap:15px; transition:all .3s ease; }
  .stat-card:hover { transform:translateY(-5px); box-shadow:0 5px 15px rgba(0,0,0,0.12); }
  .stat-icon { width:50px; height:50px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; }
  .stat-icon.enrolled { background:rgba(59,130,246,0.15); color:#3b82f6; }
  .stat-icon.completed { background:rgba(16,185,129,0.15); color:#10b981; }
  .stat-icon.certificates { background:rgba(245,158,11,0.15); color:#f59e0b; }
  .stat-info { flex:1; }
  .stat-title { font-size:14px; color:var(--text-secondary); margin-bottom:4px; }
  .stat-value { font-size:24px; font-weight:600; }
  .stat-change { font-size:12px; color:var(--text-secondary); display:flex; align-items:center; gap:4px; }
   .profile-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:20px; }
   .info-card { background:var(--card-bg); border-radius:10px; padding:16px 18px; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
   .info-title { font-size:14px; font-weight:600; color:var(--primary-text,#0f172a); display:flex; align-items:center; gap:6px; margin-bottom:6px; }
   .info-body { font-size:14px; color:var(--text-secondary); }
   /* Module styles retained in case reused elsewhere but section removed */
   .modules-section-title { font-size:20px; font-weight:600; margin:30px 0 15px; display:flex; align-items:center; gap:10px; }
   .module-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:20px; }
   .module-card { background:var(--card-bg); border-radius:12px; padding:22px 22px 18px; box-shadow:0 2px 10px rgba(0,0,0,0.05); position:relative; border-left:4px solid var(--primary,#3b82f6); transition:.3s ease; cursor:pointer; }
   .module-card:hover { transform:translateY(-6px); box-shadow:0 6px 18px rgba(0,0,0,0.12); }
   body.dark-mode .module-card { box-shadow:0 2px 10px rgba(0,0,0,0.4); }
   body.dark-mode .module-card:hover { box-shadow:0 6px 22px rgba(0,0,0,0.55); }
   .course-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:20px; margin-top:10px; }
   .course-card { background:var(--card-bg); border-radius:14px; padding:20px 22px 18px; box-shadow:0 2px 10px rgba(0,0,0,0.05); position:relative; overflow:hidden; border:1px solid rgba(0,0,0,0.06); transition:.3s ease; }
   .course-card:hover { transform:translateY(-5px); box-shadow:0 6px 18px rgba(0,0,0,0.12); }
   .course-badge { display:inline-block; font-size:11px; font-weight:600; letter-spacing:.5px; padding:4px 10px; border-radius:30px; background:#eff6ff; color:#1d4ed8; margin-bottom:10px; }
   body.dark-mode .course-badge { background:rgba(59,130,246,0.15); color:#93c5fd; }
   .course-title { font-size:16px; font-weight:600; margin:0 0 8px; line-height:1.25; }
   .course-progress-wrap { margin:12px 0 8px; }
   .course-progress-bar { height:8px; background:#e5e7eb; border-radius:6px; overflow:hidden; position:relative; }
   .course-progress-bar > span { display:block; height:100%; background:linear-gradient(90deg,#2563eb,#1d4ed8); width:0; transition:width .6s ease; }
   body.dark-mode .course-progress-bar { background:#374151; }
   .course-stats { font-size:12px; display:flex; justify-content:space-between; color:var(--text-secondary); margin-top:2px; }
   .course-actions { display:none; }
   .btn-sm { font-size:12px; padding:6px 12px; border-radius:6px; font-weight:500; }
   .empty-courses { background:var(--card-bg); border:1px dashed #cbd5e1; padding:24px; text-align:center; border-radius:12px; }
   body.dark-mode .empty-courses { border-color:#475569; }
   /* Quick Actions */
   .quick-actions { background:var(--card-bg); border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.06); padding:16px; margin-bottom:24px; }
   .quick-actions h5 { font-size:18px; font-weight:600; margin:0 0 12px; display:flex; align-items:center; gap:8px; }
   .qa-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; }
   /* Base button */
   .qa-btn { display:flex; align-items:center; gap:12px; padding:14px 16px; border-radius:14px; color:#fff; text-decoration:none; box-shadow:0 2px 8px rgba(0,0,0,0.08); transition:transform .2s ease, box-shadow .2s ease, filter .2s ease; border:0; background:#3b82f6; }
   .qa-btn:hover { transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,0.16); filter:saturate(1.05); }
   .qa-btn:focus { outline:2px solid rgba(255,255,255,.6); outline-offset:2px; }
   .qa-btn .label { font-weight:600; }
   .qa-icon { width:44px; height:44px; border-radius:999px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,.2); border:1px solid rgba(255,255,255,.25); flex:0 0 auto; }
   .qa-btn i { font-size:16px; }
   /* Color variants */
   .qa-indigo { background:linear-gradient(90deg,#6366f1,#4f46e5); }
   .qa-blue   { background:linear-gradient(90deg,#3b82f6,#2563eb); }
   .qa-slate  { background:linear-gradient(90deg,#64748b,#475569); }
   .qa-emerald{ background:linear-gradient(90deg,#10b981,#059669); }
   .qa-purple { background:linear-gradient(90deg,#a855f7,#7c3aed); }
   .qa-orange { background:linear-gradient(90deg,#f59e0b,#ea580c); }
   .qa-rose   { background:linear-gradient(90deg,#f43f5e,#ef4444); }
   /* Ensure text remains readable in dark mode */
   body.dark-mode .qa-btn { color:#fff; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <h2 class="mb-4" style="font-size:26px; font-weight:600; display:flex; align-items:center; gap:10px;"><i class="fas fa-user-shield"></i> Dashboard</h2>

  {# Determine role early for conditional rendering #}
  {% set is_authority = (current_user.role | default('')) == 'authority' %}

  {# Course-level stats #}
  {% set total_courses = (courses_progress|length) if courses_progress else 0 %}
  {% set enrolled_courses = course_enrolled_count or 0 %}
  {% set completed_courses = course_completed_count or 0 %}
  {% set completion_pct_courses = ((completed_courses / total_courses) * 100) if total_courses > 0 else 0 %}
  {% set certificates_count = user.certificates|length %}

  {# Determine course code for grade calculation - use first available course or fallback #}
  {% if courses and courses|length > 0 %}
    {% set grade_course_code = courses[0].code %}
  {% else %}
    {% set grade_course_code = 'CSG' %}  {# Default fallback #}
  {% endif %}
  {% set grade = user.get_overall_grade_for_course(grade_course_code) %}

  {% if not is_authority %}
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-icon enrolled"><i class="fas fa-book"></i></div>
      <div class="stat-info">
        <div class="stat-title">Courses Enrolled</div>
        <div class="stat-value">{{ enrolled_courses }}</div>
        <div class="stat-change"><i class="fas fa-layer-group"></i> of {{ total_courses }} available</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon completed"><i class="fas fa-check-circle"></i></div>
      <div class="stat-info">
        <div class="stat-title">Courses Completed</div>
        <div class="stat-value">{{ completed_courses }}</div>
        <div class="stat-change">{{ completion_pct_courses|round(1) }}% complete</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon certificates"><i class="fas fa-certificate"></i></div>
      <div class="stat-info">
        <div class="stat-title">Certificates</div>
        <div class="stat-value">{{ certificates_count }}</div>
        <div class="stat-change">Earned</div>
      </div>
    </div>
  </div>
  {% endif %}

  {% if (not is_authority) and (not courses_progress) %}
    <div class="alert alert-info mb-4">
      <h5 class="mb-2"><i class="fas fa-info-circle"></i> Welcome!</h5>
      <p class="mb-0">Your courses will appear here once available.</p>
    </div>
  {% endif %}

  <div class="card mb-4 shadow-sm" style="border-radius:12px;">
    <div class="card-body d-flex flex-column flex-md-row align-items-center gap-4">
      <img src="{{ user.profile_pic_url or url_for('static', filename='default_avatar.png') }}" alt="Profile" class="rounded-circle border border-3 border-primary" style="width:110px;height:110px;object-fit:cover;">
      <div class="flex-grow-1 row w-100">
        <div class="col-sm-6 mb-3">
          <div class="text-muted small">Name</div>
          <div class="fw-semibold">{{ user.full_name }}</div>
        </div>
        <div class="col-sm-6 mb-3">
          <div class="text-muted small">Email</div>
            <div class="fw-semibold">{{ user.email }}</div>
        </div>
        <div class="col-sm-6 mb-3">
          <div class="text-muted small">User ID</div>
          <div class="fw-semibold">{{ user.displayed_id }}</div>
        </div>
        <div class="col-sm-6 mb-3">
          <div class="text-muted small">Phone</div>
          <div class="fw-semibold">{{ user.emergency_contact_phone or 'N/A' }}</div>
        </div>
      </div>
    </div>
  </div>

  {# Profile info cards; hide certain cards for authority users #}
  {% set is_authority = (current_user.role | default('')) == 'authority' %}
  <div class="profile-grid mb-4">
    {% if not is_authority %}
    <div class="info-card">
      <div class="info-title"><i class="fas fa-briefcase"></i>Working Experience</div>
      <div class="info-body">
        {% if user.work_histories and user.work_histories|length > 0 %}
          <ul class="m-0 ps-3">
            {% for exp in user.work_histories[:4] %}
              <li class="mb-1">
                <span class="fw-semibold">{{ exp.company_name }}</span>
                {% if exp.position_title %}- <span class="text-muted">{{ exp.position_title }}</span>{% endif %}
                <div class="small text-muted">
                  {{ exp.start_date.strftime('%Y-%m-%d') if exp.start_date else '-' }} to {{ exp.end_date.strftime('%Y-%m-%d') if exp.end_date else '-' }}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          {{ user.working_experience or '—' }}
        {% endif %}
      </div>
    </div>
    <div class="info-card">
      <div class="info-title"><i class="fas fa-building"></i>Current Workplace</div>
      <div class="info-body">{{ user.current_workplace or '—' }}</div>
    </div>
    <div class="info-card">
      <div class="info-title"><i class="fas fa-shield-alt"></i>Agency</div>
      <div class="info-body">{{ user.agency.agency_name if user.agency else '—' }}</div>
    </div>
    <div class="info-card">
      <div class="info-title"><i class="fas fa-user-friends"></i>Emergency Contact</div>
      <div class="info-body">
        <div class="fw-semibold">{{ user.emergency_contact_name or '—' }}</div>
        <div class="small text-muted">{{ user.emergency_contact_relationship or '' }}</div>
        <div class="mt-1">{{ user.emergency_contact_phone or '' }}</div>
      </div>
    </div>
    {% endif %}
  </div>

  {% if not is_authority %}
  <h3 class="modules-section-title" style="margin-top:10px; display:flex; align-items:center; gap:10px;">
    <i class="fas fa-graduation-cap"></i> My Courses
  </h3>

  {% if courses_progress and courses_progress|length > 0 %}
    <div class="course-grid">
      {% for c in courses_progress %}
      <div class="course-card">
        <div class="course-badge">{{ c.code }}</div>
        <h4 class="course-title">{{ c.name }}</h4>
        <div class="course-progress-wrap">
          <div class="course-progress-bar"><span style="width: {{ c.progress }}%"></span></div>
          <div class="course-stats"><span>{{ c.completed_modules }}/{{ c.total_modules }} modules</span><span>{{ c.progress }}%</span></div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-courses mb-4">
      <h6 class="mb-2"><i class="fas fa-info-circle"></i> No Courses Available</h6>
      <p class="mb-2 small">Courses for your category are not configured yet. Please check back later.</p>
    </div>
  {% endif %}
  {% endif %}

  <!-- Quick Actions moved to bottom of page -->
  {% set has_enrollment = (enrolled_courses > 0) %}
  <section class="quick-actions mt-4">
    <div class="d-flex align-items-center gap-2 mb-3">
      <i class="fas fa-bolt text-warning"></i>
      <h5 class="m-0">Quick Actions</h5>
    </div>

    <div class="qa-grid">
      {% if not is_authority %}
      <a href="{{ url_for('courses') }}" class="qa-btn qa-blue" aria-label="Continue Learning or Explore Courses">
        <span class="qa-icon"><i class="fas fa-play"></i></span>
        <span class="label">{% if has_enrollment and completion_pct_courses < 100 %}Continue Learning{% else %}Explore Courses{% endif %}</span>
      </a>
      {% endif %}

      <a href="{{ url_for('profile') }}" class="qa-btn qa-slate" aria-label="Edit Profile">
        <span class="qa-icon"><i class="fas fa-user"></i></span>
        <span class="label">Edit Profile</span>
      </a>

      {% if not is_authority %}
      <a href="{{ url_for('my_certificates') }}" class="qa-btn qa-emerald" aria-label="View Certificates">
        <span class="qa-icon"><i class="fas fa-award"></i></span>
        <span class="label">Certificates</span>
      </a>

      <a href="{{ url_for('agency') }}" class="qa-btn qa-purple" aria-label="Agency">
        <span class="qa-icon"><i class="fas fa-building"></i></span>
        <span class="label">Agency</span>
      </a>
      {% else %}
      <a href="{{ url_for('authority.authority_portal') }}" class="qa-btn qa-purple" aria-label="Certificate Approval">
        <span class="qa-icon"><i class="fas fa-certificate"></i></span>
        <span class="label">Certificate Approval</span>
      </a>
      {% endif %}
    </div>

    <div class="mt-4 pt-3" style="border-top:1px solid var(--border-color);">
      <form action="{{ url_for('logout') }}" method="post" class="m-0">
        <button type="submit" class="qa-btn qa-rose w-100 justify-content-center" aria-label="Logout">
          <span class="qa-icon"><i class="fas fa-sign-out-alt"></i></span>
          <span class="label">Logout</span>
        </button>
      </form>
    </div>
  </section>

</div>
{% endblock %}
