{% extends "base.html" %}

{% block styles %}
<style>
  /* Reuse trainer stat card style */
  .stats-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:20px; margin-bottom:30px; }
  .stat-card { background:var(--card-bg); border-radius:10px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.05); display:flex; align-items:center; gap:15px; transition:all .3s ease; }
  .stat-card:hover { transform:translateY(-5px); box-shadow:0 5px 15px rgba(0,0,0,0.12); }
  .stat-icon { width:50px; height:50px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; }
  .stat-icon.enrolled { background:rgba(59,130,246,0.15); color:#3b82f6; }
  .stat-icon.completed { background:rgba(16,185,129,0.15); color:#10b981; }
  .stat-icon.certificates { background:rgba(245,158,11,0.15); color:#f59e0b; }
  .stat-info { flex:1; }
  .stat-title { font-size:14px; color:var(--text-secondary); margin-bottom:4px; }
  .stat-value { font-size:24px; font-weight:600; }
  .stat-change { font-size:12px; color:var(--text-secondary); display:flex; align-items:center; gap:4px; }
   .profile-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:20px; }
   .info-card { background:var(--card-bg); border-radius:10px; padding:16px 18px; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
   .info-title { font-size:14px; font-weight:600; color:var(--primary-text,#0f172a); display:flex; align-items:center; gap:6px; margin-bottom:6px; }
   .info-body { font-size:14px; color:var(--text-secondary); }
   /* Module styles retained in case reused elsewhere but section removed */
   .modules-section-title { font-size:20px; font-weight:600; margin:30px 0 15px; display:flex; align-items:center; gap:10px; }
   .module-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:20px; }
   .module-card { background:var(--card-bg); border-radius:12px; padding:22px 22px 18px; box-shadow:0 2px 10px rgba(0,0,0,0.05); position:relative; border-left:4px solid var(--primary,#3b82f6); transition:.3s ease; cursor:pointer; }
   .module-card:hover { transform:translateY(-6px); box-shadow:0 6px 18px rgba(0,0,0,0.12); }
   body.dark-mode .module-card { box-shadow:0 2px 10px rgba(0,0,0,0.4); }
   body.dark-mode .module-card:hover { box-shadow:0 6px 22px rgba(0,0,0,0.55); }
   .course-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:20px; margin-top:10px; }
   .course-card { background:var(--card-bg); border-radius:14px; padding:20px 22px 18px; box-shadow:0 2px 10px rgba(0,0,0,0.05); position:relative; overflow:hidden; border:1px solid rgba(0,0,0,0.06); transition:.3s ease; }
   .course-card:hover { transform:translateY(-5px); box-shadow:0 6px 18px rgba(0,0,0,0.12); }
   .course-badge { display:inline-block; font-size:11px; font-weight:600; letter-spacing:.5px; padding:4px 10px; border-radius:30px; background:#eff6ff; color:#1d4ed8; margin-bottom:10px; }
   body.dark-mode .course-badge { background:rgba(59,130,246,0.15); color:#93c5fd; }
   .course-title { font-size:16px; font-weight:600; margin:0 0 8px; line-height:1.25; }
   .course-progress-wrap { margin:12px 0 8px; }
   .course-progress-bar { height:8px; background:#e5e7eb; border-radius:6px; overflow:hidden; position:relative; }
   .course-progress-bar > span { display:block; height:100%; background:linear-gradient(90deg,#2563eb,#1d4ed8); width:0; transition:width .6s ease; }
   body.dark-mode .course-progress-bar { background:#374151; }
   .course-stats { font-size:12px; display:flex; justify-content:space-between; color:var(--text-secondary); margin-top:2px; }
   .course-actions { display:none; }
   .btn-sm { font-size:12px; padding:6px 12px; border-radius:6px; font-weight:500; }
   .empty-courses { background:var(--card-bg); border:1px dashed #cbd5e1; padding:24px; text-align:center; border-radius:12px; }
   body.dark-mode .empty-courses { border-color:#475569; }
 </style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <h2 class="mb-4" style="font-size:26px; font-weight:600; display:flex; align-items:center; gap:10px;"><i class="fas fa-user-shield"></i> Trainee Dashboard</h2>

  {# Course-level stats #}
  {% set total_courses = (courses_progress|length) if courses_progress else 0 %}
  {% set enrolled_courses = course_enrolled_count or 0 %}
  {% set completed_courses = course_completed_count or 0 %}
  {% set completion_pct_courses = ((completed_courses / total_courses) * 100) if total_courses > 0 else 0 %}
  {% set certificates_count = user.certificates|length %}
  {% set grade = user.get_overall_grade_for_course(grade_course_code) %}

  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-icon enrolled"><i class="fas fa-book"></i></div>
      <div class="stat-info">
        <div class="stat-title">Courses Enrolled</div>
        <div class="stat-value">{{ enrolled_courses }}</div>
        <div class="stat-change"><i class="fas fa-layer-group"></i> of {{ total_courses }} available</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon completed"><i class="fas fa-check-circle"></i></div>
      <div class="stat-info">
        <div class="stat-title">Courses Completed</div>
        <div class="stat-value">{{ completed_courses }}</div>
        <div class="stat-change">{{ completion_pct_courses|round(1) }}% complete</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon certificates"><i class="fas fa-certificate"></i></div>
      <div class="stat-info">
        <div class="stat-title">Certificates</div>
        <div class="stat-value">{{ certificates_count }}</div>
        <div class="stat-change">Earned</div>
      </div>
    </div>
  </div>

  {% if not courses_progress %}
    <div class="alert alert-info mb-4">
      <h5 class="mb-2"><i class="fas fa-info-circle"></i> Welcome!</h5>
      <p class="mb-0">Your courses will appear here once available.</p>
    </div>
  {% endif %}

  <div class="card mb-4 shadow-sm" style="border-radius:12px;">
    <div class="card-body d-flex flex-column flex-md-row align-items-center gap-4">
      <img src="{{ user.profile_pic_url or url_for('static', filename='default_avatar.png') }}" alt="Profile" class="rounded-circle border border-3 border-primary" style="width:110px;height:110px;object-fit:cover;">
      <div class="flex-grow-1 row w-100">
        <div class="col-sm-6 mb-3">
          <div class="text-muted small">Name</div>
          <div class="fw-semibold">{{ user.full_name }}</div>
        </div>
        <div class="col-sm-6 mb-3">
          <div class="text-muted small">Email</div>
            <div class="fw-semibold">{{ user.email }}</div>
        </div>
        <div class="col-sm-6 mb-3">
          <div class="text-muted small">User ID</div>
          <div class="fw-semibold">{{ user.displayed_id }}</div>
        </div>
        <div class="col-sm-6 mb-3">
          <div class="text-muted small">Phone</div>
          <div class="fw-semibold">{{ user.emergency_contact_phone or 'N/A' }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="profile-grid mb-4">
    <div class="info-card">
      <div class="info-title"><i class="fas fa-briefcase"></i>Working Experience</div>
      <div class="info-body">{{ user.working_experience or '—' }}</div>
    </div>
    <div class="info-card">
      <div class="info-title"><i class="fas fa-building"></i>Current Workplace</div>
      <div class="info-body">{{ user.current_workplace or '—' }}</div>
    </div>
    <div class="info-card">
      <div class="info-title"><i class="fas fa-shield-alt"></i>Agency</div>
      <div class="info-body">{{ user.agency.agency_name if user.agency else '—' }}</div>
    </div>
    <div class="info-card">
      <div class="info-title"><i class="fas fa-user-friends"></i>Emergency Contact</div>
      <div class="info-body">
        <div class="fw-semibold">{{ user.emergency_contact_name or '—' }}</div>
        <div class="small text-muted">{{ user.emergency_contact_relationship or '' }}</div>
        <div class="mt-1">{{ user.emergency_contact_phone or '' }}</div>
      </div>
    </div>
  </div>

  <h3 class="modules-section-title" style="margin-top:10px; display:flex; align-items:center; gap:10px;">
    <i class="fas fa-graduation-cap"></i> My Courses
  </h3>

  {% if courses_progress and courses_progress|length > 0 %}
    <div class="course-grid">
      {% for c in courses_progress %}
      <div class="course-card">
        <div class="course-badge">{{ c.code }}</div>
        <h4 class="course-title">{{ c.name }}</h4>
        <div class="course-progress-wrap">
          <div class="course-progress-bar"><span style="width: {{ c.progress }}%"></span></div>
          <div class="course-stats"><span>{{ c.completed_modules }}/{{ c.total_modules }} modules</span><span>{{ c.progress }}%</span></div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-courses mb-4">
      <h6 class="mb-2"><i class="fas fa-info-circle"></i> No Courses Available</h6>
      <p class="mb-2 small">Courses for your category are not configured yet. Please check back later.</p>
    </div>
  {% endif %}

</div>
{% endblock %}
