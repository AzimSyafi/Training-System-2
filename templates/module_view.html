{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="mb-3">
            <a href="{{ url_for('main.courses') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Courses
            </a>
        </div>
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-book"></i> {{ module.module_name }}</h3>
                <p class="text-muted">{{ module.module_type }} - {{ module.series_number }}</p>
            </div>
            <div class="card-body">
                <!-- Module Content -->
                <div class="mb-4">
                    <h5>Module Content</h5>
                    {% set video_id = module.content | youtube_id %}
                    {% if video_id %}
                        <div class="ratio ratio-16x9">
                            <iframe src="https://www.youtube.com/embed/{{ video_id }}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    {% else %}
                        <div class="border p-3 bg-light">
                            {{ module.content|safe }}
                        </div>
                    {% endif %}
                </div>

                <!-- Module Status -->
                {% if user_module.is_completed %}
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle"></i> Module Completed!</h5>
                        <p>Your Score:
                            <span class="{% if user_module.score <= 50 %}score-red{% elif user_module.score > 75 %}score-green{% else %}score-blue{% endif %}">
                                {{ user_module.score }}%
                            </span>
                        </p>
                        <p>Completed on: {{ user_module.completion_date.strftime('%B %d, %Y at %I:%M %p') if user_module.completion_date else 'N/A' }}</p>
                    </div>
                {% else %}
                    <!-- Assessment Section -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="fas fa-tasks"></i> Module Assessment</h5>
                        </div>
                        <div class="card-body">
                            <p>Complete this assessment to finish the module and receive your score.</p>
                            <form method="POST" action="{{ url_for('complete_module', module_id=module.module_id) }}">
                                <div class="mb-3">
                                    <label for="score" class="form-label">Assessment Score (%)</label>
                                    <input type="number" class="form-control" id="score" name="score" min="0" max="100" required>
                                    <div class="form-text">
                                        <strong>Scoring Guidelines:</strong><br>
                                        <span class="score-red">â‰¤ 50%: Needs Improvement (Red)</span><br>
                                        <span class="score-blue">51-75%: Satisfactory (Blue)</span><br>
                                        <span class="score-green">> 75%: Excellent (Green)</span>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check"></i> Complete Module
                                </button>
                            </form>
                        </div>
                    </div>
                {% endif %}

                <!-- Module Details -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h6>Module Information</h6>
                        <ul class="list-group">
                            <li class="list-group-item">
                                <strong>Type:</strong> {{ module.module_type }}
                            </li>
                            <li class="list-group-item">
                                <strong>Series:</strong> {{ module.series_number }}
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Add Content Button -->
                <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#uploadContentModal">
                    <i class="fas fa-upload"></i> Add/Upload Content
                </button>

                <!-- Upload Content Modal (rewritten for module selection and content type tabs) -->
                <div class="modal fade" id="uploadContentModal" tabindex="-1" aria-labelledby="uploadContentModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="uploadContentModalLabel"><i class="fas fa-upload"></i> Upload Content to Module</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <form method="POST" action="{{ url_for('main.upload_content') }}" enctype="multipart/form-data" id="contentForm">
                          <div class="form-group mb-3">
                            <label for="moduleSelect" class="form-label">Select Module</label>
                            <select class="form-select" id="moduleSelect" name="module_id" required>
                              <option value="" disabled selected>Select a module</option>
                              {% for m in modules %}
                                <option value="{{ m.module_id }}">{{ m.module_name }}</option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="form-group mb-3">
                            <label class="form-label">Content Type</label>
                            <div class="btn-group w-100 mb-2" role="group" aria-label="Content type tabs">
                              <button type="button" class="btn btn-outline-primary active" id="tabSlides">Slides</button>
                              <button type="button" class="btn btn-outline-primary" id="tabVideo">Video</button>
                              <button type="button" class="btn btn-outline-primary" id="tabQuiz">Quiz</button>
                            </div>
                            <input type="hidden" name="content_type" id="contentType" value="slide">
                          </div>
                          <div class="form-group mb-3" id="slideUpload" style="display:block;">
                            <label class="form-label">Upload Slide (PDF or PPTX)</label>
                            <input type="file" name="slide_file" accept=".pdf,.pptx" class="form-control" id="slideFileInput">
                          </div>
                          <div class="form-group mb-3" id="videoUpload" style="display:none;">
                            <label class="form-label">YouTube Video URL</label>
                            <input type="url" name="youtube_url" id="youtubeUrl" class="form-control" placeholder="Paste YouTube video link here">
                            <small class="form-text text-muted">Provide a YouTube link to embed a video for this module.</small>
                            <div id="videoPreview" class="mt-2" style="display:none;"></div>
                          </div>
                          <div class="form-group mb-3" id="quizUpload" style="display:none;">
                            <label class="form-label">Quiz</label>
                            <div class="d-flex align-items-center gap-2 mb-2">
                              <button type="button" class="btn btn-sm btn-outline-secondary" id="qcount-decr">&minus;</button>
                              <input id="qcount-input" type="number" min="1" max="5" value="1" class="form-control form-control-sm" style="width:80px" />
                              <button type="button" class="btn btn-sm btn-outline-secondary" id="qcount-incr">+</button>
                              <small class="text-muted ms-2">Questions</small>
                            </div>

                            <div class="accordion" id="modalQuizAccordion">
                              <!-- Five question slots; they'll be shown/hidden based on the count control -->
                              {% for qn in range(1,6) %}
                              <div class="accordion-item mb-2 quiz-panel" data-qnum="{{ qn }}" style="display: none;">
                                <h2 class="accordion-header" id="modalHeading{{ qn }}">
                                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#modalCollapse{{ qn }}">
                                    Question {{ qn }}
                                  </button>
                                </h2>
                                <div id="modalCollapse{{ qn }}" class="accordion-collapse collapse" data-bs-parent="#modalQuizAccordion">
                                  <div class="accordion-body">
                                    <div class="mb-2">
                                      <label class="form-label">Question Text</label>
                                      <input type="text" class="form-control" name="quiz_question_{{ qn }}" />
                                    </div>
                                    <div class="row g-2">
                                      {% for an in range(1,6) %}
                                      <div class="col-md-6">
                                        <label class="form-label small mb-0">Answer {{ an }}</label>
                                        <input type="text" class="form-control form-control-sm" name="answer_{{ qn }}_{{ an }}" />
                                      </div>
                                      {% endfor %}
                                    </div>
                                    <div class="mt-2">
                                      <label class="form-label">Correct Answer (1-5)</label>
                                      <select name="correct_answer_{{ qn }}" class="form-select form-select-sm">
                                        <option value="">--</option>
                                        {% for an in range(1,6) %}
                                          <option value="{{ an }}">{{ an }}</option>
                                        {% endfor %}
                                      </select>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              {% endfor %}
                            </div>
                            <div class="alert alert-info mt-2 py-2">Leave unused questions blank; they'll be ignored.</div>
                          </div>
                          <div class="form-group mt-4">
                            <button type="submit" class="btn btn-primary w-100">
                              <i class="fas fa-save"></i> Save Content
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
                <script>
                  document.addEventListener('DOMContentLoaded', function() {
                    const tabSlides = document.getElementById('tabSlides');
                    const tabVideo = document.getElementById('tabVideo');
                    const tabQuiz = document.getElementById('tabQuiz');
                    const slideUpload = document.getElementById('slideUpload');
                    const videoUpload = document.getElementById('videoUpload');
                    const quizUpload = document.getElementById('quizUpload');
                    const youtubeUrl = document.getElementById('youtubeUrl');
                    const videoPreview = document.getElementById('videoPreview');
                    const contentTypeInput = document.getElementById('contentType');
                    const contentForm = document.getElementById('contentForm');
                    // Tab logic
                    function showTab(tab) {
                      tabSlides.classList.remove('active');
                      tabVideo.classList.remove('active');
                      tabQuiz.classList.remove('active');
                      slideUpload.style.display = 'none';
                      videoUpload.style.display = 'none';
                      quizUpload.style.display = 'none';
                      if (tab === 'slide') {
                        tabSlides.classList.add('active');
                        slideUpload.style.display = 'block';
                        contentTypeInput.value = 'slide';
                      } else if (tab === 'video') {
                        tabVideo.classList.add('active');
                        videoUpload.style.display = 'block';
                        contentTypeInput.value = 'video';
                      } else if (tab === 'quiz') {
                        tabQuiz.classList.add('active');
                        quizUpload.style.display = 'block';
                        contentTypeInput.value = 'quiz';
                      }
                      // Hide video preview if not video
                      if (tab !== 'video' && videoPreview) {
                        videoPreview.innerHTML = '';
                        videoPreview.style.display = 'none';
                        if (youtubeUrl) youtubeUrl.value = '';
                      }
                    }
                    tabSlides.addEventListener('click', function(e) { e.preventDefault(); showTab('slide'); });
                    tabVideo.addEventListener('click', function(e) { e.preventDefault(); showTab('video'); });
                    tabQuiz.addEventListener('click', function(e) { e.preventDefault(); showTab('quiz'); });
                    // Default tab
                    showTab('slide');
                    // Live YouTube preview
                     if (youtubeUrl) {
                       youtubeUrl.addEventListener('input', function() {
                        const url = youtubeUrl.value.trim();
                        let videoId = null;
                        if (url === '') {
                          videoPreview.innerHTML = '';
                          videoPreview.style.display = 'none';
                          return;
                        }
                        if (url.includes('youtube.com/watch?v=')) {
                          videoId = url.split('v=')[1].split('&')[0];
                        } else if (url.includes('youtu.be/')) {
                          videoId = url.split('youtu.be/')[1].split('?')[0];
                        }
                        if (videoId) {
                          videoPreview.innerHTML = `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                          videoPreview.style.display = 'block';
                        } else {
                          videoPreview.innerHTML = '';
                          videoPreview.style.display = 'none';
                        }
                      });
                    }
                    // Client-side validation before submit
                    contentForm.addEventListener('submit', function(e) {
                      let valid = true;
                      const moduleSelect = document.getElementById('moduleSelect');
                      if (!moduleSelect.value) {
                        moduleSelect.classList.add('is-invalid');
                        valid = false;
                      } else {
                        moduleSelect.classList.remove('is-invalid');
                      }
                      if (contentTypeInput.value === 'slide') {
                        const slideFile = document.getElementById('slideFileInput');
                        if (!slideFile.files.length) {
                          slideFile.classList.add('is-invalid');
                          valid = false;
                        } else {
                          slideFile.classList.remove('is-invalid');
                        }
                      } else if (contentTypeInput.value === 'video') {
                        if (!youtubeUrl.value.trim()) {
                          youtubeUrl.classList.add('is-invalid');
                          valid = false;
                        } else {
                          youtubeUrl.classList.remove('is-invalid');
                        }
                      } else if (contentTypeInput.value === 'quiz') {
                        // Validate visible quiz panels
                        const panels = document.querySelectorAll('#modalQuizAccordion .quiz-panel');
                        let visibleCount = 0;
                        panels.forEach(p => { if (p.style.display !== 'none') visibleCount++; });
                        for (let i = 1; i <= visibleCount; i++) {
                          const q = document.querySelector(`input[name=quiz_question_${i}]`);
                          if (!q || !q.value.trim()) { q && q.classList.add('is-invalid'); valid = false; }
                          for (let a = 1; a <= 2; a++) { // require at least two answers
                            const ans = document.querySelector(`input[name=answer_${i}_${a}]`);
                            if (!ans || !ans.value.trim()) { ans && ans.classList.add('is-invalid'); valid = false; }
                          }
                        }
                      }
                      if (!valid) {
                        e.preventDefault();
                      }
                    });
                    // Quiz panel count control logic
                    const qDecr = document.getElementById('qcount-decr');
                    const qIncr = document.getElementById('qcount-incr');
                    const qInput = document.getElementById('qcount-input');
                    const quizPanels = Array.from(document.querySelectorAll('#modalQuizAccordion .quiz-panel'));
                    function showQuizCount(n) {
                      n = Math.max(1, Math.min(5, parseInt(n,10)||1));
                      quizPanels.forEach((p, idx) => {
                        p.style.display = (idx < n) ? '' : 'none';
                      });
                      if (qInput) qInput.value = n;
                    }
                    qDecr && qDecr.addEventListener('click', ()=> showQuizCount(Math.max(1, parseInt(qInput.value||'1',10)-1)));
                    qIncr && qIncr.addEventListener('click', ()=> showQuizCount(Math.min(5, parseInt(qInput.value||'1',10)+1)));
                    qInput && qInput.addEventListener('input', (e)=>{ clearTimeout(window._mv_qt); window._mv_qt = setTimeout(()=> showQuizCount(e.target.value), 300); });
                    qInput && qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); showQuizCount(qInput.value); } });
                    // Initialize panels to 1 visible
                    showQuizCount(1);
                   });
                 </script>

                <!-- User Quiz Tab/Section -->
                <div id="user-quiz-section" class="card mt-4">
                  <div class="card-header">
                    <h5><i class="fas fa-question-circle"></i> Knowledge Check</h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-4 text-center" style="border:2px dashed #ccc; min-height:190px; display:flex; align-items:center; justify-content:center; background:#f8f9fa;">
                        {% if module.quiz_image %}
                            <img src="{{ url_for('static', filename='uploads/' ~ module.quiz_image) }}" alt="Quiz Image" class="img-fluid rounded" style="max-height:180px;">
                        {% else %}
                            <span style="color:#888; font-size:1.2em;">No quiz image set for this module.</span>
                        {% endif %}
                    </div>
                    <div id="quiz-form-container">
                      <p>Loading quiz...</p>
                    </div>
                  </div>
                </div>
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const quizFormContainer = document.getElementById('quiz-form-container');
                  const moduleId = {{ module.module_id|tojson }};
                  let cachedQuiz = null;
                  let isReattempt = false;

                  function renderQuiz(quiz){
                    let html = '<form id="user-quiz-form">';
                    quiz.forEach((q, idx) => {
                      html += `<div class='mb-3'><label class='form-label'><b>Q${idx+1}:</b> ${q.text}</label>`;
                      q.answers.forEach((a, aIdx) => {
                        html += `<div class='form-check'><input class='form-check-input' type='radio' name='q${idx}' id='q${idx}a${aIdx}' value='${aIdx}' required><label class='form-check-label' for='q${idx}a${aIdx}'>${a.text}</label></div>`;
                      });
                      html += '</div>';
                    });
                    html += '<button type="submit" class="btn btn-success">' + (isReattempt ? 'Submit Reattempt' : 'Submit Quiz') + '</button>';
                    if(!isReattempt){
                      html += ' <button type="button" class="btn btn-outline-secondary" id="reattempt-btn" style="display:none;">Reattempt</button>';
                    }
                    quizFormContainer.innerHTML = html;
                    const formEl = document.getElementById('user-quiz-form');
                    formEl.addEventListener('submit', submitHandler);
                  }

                  function submitHandler(e){
                    e.preventDefault();
                    const answers = cachedQuiz.map((q, idx) => parseInt(new FormData(e.target).get(`q${idx}`), 10));
                    fetch(`/api/submit_quiz/${moduleId}`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ answers, is_reattempt: isReattempt })
                    })
                    .then(res => res.json())
                    .then(result => {
                      let feedback = `<div class='alert alert-info'><b>Your Score:</b> ${result.score || 0}%<br>${result.feedback || ''}<br><b>Grade:</b> ${result.grade_letter || 'A'} (Attempts: ${result.reattempt_count || 0})</div>`;
                      feedback += `<button class='btn btn-warning' id='start-reattempt'>Reattempt Quiz</button>`;
                      quizFormContainer.innerHTML = feedback;
                      const btn = document.getElementById('start-reattempt');
                      if(btn){
                        btn.addEventListener('click', function(){
                          isReattempt = true;
                          renderQuiz(cachedQuiz);
                        });
                      }
                    })
                    .catch(() => {
                      quizFormContainer.innerHTML = '<div class="alert alert-danger">Error submitting quiz. Please try again.</div>';
                    });
                  }

                  fetch(`/api/load_quiz/${moduleId}`)
                    .then(res => res.json())
                    .then(payload => {
                      const quiz = Array.isArray(payload) ? payload : (Array.isArray(payload.quiz) ? payload.quiz : []);
                      if (!quiz || !Array.isArray(quiz) || quiz.length === 0) {
                        quizFormContainer.innerHTML = '<div class="alert alert-info">No quiz available for this module.</div>';
                        return;
                      }
                      cachedQuiz = quiz;
                      renderQuiz(quiz);
                    })
                    .catch(() => {
                      quizFormContainer.innerHTML = '<div class="alert alert-danger">Failed to load quiz.</div>';
                    });
                });
                </script>

                <!-- Slide View Section -->
                {% if module.slide_url %}
                <div class="mb-4">
                    <h5>Module Slide</h5>
                    <a href="/static/uploads/{{ module.slide_url }}" target="_blank" class="btn btn-primary mb-2">
                        <i class="fas fa-expand"></i> View Slide Full Screen
                    </a>
                    <div>
                        <span class="text-muted">(Opens in a new tab. Use your browser's full screen for best experience.)</span>
                    </div>
                </div>
                {% endif %}
                <!-- End Slide View Section -->
            </div>
        </div>
    </div>
</div>
{% endblock %}
