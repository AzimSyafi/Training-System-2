{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="mb-3">
            <a href="{{ url_for('courses') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Courses
            </a>
        </div>
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-book"></i> {{ module.module_name }}</h3>
                <p class="text-muted">{{ module.module_type }} - {{ module.series_number }}</p>
            </div>
            <div class="card-body">
                <!-- Module Content -->
                <div class="mb-4">
                    <h5>Module Content</h5>
                    {% set video_id = module.content | youtube_id %}
                    {% if video_id %}
                        <div class="ratio ratio-16x9">
                            <iframe src="https://www.youtube.com/embed/{{ video_id }}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    {% else %}
                        <div class="border p-3 bg-light">
                            {{ module.content|safe }}
                        </div>
                    {% endif %}
                </div>

                <!-- Module Status -->
                {% if user_module.is_completed %}
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle"></i> Module Completed!</h5>
                        <p>Your Score:
                            <span class="{% if user_module.score <= 50 %}score-red{% elif user_module.score > 75 %}score-green{% else %}score-blue{% endif %}">
                                {{ user_module.score }}%
                            </span>
                        </p>
                        <p>Completed on: {{ user_module.completion_date.strftime('%B %d, %Y at %I:%M %p') if user_module.completion_date else 'N/A' }}</p>
                    </div>
                {% else %}
                    <!-- Assessment Section -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5><i class="fas fa-tasks"></i> Module Assessment</h5>
                        </div>
                        <div class="card-body">
                            <p>Complete this assessment to finish the module and receive your score.</p>
                            <form method="POST" action="{{ url_for('complete_module', module_id=module.module_id) }}">
                                <div class="mb-3">
                                    <label for="score" class="form-label">Assessment Score (%)</label>
                                    <input type="number" class="form-control" id="score" name="score" min="0" max="100" required>
                                    <div class="form-text">
                                        <strong>Scoring Guidelines:</strong><br>
                                        <span class="score-red">â‰¤ 50%: Needs Improvement (Red)</span><br>
                                        <span class="score-blue">51-75%: Satisfactory (Blue)</span><br>
                                        <span class="score-green">> 75%: Excellent (Green)</span>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check"></i> Complete Module
                                </button>
                            </form>
                        </div>
                    </div>
                {% endif %}

                <!-- Module Details -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h6>Module Information</h6>
                        <ul class="list-group">
                            <li class="list-group-item">
                                <strong>Type:</strong> {{ module.module_type }}
                            </li>
                            <li class="list-group-item">
                                <strong>Series:</strong> {{ module.series_number }}
                            </li>
                            <li class="list-group-item">
                                <strong>Rating:</strong>
                                {% for i in range(1, 6) %}
                                    {% if i <= module.star_rating %}
                                        <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                        <i class="far fa-star text-muted"></i>
                                    {% endif %}
                                {% endfor %}
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Add Content Button -->
                <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#uploadContentModal">
                    <i class="fas fa-upload"></i> Add/Upload Content
                </button>

                <!-- Upload Content Modal (rewritten for module selection and content type tabs) -->
                <div class="modal fade" id="uploadContentModal" tabindex="-1" aria-labelledby="uploadContentModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="uploadContentModalLabel"><i class="fas fa-upload"></i> Upload Content to Module</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <form method="POST" action="{{ url_for('upload_content') }}" enctype="multipart/form-data" id="contentForm">
                          <div class="form-group mb-3">
                            <label for="moduleSelect" class="form-label">Select Module</label>
                            <select class="form-select" id="moduleSelect" name="module_id" required>
                              <option value="" disabled selected>Select a module</option>
                              {% for m in modules %}
                                <option value="{{ m.id }}">{{ m.module_name }}</option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="form-group mb-3">
                            <label class="form-label">Content Type</label>
                            <div class="btn-group w-100 mb-2" role="group" aria-label="Content type tabs">
                              <button type="button" class="btn btn-outline-primary active" id="tabSlides">Slides</button>
                              <button type="button" class="btn btn-outline-primary" id="tabVideo">Video</button>
                              <button type="button" class="btn btn-outline-primary" id="tabQuiz">Quiz</button>
                            </div>
                            <input type="hidden" name="content_type" id="contentType" value="slide">
                          </div>
                          <div class="form-group mb-3" id="slideUpload" style="display:block;">
                            <label class="form-label">Upload Slide (PDF or PPTX)</label>
                            <input type="file" name="slide_file" accept=".pdf,.pptx" class="form-control" id="slideFileInput">
                          </div>
                          <div class="form-group mb-3" id="videoUpload" style="display:none;">
                            <label class="form-label">YouTube Video URL</label>
                            <input type="url" name="youtube_url" id="youtubeUrl" class="form-control" placeholder="Paste YouTube video link here">
                            <small class="form-text text-muted">Provide a YouTube link to embed a video for this module.</small>
                            <div id="videoPreview" class="mt-2" style="display:none;"></div>
                          </div>
                          <div class="form-group mb-3" id="quizUpload" style="display:none;">
                            <label class="form-label">Quiz Question</label>
                            <input type="text" name="quiz_question" class="form-control" placeholder="Enter quiz question" id="quizQuestionInput">
                            <label class="form-label mt-2">Answer 1</label>
                            <input type="text" name="quiz_answer1" class="form-control" placeholder="Enter answer 1" id="quizAnswer1Input">
                            <label class="form-label mt-2">Answer 2</label>
                            <input type="text" name="quiz_answer2" class="form-control" placeholder="Enter answer 2" id="quizAnswer2Input">
                            <label class="form-label mt-2">Answer 3</label>
                            <input type="text" name="quiz_answer3" class="form-control" placeholder="Enter answer 3" id="quizAnswer3Input">
                          </div>
                          <div class="form-group mt-4">
                            <button type="submit" class="btn btn-primary w-100">
                              <i class="fas fa-save"></i> Save Content
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
                <script>
                  document.addEventListener('DOMContentLoaded', function() {
                    const tabSlides = document.getElementById('tabSlides');
                    const tabVideo = document.getElementById('tabVideo');
                    const tabQuiz = document.getElementById('tabQuiz');
                    const slideUpload = document.getElementById('slideUpload');
                    const videoUpload = document.getElementById('videoUpload');
                    const quizUpload = document.getElementById('quizUpload');
                    const youtubeUrl = document.getElementById('youtubeUrl');
                    const videoPreview = document.getElementById('videoPreview');
                    const contentTypeInput = document.getElementById('contentType');
                    const contentForm = document.getElementById('contentForm');
                    // Tab logic
                    function showTab(tab) {
                      tabSlides.classList.remove('active');
                      tabVideo.classList.remove('active');
                      tabQuiz.classList.remove('active');
                      slideUpload.style.display = 'none';
                      videoUpload.style.display = 'none';
                      quizUpload.style.display = 'none';
                      if (tab === 'slide') {
                        tabSlides.classList.add('active');
                        slideUpload.style.display = 'block';
                        contentTypeInput.value = 'slide';
                      } else if (tab === 'video') {
                        tabVideo.classList.add('active');
                        videoUpload.style.display = 'block';
                        contentTypeInput.value = 'video';
                      } else if (tab === 'quiz') {
                        tabQuiz.classList.add('active');
                        quizUpload.style.display = 'block';
                        contentTypeInput.value = 'quiz';
                      }
                      // Hide video preview if not video
                      if (tab !== 'video' && videoPreview) {
                        videoPreview.innerHTML = '';
                        videoPreview.style.display = 'none';
                        if (youtubeUrl) youtubeUrl.value = '';
                      }
                    }
                    tabSlides.addEventListener('click', function(e) { e.preventDefault(); showTab('slide'); });
                    tabVideo.addEventListener('click', function(e) { e.preventDefault(); showTab('video'); });
                    tabQuiz.addEventListener('click', function(e) { e.preventDefault(); showTab('quiz'); });
                    // Default tab
                    showTab('slide');
                    // Live YouTube preview
                    if (youtubeUrl) {
                      youtubeUrl.addEventListener('input', function() {
                        const url = youtubeUrl.value.trim();
                        let videoId = null;
                        if (url === '') {
                          videoPreview.innerHTML = '';
                          videoPreview.style.display = 'none';
                          return;
                        }
                        if (url.includes('youtube.com/watch?v=')) {
                          videoId = url.split('v=')[1].split('&')[0];
                        } else if (url.includes('youtu.be/')) {
                          videoId = url.split('youtu.be/')[1].split('?')[0];
                        }
                        if (videoId) {
                          videoPreview.innerHTML = `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                          videoPreview.style.display = 'block';
                        } else {
                          videoPreview.innerHTML = '';
                          videoPreview.style.display = 'none';
                        }
                      });
                    }
                    // Client-side validation before submit
                    contentForm.addEventListener('submit', function(e) {
                      let valid = true;
                      const moduleSelect = document.getElementById('moduleSelect');
                      if (!moduleSelect.value) {
                        moduleSelect.classList.add('is-invalid');
                        valid = false;
                      } else {
                        moduleSelect.classList.remove('is-invalid');
                      }
                      if (contentTypeInput.value === 'slide') {
                        const slideFile = document.getElementById('slideFileInput');
                        if (!slideFile.files.length) {
                          slideFile.classList.add('is-invalid');
                          valid = false;
                        } else {
                          slideFile.classList.remove('is-invalid');
                        }
                      } else if (contentTypeInput.value === 'video') {
                        if (!youtubeUrl.value.trim()) {
                          youtubeUrl.classList.add('is-invalid');
                          valid = false;
                        } else {
                          youtubeUrl.classList.remove('is-invalid');
                        }
                      } else if (contentTypeInput.value === 'quiz') {
                        const q = document.getElementById('quizQuestionInput');
                        const a1 = document.getElementById('quizAnswer1Input');
                        const a2 = document.getElementById('quizAnswer2Input');
                        const a3 = document.getElementById('quizAnswer3Input');
                        [q, a1, a2, a3].forEach(function(input) {
                          if (!input.value.trim()) {
                            input.classList.add('is-invalid');
                            valid = false;
                          } else {
                            input.classList.remove('is-invalid');
                          }
                        });
                      }
                      if (!valid) {
                        e.preventDefault();
                      }
                    });
                  });
                </script>

                <!-- User Quiz Tab/Section -->
                <div id="user-quiz-section" class="card mt-4">
                  <div class="card-header">
                    <h5><i class="fas fa-question-circle"></i> Knowledge Check</h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-4 text-center" style="border:2px dashed #ccc; min-height:190px; display:flex; align-items:center; justify-content:center; background:#f8f9fa;">
                        {% if module.quiz_image %}
                            <img src="{{ url_for('static', filename='uploads/' ~ module.quiz_image) }}" alt="Quiz Image" class="img-fluid rounded" style="max-height:180px;">
                        {% else %}
                            <span style="color:#888; font-size:1.2em;">No quiz image set for this module.</span>
                        {% endif %}
                    </div>
                    <div id="quiz-form-container">
                      <p>Loading quiz...</p>
                    </div>
                  </div>
                </div>
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const quizFormContainer = document.getElementById('quiz-form-container');
                  const moduleId = {{ module.module_id|tojson }};
                  let cachedQuiz = null;
                  let isReattempt = false;

                  function renderQuiz(quiz){
                    let html = '<form id="user-quiz-form">';
                    quiz.forEach((q, idx) => {
                      html += `<div class='mb-3'><label class='form-label'><b>Q${idx+1}:</b> ${q.text}</label>`;
                      q.answers.forEach((a, aIdx) => {
                        html += `<div class='form-check'><input class='form-check-input' type='radio' name='q${idx}' id='q${idx}a${aIdx}' value='${aIdx}' required><label class='form-check-label' for='q${idx}a${aIdx}'>${a.text}</label></div>`;
                      });
                      html += '</div>';
                    });
                    html += '<button type="submit" class="btn btn-success">' + (isReattempt ? 'Submit Reattempt' : 'Submit Quiz') + '</button>';
                    if(!isReattempt){
                      html += ' <button type="button" class="btn btn-outline-secondary" id="reattempt-btn" style="display:none;">Reattempt</button>';
                    }
                    quizFormContainer.innerHTML = html;
                    const formEl = document.getElementById('user-quiz-form');
                    formEl.addEventListener('submit', submitHandler);
                  }

                  function submitHandler(e){
                    e.preventDefault();
                    const answers = cachedQuiz.map((q, idx) => parseInt(new FormData(e.target).get(`q${idx}`), 10));
                    fetch(`/api/submit_quiz/${moduleId}`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ answers, is_reattempt: isReattempt })
                    })
                    .then(res => res.json())
                    .then(result => {
                      let feedback = `<div class='alert alert-info'><b>Your Score:</b> ${result.score || 0}%<br>${result.feedback || ''}<br><b>Grade:</b> ${result.grade_letter || 'A'} (Attempts: ${result.reattempt_count || 0})</div>`;
                      feedback += `<button class='btn btn-warning' id='start-reattempt'>Reattempt Quiz</button>`;
                      quizFormContainer.innerHTML = feedback;
                      const btn = document.getElementById('start-reattempt');
                      if(btn){
                        btn.addEventListener('click', function(){
                          isReattempt = true;
                          renderQuiz(cachedQuiz);
                        });
                      }
                    })
                    .catch(() => {
                      quizFormContainer.innerHTML = '<div class="alert alert-danger">Error submitting quiz. Please try again.</div>';
                    });
                  }

                  fetch(`/api/load_quiz/${moduleId}`)
                    .then(res => res.json())
                    .then(quiz => {
                      if (!quiz || !Array.isArray(quiz) || quiz.length === 0) {
                        quizFormContainer.innerHTML = '<div class="alert alert-info">No quiz available for this module.</div>';
                        return;
                      }
                      cachedQuiz = quiz;
                      renderQuiz(quiz);
                    })
                    .catch(() => {
                      quizFormContainer.innerHTML = '<div class="alert alert-danger">Failed to load quiz.</div>';
                    });
                });
                </script>

                <!-- Slide View Section -->
                {% if module.slide_url %}
                <div class="mb-4">
                    <h5>Module Slide</h5>
                    <a href="/static/uploads/{{ module.slide_url }}" target="_blank" class="btn btn-primary mb-2">
                        <i class="fas fa-expand"></i> View Slide Full Screen
                    </a>
                    <div>
                        <span class="text-muted">(Opens in a new tab. Use your browser's full screen for best experience.)</span>
                    </div>
                </div>
                {% endif %}
                <!-- End Slide View Section -->
            </div>
        </div>
    </div>
</div>
{% endblock %}
